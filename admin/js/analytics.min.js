!function(e){"use strict";NelioContent.collections.TopPosts=NelioContent.collections.Collection.extend({_isLoading:!1,model:NelioContent.models.Post,filters:!1,initialize:function(e,t){this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset),this.filters={post:"all",authorId:0,metric:"engagement",date:{from:"",to:"",mode:"all"}},NelioContent.analytics.gaViewId&&(this.filters.metric="pageviews")},load:function(){this._isLoading=!0,this.trigger("nc:change:isLoading");var t={action:"nelio_content_get_top_posts"};this.filters.authorId>0&&(t.author=this.filters.authorId),t.metric=this.filters.metric,"all"!==this.filters.post&&(isNaN(parseInt(this.filters.post))?t.postType=this.filters.post:t.category=this.filters.post),"undefined"!=typeof this.filters.date.from&&(t.from=this.filters.date.from,t.to=this.filters.date.to);var i=this;e.ajax({url:ajaxurl,data:t,success:function(e){"undefined"!=typeof e.items&&(i._isLoading=!1,i.reset(e.items))},error:function(e){i.trigger("nc:error",e.responseJSON),i._isLoading=!1,i.trigger("nc:change:isLoading")}})},isLoading:function(){return this._isLoading},applyCurrentFilters:function(){NelioContent.helpers.removeParamFromUrl(["type","category"]),"all"!==this.filters.post&&(isNaN(parseInt(this.filters.post))?NelioContent.helpers.addParamInUrl("type",this.filters.post):NelioContent.helpers.addParamInUrl("category",this.filters.post)),NelioContent.helpers.removeParamFromUrl(["publication","from","to"]),"all"!==this.filters.date.mode&&NelioContent.helpers.addParamInUrl("publication",this.filters.date.mode),"custom"===this.filters.date.mode&&NelioContent.helpers.isDate(this.filters.date.from)&&NelioContent.helpers.addParamInUrl("from",this.filters.date.from),"custom"===this.filters.date.mode&&NelioContent.helpers.isDate(this.filters.date.to)&&NelioContent.helpers.addParamInUrl("to",this.filters.date.to),this.reset(),this.load()},canBeFiltered:function(){return"undefined"!=typeof this.filters&&("undefined"!=typeof this.filters.post&&("undefined"!=typeof this.filters.authorId&&("undefined"!=typeof this.filters.metric&&(!("all"!==this.filters.date.mode&&!NelioContent.helpers.isDate(this.filters.date.from))&&!("all"!==this.filters.date.mode&&!NelioContent.helpers.isDate(this.filters.date.to))))))},applyFiltersInURL:function(){this.setMetricSorter(NelioContent.helpers.getParamFromUrl("metric")),this.setPostFilter(NelioContent.helpers.getParamFromUrl("type")||NelioContent.helpers.getParamFromUrl("category"));var e=NelioContent.helpers.getParamFromUrl("publication"),t=NelioContent.helpers.getParamFromUrl("from")||"",i=NelioContent.helpers.getParamFromUrl("to")||"";"custom"===e&&(NelioContent.helpers.isDate(t)&&NelioContent.helpers.isDate(i)||(e="all")),this.setDateFilter(e),"custom"===e&&(this.setFromDate(t),this.setToDate(i))},setPostFilter:function(e){"undefined"==typeof e&&(e="all"),this.filters.post=e},setDateFilter:function(e){"undefined"==typeof e&&(e="all"),this.filters.date=NelioContent.helpers.getTimeInterval(e)},setFromDate:function(e){NelioContent.helpers.isDate(e)&&(this.filters.date.from=e)},setToDate:function(e){NelioContent.helpers.isDate(e)&&(this.filters.date.to=e)},setAuthorFilter:function(e){"undefined"==typeof e&&(e="all"),this.filters.authorId=e},switchSortMetric:function(){"pageviews"===this.filters.metric?this.setMetricSorter("engagement"):this.setMetricSorter("pageviews"),this.applyCurrentFilters()},setMetricSorter:function(e){"undefined"!=typeof e&&(this.filters.metric=e,NelioContent.helpers.addParamInUrl("metric",e))},_loadSocialQueueCount:function(t){var i=this;e.ajax({url:NelioContent.apiUri+"/post/messages/count",method:"POST",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},data:JSON.stringify({postIds:t}),success:function(e){_.each(e,function(e){var t=i.get(e.id);"undefined"!=typeof t&&t.set({socialQueueError:!1,publishCount:e.publish,scheduleCount:e.schedule})})},error:function(){i.each(function(e){e.set({socialQueueError:NelioContent.i18n.errors.api.emptyAjaxStatus,publishCount:0,scheduleCount:0})}),i.trigger("nc:load:error")}})},_triggerModelChange:function(e){this.trigger("nc:change:model",this,e)},_onAdd:function(e){this.listenTo(e,"change",this._triggerModelChange),this.listenTo(e,"destroy",this.remove)},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this),this._loadSocialQueueCount(_.pluck(e.toJSON(),"id"))}}),NelioContent.views.DateFilter=Backbone.View.extend({_isLocked:!1,_mode:!1,_oldMode:!1,_areDatePickersReady:!1,templates:{selector:_.template(NelioContent.helpers.trim(document.getElementById("_nc-date-filter").innerHTML)),range:_.template(NelioContent.helpers.trim(document.getElementById("_nc-date-range").innerHTML))},events:{"change .nc-publication-date-selector":"_changeDateMode","keyup  input.nc-value-from":"_changeFromDate","keyup  input.nc-value-to":"_changeToDate","change  input.nc-value-from":"_changeFromDate","change  input.nc-value-to":"_changeToDate","click  .nc-change-mode":"_showDefaultSelector"},initialize:function(e){this._mode="all",this._oldMode="all","object"==typeof e&&"undefined"!=typeof e.publication&&(this._mode=e.publication),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render)},render:function(){var e=this.$(".nc-value-from"),t=this.$(".nc-value-to");"date"!==e.prop("type")&&(t.datepicker("destroy"),e.datepicker("destroy"),this._areDatePickersReady=!1);var i=this.$(".nc-publication-date-selector");return i.ncselect2("destroy"),"custom"===this._mode?this.el.innerHTML=this.templates.range({from:NelioContent.helpers.getParamFromUrl("from")||"",to:NelioContent.helpers.getParamFromUrl("to")||"",today:moment().format("YYYY-MM-DD")}):(this.el.innerHTML=this.templates.selector(),this.$('.nc-publication-date-selector option[value="'+this._mode+'"]').attr("selected","selected"),"all"===this._mode&&NelioContent.helpers.removeParamFromUrl(["publication","from","to"]),this.$(".nc-publication-date-selector").ncselect2({minimumResultsForSearch:1/0,width:"15em"})),this._maybeInitDatePickers(),this},lock:function(){this._isLocked=!0,this.$("input").prop("disabled",!0),this.$("select").prop("disabled",!0)},_maybeInitDatePickers:function(){var e=this.$(".nc-value-from"),t=this.$(".nc-value-to");this._areDatePickersReady||"date"===e.prop("type")||(e.datepicker({dateFormat:"yy-mm-dd",maxDate:moment().format("YYYY-MM-DD")}),t.datepicker({dateFormat:"yy-mm-dd",maxDate:moment().format("YYYY-MM-DD")})),this._areDatePickersReady=!0},_changeDateMode:function(t){if(!this._isLocked){var i=t.target||t.srcElement,s=e(i),o=NelioContent.helpers.trim(s.val());this._oldMode=this._mode,this._mode=o,this.trigger("nc:change",this._mode),this.trigger("nc:render")}},_showDefaultSelector:function(e){this._mode=this._oldMode,this.trigger("nc:change",this._mode),this.trigger("nc:render")},_changeFromDate:function(t){var i=t.target||t.srcElement,s=e(i),o=NelioContent.helpers.trim(s.val());if(NelioContent.helpers.isDate(o)){var n=e(".nc-value-to");NelioContent.helpers.isDate(n.val())?ncNewLocalMoment(n.val()).isBefore(ncNewLocalMoment(o))&&n.val(o):n.val(o),"date"===n.attr("type")?n.prop("min",o):n.datepicker("option","minDate",o),this.trigger("nc:change:from",o)}},_changeToDate:function(t){var i=t.target||t.srcElement,s=e(i),o=NelioContent.helpers.trim(s.val());NelioContent.helpers.isDate(o)&&this.trigger("nc:change:to",o)},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.UserSelector=Backbone.View.extend({_userOptionTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_nc-user-selector-option").innerHTML)),_selectedUserTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_nc-user-selector-selected-option").innerHTML)),_rendered:!1,_defaultValue:void 0,_single:!1,_$select:void 0,_dropdownCssClass:"nc-ncselect2-above-jquery-dialog",_width:"100%",events:{"change .nc-user-selector":"_onUserChange"},initialize:function(e){"undefined"==typeof e&&(e={}),"undefined"!=typeof e.defaultValue&&(this._defaultValue=e.defaultValue),"boolean"==typeof e.single&&(this._single=e.single),"object"==typeof e.$select?this._$select=e.$select:this._$select=jQuery('<select class="nc-user-selector"></select>'),"string"==typeof e.dropdownCssClass&&(this._dropdownCssClass=e.dropdownCssClass),"string"==typeof e.width&&(this._width=e.width),this.render=_.bind(this.render,this),this._getAjaxData=_.bind(this._getAjaxData,this),this._processResults=_.bind(this._processResults,this),this._templateResult=_.bind(this._templateResult,this),this._templateSelection=_.bind(this._templateSelection,this)},render:function(){if(this._rendered)return this;this._rendered=!0;var e=[];if("number"==typeof this._defaultValue){var t=NelioContent.users.getUser(this._defaultValue);t.valid()&&(e=[t.toJSON()])}var i=this;return this.$el.html(this._$select),this._$select.ncselect2({data:e,dropdownCssClass:this._dropdownCssClass,width:this._width,templateResult:i._templateResult,templateSelection:i._templateSelection,ajax:{url:ajaxurl,cache:!1,dataType:"json",delay:250,data:i._getAjaxData,processResults:i._processResults}}),this.setValue(this._defaultValue),this._single&&this._$select.prop("disabled",!0),this},setValue:function(e){function t(){var t=i._$select.val();if("number"!=typeof t||e===i._$select.val()){var s=NelioContent.users.getUser(e),o=s.get("id"),n=i._templateSelection(s.toJSON());i.undelegateEvents(),i._$select.empty().append('<option value="'+o+'">'+n+"</option>").trigger("change"),i.delegateEvents()}}if(!this._rendered)return void(this._defaultValue=e);if("number"==typeof e){var i=this;this._$select.val(e),this.trigger("nc:change",e);var s=NelioContent.users.getUser(e);s.isLoading()?this.listenToOnce(s,"nc:load",t):t()}},lock:function(){this._$select.prop("disabled",!0)},unlock:function(){this._$select.prop("disabled",!1)},_getAjaxData:function(e){var t={action:"nelio_content_get_authors",term:e.term,page:e.page};return t},_processResults:function(e,t){t.page=t.page||1;for(var i=0;i<e.items.length;++i)NelioContent.users.add(e.items[i]),e.items[i]=NelioContent.users.get(e.items[i].id).toJSON();return{results:e.items,pagination:{more:e.more}}},_templateResult:function(t){return"undefined"==typeof t.name?t.text:e(this._userOptionTemplate(t))},_templateSelection:function(t){return t=NelioContent.users.getUser(t.id).toJSON(),e(this._selectedUserTemplate(t))},_onUserChange:function(t){var i=t.target||t.srcElement,s=e(i),o=NelioContent.helpers.trim(s.val());o=isNaN(parseInt(o))?o:parseInt(o),this.trigger("nc:change",o)},close:function(){this._rendered&&this._$select.ncselect2("destroy"),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.UserFilter=NelioContent.views.UserSelector.extend({_actions:!1,_labels:!1,initialize:function(e){"undefined"==typeof e.defaultValue&&(e.defaultValue="all"),NelioContent.views.UserSelector.prototype.initialize.call(this,e),this._actions=jQuery.extend({},{all:!0,none:!1},e.actions),this._labels=jQuery.extend({},{group:!1,all:!1,none:!1,single:!1},e.labels),this._getAjaxData=_.bind(this._getAjaxData,this),this._processResults=_.bind(this._processResults,this),this._templateResult=_.bind(this._templateResult,this),this._templateSelection=_.bind(this._templateSelection,this)},render:function(){return this._rendered?this:(NelioContent.views.UserSelector.prototype.render.call(this),"all"===this._defaultValue?(this._$select.val("all"),this._$select.empty().append('<option value="all">'+_.escape(this._labels.all)+"</option>").trigger("change")):"none"===this._defaultValue&&(this._$select.val("none"),this._$select.empty().append('<option value="none">'+_.escape(this._labels.none)+"</option>").trigger("change")),this)},_getAjaxData:function(e){var t={action:"nelio_content_get_authors",term:e.term,page:e.page};return t},_processResults:function(e,t){var i=NelioContent.views.UserSelector.prototype._processResults.call(this,e,t);return this._labels.group&&1===t.page&&i.results.length&&i.results.unshift({text:this._labels.group,children:[]}),t.term=t.term||"",1!==t.page||t.term.length||(this._actions.none&&i.results.unshift({id:"none"}),this._actions.all&&i.results.unshift({id:"all"})),i},_templateResult:function(e){return"all"===e.id?this._actions.all:"none"===e.id?this._actions.none:NelioContent.views.UserSelector.prototype._templateResult.call(this,e)},_templateSelection:function(t){if("all"===t.id)return this._labels.all;if("none"===t.id){var i='<span class="nc-dashicons nc-dashicons-hidden"></span> ';return e("<span>"+i+this._labels.none+"</span>")}return this._labels.single?"string"==typeof t.name?this._labels.single.replace("%s",t.name):t.text:NelioContent.views.UserSelector.prototype._templateSelection.call(this,t)}}),NelioContent.views.TopPosts=Backbone.View.extend({_topPostViews:[],_authorFilterView:!1,_dateFilterView:!1,rendered:!1,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-top-posts").innerHTML)),events:{"change .nc-post-filter":"_onPostFilterChange","click .nc-new-metric":"_onMetricSorterChange","click .nc-apply-filters":"_applyFilters"},initialize:function(){"undefined"==typeof this.collection&&(this.collection=new NelioContent.collections.TopPosts),this.collection.each(function(e){var t=new NelioContent.views.TopPost({model:e});this._topPostViews.push(t)},this),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.collection,"add",this._addTopPost),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeTopPost),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetTopPostViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"nc:change:isLoading",this.render),this.listenTo(this.collection,"nc:error",this.render),this.listenTo(this.collection,"change:completed",this.render)},render:function(){var e;if(!this.rendered&&(this.rendered=!0,this.el.innerHTML=this.template(),1===NelioContent.postTypes.length&&"post"!==NelioContent.postTypes[0].name?this.$(".nc-post-filter").hide():(this.$(".nc-post-filter").val(this.collection.filters.post),NelioContent.helpers.buildPostFilter(this.$(".nc-post-filter"),"remove-none-option")),0<this.$(".nc-author-filter").length&&(this._authorFilterView=new NelioContent.views.UserFilter({el:this.$(".nc-author-filter"),dropdownCssClass:"nc-author-filter",width:"15em",actions:{all:NelioContent.i18n.filters.actions.showPosts,none:!1},labels:{group:NelioContent.i18n.filters.groups.author,all:NelioContent.i18n.filters.selection.allAuthors,single:NelioContent.i18n.filters.selection.postsBy}}),this._authorFilterView.render(),this.listenTo(this._authorFilterView,"nc:change",this._onAuthorFilterChange)),0<this.$(".nc-date-filter").length)){var t=NelioContent.helpers.getParamFromUrl("publication");this._dateFilterView=new NelioContent.views.DateFilter({el:this.$(".nc-date-filter"),publication:t}),this.listenTo(this._dateFilterView,"nc:change",this._onDateFilterChange),this.listenTo(this._dateFilterView,"nc:change:from",this._onFromDateFilterChange),this.listenTo(this._dateFilterView,"nc:change:to",this._onToDateFilterChange),this._dateFilterView.render()}return this.collection.isLoading()?(this.$("span.spinner").addClass("is-active"),this.$(".nc-post-filter").prop("disabled",!0),this.$(".nc-date-filter *").prop("disabled",!0),this.$(".nc-apply-filters").prop("disabled",!0),this._authorFilterView&&this._authorFilterView.lock()):(this.$("span.spinner").removeClass("is-active"),this.$(".nc-post-filter").prop("disabled",!1),this.$(".nc-date-filter *").prop("disabled",!1),this.$(".nc-apply-filters").prop("disabled",!1),this._authorFilterView&&this._authorFilterView.unlock(),this._checkFilterApplicability()),"pageviews"===this.collection.filters.metric?(this.$(".nc-current-metric").html(NelioContent.i18n.filters.sortedBy.pageviews),this.$(".nc-new-metric").html(NelioContent.i18n.filters.sortBy.engagement)):(this.$(".nc-current-metric").html(NelioContent.i18n.filters.sortedBy.engagement),this.$(".nc-new-metric").html(NelioContent.i18n.filters.sortBy.pageviews)),e=this.$(".nc-top-posts"),e.empty(),_.each(this._topPostViews,function(t){e.append(t.render().el)},this),this.collection.isLoading()||this.collection.length?this.$(".nc-top-posts-none").hide():this.$(".nc-top-posts-none").show(),this},addTopPost:function(e){var t=new NelioContent.views.TopPost({model:e});t.setIsBeingSaved(!0),this._topPostViews.push(t),this.stopListening(this.collection,"add",this._addTopPost),this.collection.add(e),this.listenTo(this.collection,"add",this._addTopPost)},_resetTopPostViews:function(){_.each(this._topPostViews,function(e){e.close()},this),this._topPostViews=[],this.collection.each(this._addTopPost,this)},_addTopPost:function(e){var t=new NelioContent.views.TopPost({model:e});this._topPostViews.push(t)},_removeTopPost:function(e){var t,i;i=_.filter(this._topPostViews,function(t){return t.model===e},this),i.length>0&&(t=i[0],this._topPostViews=_.without(this._topPostViews,t),t.close())},_onPostFilterChange:function(){var e=this.$(".nc-post-filter").val();isNaN(parseInt(e))?this.collection.setPostFilter(e):this.collection.setPostFilter(parseInt(e)),this._checkFilterApplicability()},_onAuthorFilterChange:function(e){isNaN(parseInt(e))?this.collection.setAuthorFilter(e):this.collection.setAuthorFilter(parseInt(e)),this._checkFilterApplicability()},_onDateFilterChange:function(e){this.collection.setDateFilter(e),this._checkFilterApplicability()},_onFromDateFilterChange:function(e){this.collection.setFromDate(e),this._checkFilterApplicability()},_onToDateFilterChange:function(e){this.collection.setToDate(e),this._checkFilterApplicability()},_onMetricSorterChange:function(e){e.preventDefault(),this.collection.isLoading()||this.collection.switchSortMetric()},_checkFilterApplicability:function(){this.collection.canBeFiltered()?this.$(".nc-apply-filters").prop("disabled",!1):this.$(".nc-apply-filters").prop("disabled",!0)},_applyFilters:function(){this.collection.applyCurrentFilters()},close:function(){_.each(this._topPostViews,function(e){e.close()},this),this._topPostViews=[],this._authorFilterView&&this._authorFilterView.close(),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.TopPost=Backbone.View.extend({template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-top-post").innerHTML)),events:{"click .nc-share button":"_addSocial"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:completed",this.render),this.listenTo(this.model,"change:scheduleCount",this.render),this.listenTo(this.model,"change:publishCount",this.render)},render:function(){this.$(".nc-help-with-html-tooltip").tooltip("destroy");var e=this.model.toJSON(),t=NelioContent.users.getUser(this.model.get("author"));return t.isLoading()&&this.listenToOnce(t,"nc:load",_.bind(function(){this.trigger("nc:render")},this)),e.photo=t.get("photo"),e.displayNameEscaped=_.escape(t.get("name")),e.firstLetter=t.get("firstLetter"),e.date=this.model.get("date").format(NelioContent.i18n.date["default"]),e.since=NelioContent.helpers.capitalizeFirstLetter(this.model.get("date").fromNow()),e.isSocialQueueReady="number"==typeof e.scheduleCount&&!e.socialQueueError,this.el.innerHTML=this.template(e),NelioContent.helpers.makeInfoTooltip(this.$(".nc-help-with-html-tooltip")),this},_addSocial:function(){if(0===NelioContent.profiles.length)return void this._openNoProfilesDialog();var e=new NelioContent.models.SocialMessage;e.set("profileId",NelioContent.profiles.at(0).get("id")),e.setPost(this.model),e.set("dateType","predefined-offset"),e.set("dateValue","0"),e.set("timeType","predefined-offset"),e.set("timeValue","0");var t=new NelioContent.views.SocialMessageEditor({model:e}),i=this;this.listenTo(t,"nc:add:messages",function(e){var t=i.model.get("scheduleCount")+e.length;i.model.set("scheduleCount",t)}),this.listenTo(t,"nc:close:dialog",function(){i.stopListening(t)}),t.render()},_openNoProfilesDialog:function(){var t=e("<div></div>").html(document.getElementById("_nc-no-profile-available").innerHTML);t.dialog({title:NelioContent.i18n.titles.addSocialProfiles,modal:!0,width:450,dialogClass:"nc-dialog",open:function(){t.find("a").blur()},buttons:[{text:NelioContent.i18n.actions.addSocialProfile,"class":"button button-primary",click:function(){document.location.href=NelioContent.pages.settings}}]})},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var t=new NelioContent.collections.TopPosts;t.applyFiltersInURL();var i=new NelioContent.views.TopPosts({el:e(".nc-analytics-page-container"),collection:t});i.collection.load()}(jQuery);