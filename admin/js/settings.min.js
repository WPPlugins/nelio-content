!function(e){"use strict";function t(){var t=e("#google-analytics-view-container");n.is(":checked")?(t.find("*").prop("disabled",!1),t.closest("tr").find("th, td").removeClass("nc-disabled-setting"),e(".nc-ga-setting-change-profile .nc-change").css("cursor","pointer"),e(".nc-ga-setting-change-profile .nc-change-wrapper").css("color","#666")):(t.find("*").prop("disabled",!0),t.closest("tr").find("th, td").addClass("nc-disabled-setting"),e(".nc-ga-setting-change-profile .nc-change").css("cursor","auto"),e(".nc-ga-setting-change-profile .nc-change-wrapper").css("color","inherit"))}if(!NelioContentSettings.isYoastSEOAvailable){var i=e("#qa-is-yoast-seo-integrated");i.prop("disabled",!0),i.closest("tr").find("th, td").addClass("nc-disabled-setting")}var n=e("#use-analytics");n.on("click",t),t();var o=window.location.href;if(/\btab=social-profiles\b/.test(o)||!/\btab=/.test(o)){NelioContent.views.ConnectedSocialProfile=Backbone.View.extend({_deletionStatus:"none",className:"nc-connected-profile",template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-connected-social-profile").innerHTML)),events:{mouseleave:"_cancelProfileDeletion","click .nc-delete":"_askForProfileDeletionConfirmation","click .nc-cancel-deletion":"_cancelProfileDeletion","click .nc-do-delete":"_deleteProfile","click .nc-reauthenticate":"_reauthenticateProfile","click .nc-refresh":"_reauthenticateProfile"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON();return e.deletionStatus=this._deletionStatus,e.addedByCurrentUser=this.model.get("creatorId")===NelioContent.users.current().get("id"),this.el.innerHTML=this.template(e),this.el.className=this.className,"renew"===this.model.get("status")&&(this.el.className+=" nc-authentication-required"),"deleting"===this._deletionStatus&&(this.el.className+=" nc-deleting"),this},_askForProfileDeletionConfirmation:function(){return this._deletionStatus="awaiting-confirmation",this.trigger("nc:render"),!1},_cancelProfileDeletion:function(){return"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render")),!1},_deleteProfile:function(e){return this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy(),!1},_reauthenticateProfile:function(t){var i=t.target||t.srcElement,n=e(i),o=n.data("href");return NelioContent.helpers.openPopup(o,640,480),!1},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SocialProfileSettings=Backbone.View.extend({_profileViews:[],_wasAbleToAccessAws:!0,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-social-profile-settings").innerHTML)),events:{"click .nc-network:not( .nc-disabled ) .nc-logo":"_addSocialProfile"},initialize:function(){this.collection=NelioContent.profiles,this.render=_.bind(this.render,this),this.listenTo(this.collection,"nc:ready",this.render),this.listenTo(this.collection,"reset",this._resetSocialProfileViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this._addSocialProfileView),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeProfileView),this.listenTo(this.collection,"remove",this.render);var e=this;this.listenTo(this.collection,"nc:error",function(){e._wasAbleToAccessAws=!1,e.render()}),this.collection.isReady()&&this.collection.trigger("nc:ready")},render:function(){if(!this._wasAbleToAccessAws)return this.el.innerHTML='<p><span class="nc-dashicons nc-dashicons-warning nc-colorize-error"></span> '+NelioContent.i18n.errors.api.emptyAjaxStatus+"</p>",this;var e={isTwitterEnabled:!0,isFacebookEnabled:!0,isGooglePlusEnabled:!0,isInstagramEnabled:!0,isLinkedInEnabled:!0,isPinterestEnabled:!0,maxNumOfProfiles:NelioContent.limits.maxProfiles>0?NelioContent.limits.maxProfiles:NelioContent.networkMetas.length,isLoadingSocialProfiles:!NelioContent.profiles.isReady(),numOfConnectedProfiles:this.collection.length};if(NelioContent.limits.maxProfilesPerNetwork>0){var t=NelioContent.limits.maxProfilesPerNetwork;NelioContent.profiles.where({network:"twitter"}).length>=t&&(e.isTwitterEnabled=!1),NelioContent.profiles.where({network:"facebook"}).length>=t&&(e.isFacebookEnabled=!1),NelioContent.profiles.where({network:"googleplus"}).length>=t&&(e.isGooglePlusEnabled=!1),NelioContent.profiles.where({network:"instagram"}).length>=t&&(e.isInstagramEnabled=!1),NelioContent.profiles.where({network:"linkedin"}).length>=t&&(e.isLinkedInEnabled=!1),NelioContent.profiles.where({network:"pinterest"}).length>=t&&(e.isPinterestEnabled=!1)}NelioContent.limits.maxProfiles>0&&NelioContent.profiles.length>=NelioContent.limits.maxProfiles&&(e.isTwitterEnabled=!1,e.isFacebookEnabled=!1,e.isGooglePlusEnabled=!1,e.isInstagramEnabled=!1,e.isLinkedInEnabled=!1,e.isPinterestEnabled=!1),this.el.innerHTML=this.template(e),this._rendered=0!==this.collection.length;var i=this.$(".nc-connected-profiles");return i.children().detach(),_.each(this._profileViews,function(e){i.append(e.render().el)},this),this},_addSocialProfile:function(t){var i=t.target||t.srcElement,n=e(i),o=n.closest(".nc-network").data("href");NelioContent.helpers.openPopup(o,640,480)},_addSocialProfileView:function(e){var t=new NelioContent.views.ConnectedSocialProfile({model:e});this._profileViews.push(t)},_removeProfileView:function(e){var t=_.filter(this._profileViews,function(t){return t.model===e},this);if(t.length>0){var i=t[0];this._profileViews=_.without(this._profileViews,i),this.stopListening(i),i.close()}},_resetSocialProfileViews:function(){_.each(this._profileViews,function(e){e.close()},this),this._profileViews=[],this.collection.each(_.bind(this._addSocialProfileView,this)),this._profileViews.sort(function(e,t){var i=e.model.get("creationDate"),n=t.model.get("creationDate");return n.isBefore(i)?-1:n.isAfter(i)?1:0})},close:function(){_.each(this._profileViews,function(e){e.close()},this),this._profileViews=[],this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var s=new NelioContent.views.SocialProfileSettings,a=e("#social-profile-settings-container");a.html(s.render().el)}NelioContent.views.GoogleAnalyticsSettingView=Backbone.View.extend({_mode:void 0,_$input:void 0,_$select:void 0,_changeProfileTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_ga-setting-change-profile").innerHTML)),_retrieveGACodeTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_ga-setting-retrieve-code").innerHTML)),events:{"click .nc-action.nc-dismiss-tokens-warning":"_dismissTokensWarning","change .nc-ga-selector":"_onGAViewChange","click .nc-action.nc-change":"_confirmAccountChange","click .nc-action.nc-do-change":"_doAccountChange","click .nc-action.nc-cancel-change":"_cancelAccountChange","click .nc-connect-ga":"_doConnection","change .nc-ga-code":"_onGACodeChange","keydown .nc-ga-code":"_onGACodeChange","paste .nc-ga-code":"_onGACodeChange","keyup .nc-ga-code":"_onGACodeChange","click .nc-ga-code-cancel":"_cancelCodeRetrieval","click .nc-ga-code-accept":"_processGACode","click .button.nc-refresh-analytics":"_refreshAnalytics"},initialize:function(e){this._$input=e.$input,this._$input.data("token-error")?this._mode="token-error":this._$input.val()?this._mode="view-selector":this._mode="connect-button",this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this._manageConfirmButton=_.debounce(this._manageConfirmButton,100)},render:function(){switch(this._mode){case"token-error":this._renderTokensExpirationWarning();break;case"view-selector":case"view-selector-awaiting-confirmation":case"view-selector-changing":this._renderViewSelector();break;case"connect-button":this._renderConnectButton();break;case"ga-retrieving-code":case"ga-code-retrieval":this._renderGACodeRetrieval()}return this.trigger("nc:change:analytics"),this},_renderTokensExpirationWarning:function(){this.$el.html("<p>"+NelioContent.i18n.feedback.gaTokensExpired+'</p><a class="button nc-action nc-dismiss-tokens-warning">'+NelioContent.i18n.actions.ok+"</a>")},_renderViewSelector:function(){return"undefined"==typeof this._$select?(this.$el.html('<span class="spinner is-active nc-ga-loading"></span>'),void this._loadViewsFromGoogleAnalytics()):void this.$(".nc-ga-setting-change-profile").html(this._changeProfileTemplate({mode:this._mode}))},_loadViewsFromGoogleAnalytics:function(){var t=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_get_ga_views"},success:function(e){var i=t._prepareViewSelectorData(e);t._makeViewSelector(i)},error:function(e){NelioContent.helpers.openErrorDialog(e.responseJSON),t._makeViewSelector([])}})},_renderConnectButton:function(){var t="<div>";t+='<button class="button nc-connect-ga">'+NelioContent.i18n.actions.connectGoogleAnalytics+"</button> ",t+='<button class="button nc-refresh-analytics">'+NelioContent.i18n.actions.refreshAnalytics+"</button>",t+="</div>";var i=e(t);this.$el.html(i)},_dismissTokensWarning:function(e){e.preventDefault(),this._mode="connect-button",this.trigger("nc:render")},_doConnection:function(e){e.preventDefault(),this._mode="ga-code-retrieval",this.trigger("nc:render")},_renderGACodeRetrieval:function(){this.$el.html(e('<div class="ga-setting-retrieve-code"></div>')),this.$(".ga-setting-retrieve-code").html(this._retrieveGACodeTemplate({})),o="https://accounts.google.com/o/oauth2/v2/auth?client_id=1085875842646-v5k3smokc0j3hnjev0q2bq7r3kbgqlmm.apps.googleusercontent.com&response_type=code&redirect_uri=urn:ietf:wg:oauth:2.0:oob&scope=https://www.googleapis.com/auth/analytics.readonly";NelioContent.helpers.openPopup(o,640,480)},_onGACodeChange:function(e){13===e.keyCode&&e.preventDefault(),this._manageConfirmButton(e)},_manageConfirmButton:function(t){if("ga-code-retrieval"===this._mode){var i=e(".nc-ga-code"),n=e(".nc-ga-code-accept");i.val()?(n.prop("disabled",!1),"keyup"===t.type&&13===t.keyCode&&this._processGACode(t)):n.prop("disabled",!0)}},_cancelCodeRetrieval:function(e){e.preventDefault(),this._mode="connect-button",this.trigger("nc:render")},_processGACode:function(t){if(t.preventDefault(),"ga-retrieving-code"!==this._mode){this._mode="ga-retrieving-code";var i=e(".nc-ga-code"),n=e(".nc-ga-code-accept"),o=e(".nc-ga-code-cancel");i.prop("disabled",!0),n.prop("disabled",!0),o.prop("disabled",!0),n.html(NelioContent.i18n.feedback.loading);var s=e(".nc-ga-code").val(),a=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_get_ga_token",code:s},success:function(e){a._mode="view-selector",a._loadViewsFromGoogleAnalytics()},error:function(e){NelioContent.helpers.openErrorDialog(e.responseJSON),n.html(NelioContent.i18n.actions.load),i.prop("disabled",!1),n.prop("disabled",!1),o.prop("disabled",!1),a._mode="ga-code-retrieval"}})}},_prepareViewSelectorData:function(e){var t=this._$input.val(),i=[];return e.items.forEach(function(e){e.webProperties&&e.webProperties.forEach(function(e){var t=_.map(e.profiles,function(e){return{id:e.id,text:e.name}});i.push({id:e.id,text:e.name,children:t})})}),_.contains(_.pluck(_.flatten(_.pluck(i,"children")),"id"),t)||this._updateHiddenInput(""),i},_makeViewSelector:function(t){this._$select=e('<select class="nc-ga-selector"></select>'),this.$el.html(this._$select),this.$el.append(e('<div class="nc-ga-setting-change-profile"></div>')),this._$select.ncselect2({data:t,templateResult:this._templateGAViewResult,width:"400px",dropdownCssClass:"nc-ga-selector-dropdown",placeholder:NelioContent.i18n.gaSelectorPlaceholder}),this._$select.val(this._$input.val()),this._$select.trigger("change"),this.trigger("nc:render")},_onGAViewChange:function(){this._updateHiddenInput(this._$select.val())},_confirmAccountChange:function(){this._mode="view-selector-awaiting-confirmation",this.trigger("nc:render")},_cancelAccountChange:function(){this._mode="view-selector",this.trigger("nc:render")},_doAccountChange:function(){this._mode="connect-button",this._$select.ncselect2("destroy"),this._$select=void 0,this._updateHiddenInput(""),this.trigger("nc:render")},_templateGAViewResult:function(t){var i;return i=e(void 0!==t.children?'<span class="nc-ga-view-text">'+t.text+'</span><span class="nc-ga-view-id">('+t.id+")</span>":'<span class="nc-ga-view-text">'+t.text+"</span>")},_refreshAnalytics:function(e){e.preventDefault();var t=new NelioContent.views.AnalyticsRefresherSettingView;t.render().open()},_updateHiddenInput:function(e){this._$input.val(e).trigger("change"),this.$(".nc-refresh-analytics").prop("disabled",e!==NelioContent.analytics.gaViewId)},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.AnalyticsRefresherSettingView=Backbone.View.extend({_buttons:void 0,_closed:!1,_data:void 0,className:"nc-analytics-refresher-dialog",template:_.template(NelioContent.helpers.trim(document.getElementById("_analytics-refresher-dialog").innerHTML)),events:{"change .nc-period":"_changePeriod"},initialize:function(t){this.render=_.bind(this.render,this),this._requestNextBatch=_.bind(this._requestNextBatch,this),this._processBatch=_.bind(this._processBatch,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this,"nc:click:dialog:cancel",this.close),this.listenTo(this,"nc:click:dialog:refresh-analytics",this._refreshAnalytics);var i=this;this.$el.dialog({title:NelioContent.i18n.titles.refreshAnalytics,modal:!0,autoOpen:!1,closeOnEscape:!1,width:Math.min(500,e(window).width()-20),dialogClass:"nc-dialog",buttons:[NelioContent.helpers.makeDialogButton(this,"cancel",NelioContent.i18n.actions.cancel,!1),NelioContent.helpers.makeDialogButton(this,"refresh-analytics",NelioContent.i18n.actions.refreshAnalytics,!0)],close:function(){i.close()}}),this._data={batch:0,period:"month",processedItems:0,totalItems:0}},render:function(){return this.$el.html(this.template()),this},open:function(){this.$el.dialog("open");var e=this.$el.closest(".ui-dialog");return this._buttons={$refresh:e.find(".nc-refresh-analytics-button"),$cancel:e.find(".nc-cancel-button")},this},_lock:function(){this._buttons.$refresh.prop("disabled",!0),this.$("select").prop("disabled",!0),this.$("input").prop("disabled",!0)},_unlock:function(){this.$("input").prop("disabled",!1),this.$("select").prop("disabled",!1),this._buttons.$refresh.prop("disabled",!1),this._buttons.$refresh.html(NelioContent.i18n.actions.refreshAnalytics)},_changePeriod:function(e){e.preventDefault(),this._data.period=this.$(".nc-period").val()},_refreshAnalytics:function(){this._lock(),this._buttons.$refresh.html(NelioContent.i18n.feedback.refreshingAnalytics),this._data.batch=0,this._data.processedItems=0,this.$(".nc-count .nc-total").html(NelioContent.i18n.feedback.retrievingPosts),this._requestNextBatch()},_requestNextBatch:function(){if(!this._closed){++this._data.batch;var t=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_get_post_ids",page:this._data.batch,period:this._data.period},success:function(e){return 1===t._data.batch&&0===parseInt(e.found)?(t.close(),void NelioContent.helpers.openWarningDialog(NelioContent.i18n.titles.refreshAnalytics,NelioContent.i18n.dialogs.analyticsNoPostsFound)):"object"!=typeof e.items||0===e.items.length?void t._updateLastGlobalUpdate():(1===t._data.batch&&(t._data.totalItems=parseInt(e.found),t._updateProgressBar()),void t._processBatch(e.items))},error:function(){t._unlock()}})}},_processBatch:function(t){for(var i=this,n=[],o=0;o<t.length;++o)n.push(e.ajax({url:ajaxurl,data:{action:"nelio_content_update_analytics",post:t[o]},complete:function(){i._closed||(++i._data.processedItems,i._updateProgressBar())}}));e.when.apply(this,n).always(this._requestNextBatch)},_updateLastGlobalUpdate:function(){this._buttons.$cancel.prop("disabled",!0),this.$(".nc-count .nc-current").empty(),this.$(".nc-count .nc-total").html(NelioContent.i18n.feedback.waitAMoment);var t=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_update_analytics_last_global_update"},complete:function(){t.close(),NelioContent.helpers.openDialog(NelioContent.i18n.titles.refreshAnalytics,NelioContent.i18n.dialogs.analyticsProcessed.replace(/{posts}/,t._data.totalItems))}})},_updateProgressBar:function(){if(!this._closed){var e=Math.round(100*this._data.processedItems/this._data.totalItems);this.$(".nc-progress-bar").css("width",Math.min(100,e)+"%"),this.$(".nc-count .nc-current").html(this._data.processedItems),this.$(".nc-count .nc-total").html("/"+this._data.totalItems)}},close:function(){this.$el.dialog("destroy"),this._closed=!0,this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var c=new NelioContent.views.GoogleAnalyticsSettingView({el:e("#google-analytics-view-container"),$input:e("#google-analytics-view-input")});Backbone.listenTo(c,"nc:change:analytics",t),c.render();var l="social-profiles";/\btab=[^&]+\b/.test(o)&&(l=o.match(/\btab=([^&]+)\b/)[1]),_.contains(["social-profiles"],l)||e(".nc-settings-form").addClass("nc-show-submit")}(jQuery);