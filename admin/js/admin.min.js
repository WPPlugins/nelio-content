!function(e){"use strict";NelioContent.hasSocialProfiles=!!NelioContent.hasSocialProfiles;var t=NelioContent.i18n.locale.toLowerCase().replace("_","-"),i=t;i.indexOf("-")>0&&(i=i.substr(0,i.indexOf("-"))),e.fn.ncselect2.defaults.set("language",i),_.contains(moment.locales(),t)?moment.updateLocale(t,{calendar:{lastDay:NelioContent.i18n.date.lastDay,sameDay:NelioContent.i18n.date.sameDay,nextDay:NelioContent.i18n.date.nextDay,lastWeek:NelioContent.i18n.date.lastWeek,nextWeek:NelioContent.i18n.date.nextWeek,sameElse:NelioContent.i18n.date["default"]},week:{dow:NelioContent.i18n.startOfWeek}}):_.contains(moment.locales(),i)&&moment.updateLocale(i,{calendar:{lastDay:NelioContent.i18n.date.lastDay,sameDay:NelioContent.i18n.date.sameDay,nextDay:NelioContent.i18n.date.nextDay,lastWeek:NelioContent.i18n.date.lastWeek,nextWeek:NelioContent.i18n.date.nextWeek,sameElse:NelioContent.i18n.date["default"]},week:{dow:NelioContent.i18n.startOfWeek}}),function(e){NelioContent.models.Model=Backbone.Model.extend({sync:function(e,t,i){return i=i||{},i.beforeSend=function(e){e.setRequestHeader("Authorization","Bearer "+NelioContent.apiAuthToken)},Backbone.Model.prototype.sync.apply(this,arguments)}}),NelioContent.collections.Collection=Backbone.Collection.extend({sync:function(e,t,i){return i=i||{},i.beforeSend=function(e){e.setRequestHeader("Authorization","Bearer "+NelioContent.apiAuthToken)},Backbone.Collection.prototype.sync.apply(this,arguments)}})}(jQuery),function(e){var t=-1;NelioContent.helpers.refreshAuthToken=function(t,i){e.ajax({url:ajaxurl,data:{action:"nelio_content_get_api_auth_token"},success:function(e){NelioContent.apiAuthToken=e,"function"==typeof t&&t()},error:function(e){"function"==typeof i&&i(e)}})},NelioContent.helpers.isSubscribed=function(){return"none"!==NelioContent.subscription.plan},NelioContent.helpers.isSubscribedTo=function(e,t){if("undefined"==typeof t&&(t="exactly"),!NelioContent.helpers.isSubscribed())return!1;var i=NelioContent.subscription.plan+"-plan";if(e===i)return!0;if("or-above"===t)switch(e){case"personal-plan":return!0}return!1},NelioContent.helpers.getWindowWidth=function(){return e(window).width()},NelioContent.helpers.getScrollbarWidth=function(){if(t>=0)return t;var e=document.createElement("div");e.style.visibility="hidden",e.style.width="100px",e.style.msOverflowStyle="scrollbar",document.body.appendChild(e);var i=e.offsetWidth;e.style.overflow="scroll";var n=document.createElement("div");n.style.width="100%",e.appendChild(n);var s=n.offsetWidth;return e.parentNode.removeChild(e),t=i-s},NelioContent.helpers.openPopup=function(e,t,i){var n="undefined"!=typeof window.screenLeft?window.screenLeft:screen.left,s="undefined"!=typeof window.screenTop?window.screenTop:screen.top,o=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,a=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,r=o/2-t/2+n,l=a/2-i/2+s,h=window.open(e,"","width="+t+", height="+i+", top="+l+", left="+r);return window.focus&&h.focus(),h},NelioContent.helpers.addStyle=function(e){var t=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e)),t.appendChild(i)},NelioContent.helpers.callAndDebounce=function(e,t,i){"number"!=typeof i&&(i=0);var n=!1,s=function(){e(),n=!0};0===i?s():setTimeout(s,i);var o=_.debounce(e,t),a=function(){n&&o()};return a},NelioContent.helpers.getParamFromUrl=function(e,t){arguments.length<2&&(t=e,e=window.location.href);var i=e.split("?"),n=i[1]||"";n=n.split("&");for(var s=0;s<n.length;++s){var o=n[s];if(o===t)return"";if(0===o.indexOf(t+"="))return o.replace(t+"=","")}},NelioContent.helpers.addParamInUrl=function(e,t,i){var n=!1;arguments.length<3&&(i=t,t=e,e=window.location.href,n=!0);var s=e.split("?");e=s[0];var o=s[1]||"";o=o.split("&");var a;for(a=0;a<o.length;++a){var r=o[a];if(r===t||0===r.indexOf(t+"="))break}return"undefined"==typeof i?o[a]=t:o[a]=t+"="+encodeURIComponent(i),o.length>0&&(e+="?"+o.join("&")),n&&"function"==typeof history.replaceState&&history.replaceState(null,null,e),e},NelioContent.helpers.removeParamFromUrl=function(e,t){var i=!1;arguments.length<2&&(t=e,e=window.location.href,i=!0);var n=t;"string"==typeof n&&(n=[t]);var s=e.split("?");e=s[0];var o=s[1]||"";o=o.split("&");for(var a=0;a<o.length;++a)for(var r=o[a],l=0;l<n.length;++l){var t=n[l];r!==t&&0!==r.indexOf(t+"=")||(o[a]=void 0)}return o.length>0&&(e+="?"+o.join("&").replace(/&+/g,"&").replace(/^&|&$/g,"")),i&&"function"==typeof history.replaceState&&history.replaceState(null,null,e),e},NelioContent.helpers.getSelection=function(e){if("undefined"!=typeof document.selection){e.focus();var t=document.selection.createRange();return t.text}if(void 0!==e.selectionStart){var i=e.selectionStart,n=e.selectionEnd;return e.value.substring(i,n)}return""}}(jQuery),function(e){NelioContent.helpers.trim=function(e){return"string"!=typeof e?e:e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},NelioContent.helpers.capitalizeFirstLetter=function(e){return"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1)},NelioContent.helpers.strongify=function(e,t){t=t.replace("\\",""),t=t.replace(".","\\.");var i=new RegExp(t,"gi");return e.replace(i,"<strong>$&</strong>")};var t=document.createElement("div");NelioContent.helpers.decodeHTMLEntities=function(e){return"string"!=typeof e?"":(e=e.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),e=e.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),t.innerHTML=e,e=t.textContent,NelioContent.helpers.trim(e))},NelioContent.helpers.extractFirstLetter=function(e){var t=latinize(e.toLowerCase()).replace(/[^a-z]/g,"");return t.length>0?t.substring(0,1):"unknown"};var i=/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;NelioContent.helpers.isEmail=function(e){return i.test(e)}}(jQuery),function(e){e.widget("ui.dialogS2",e.ui.dialog,{_allowInteraction:function(e){return!0}}),NelioContent.helpers.openDeletionConfirmationDialog=function(t,i,n,s){var o=e("<div>"+i+"</div>");return o.dialog({title:t,modal:!0,width:Math.min(500,e(window).width()-20),dialogClass:"nc-dialog",buttons:[{"class":"button nc-cancel-button",text:NelioContent.i18n.actions.cancel,click:function(){o.dialog("close")}},{"class":"button nc-super-delete-button",text:n,click:function(){s()}}]}),o},NelioContent.helpers.openConfirmationDialog=function(t,i,n,s){var o=e("<div>"+i+"</div>");return o.dialog({title:t,modal:!0,width:Math.min(500,e(window).width()-20),dialogClass:"nc-dialog",buttons:[{"class":"button nc-cancel-button",text:NelioContent.i18n.actions.cancel,click:function(){o.dialog("close")}},{"class":"button button-primary",text:n,click:function(){s()}}]}),o},NelioContent.helpers.openDialog=function(t,i){var n=e("<p>"+i+"</p>");return n.dialog({title:t,modal:!0,width:Math.min(500,e(window).width()-20),dialogClass:"nc-dialog",buttons:[{"class":"button nc-cancel-button",text:NelioContent.i18n.actions.ok,click:function(){n.dialog("close"),n.dialog("destroy")}}]}),n};var t=[];NelioContent.helpers.openWarningDialog=function(i,n){n='<span class="nc-dashicons nc-dashicons-warning"></span> '+n;var s=e('<div class="nc-error-dialog">'+n+"</div>");s.dialog({title:i,modal:!0,autoOpen:!1,width:Math.min(500,e(window).width()-20),dialogClass:"nc-dialog",buttons:[{"class":"button nc-cancel-button",text:NelioContent.i18n.actions.ok,click:function(){s.dialog("close"),s.dialog("destroy")}}],close:function(){t.shift(),t.length&&t[0].dialog("open")}}),t.push(s),t[0]===s&&s.dialog("open")},NelioContent.helpers.openErrorDialog=function(e){NelioContent.helpers.openWarningDialog(NelioContent.i18n.titles.error,e)},NelioContent.helpers.makeDialogButton=function(t,i,n,s){var o="button";return s&&(o="button button-primary"),{"class":o+" nc-"+i+"-button",text:n,click:function(n){var s=n.target||n.srcElement,o=e(s).closest("button");o.hasClass("button-disabled")||t.trigger("nc:click:dialog:"+i,n)}}},NelioContent.helpers.makeDialogSaveButton=function(e,t){return NelioContent.helpers.makeDialogButton(e,"save",t,!0)},NelioContent.helpers.makeDialogCancelButton=function(e,t){return NelioContent.helpers.makeDialogButton(e,"cancel",t)},NelioContent.helpers.makeDialogDeleteButton=function(e,t){return NelioContent.helpers.makeDialogButton(e,"delete",t)},NelioContent.helpers.makeWarningTooltip=function(e){"undefined"!=typeof e&&0!==e.length&&e.tooltip({position:{my:"right bottom",at:"right+5 top-5"},tooltipClass:"nc_tooltip nc_warning_tooltip",show:!1,hide:!1})},NelioContent.helpers.makeInfoTooltip=function(e){"undefined"!=typeof e&&0!==e.length&&e.tooltip({position:{my:"center top",at:"center bottom+10"},tooltipClass:"nc_tooltip",show:!1,hide:!1})}}(jQuery),function(e){NelioContent.helpers.selectImage=function(e){"undefined"==typeof e&&(e={}),"function"!=typeof e.onSelection&&(e.onSelection=function(){});var t=wp.media.frames.shareImageFrame=wp.media({title:NelioContent.i18n.titles.selectImage,button:{text:NelioContent.i18n.actions.choose},multiple:!1});t.on("select",function(){var i=t.state().get("selection").first().toJSON();e.onSelection(i)}),"number"==typeof e.image&&t.on("open",function(){var i=wp.media.attachment(e.image);t.state().get("selection").add(i)}),"function"==typeof e.onClose&&t.on("close",e.onClose),t.open()}}(jQuery),function(e){var t=/20[0-9][0-9]-[01][0-9]-[0-3][0-9]/,i=/[012][0-9]:[0-5][0-9]/;window.ncLocalizeMoment=function(e,t){return"undefined"==typeof t&&(t=NelioContent.i18n.timezone),t.indexOf(":")>0?e.utcOffset(t):e.tz(t),e},window.ncNewLocalMoment=function(e,t){return"string"==typeof e&&""!==NelioContent.helpers.trim(e)||(e=ncLocalizeMoment(moment()).format("YYYY-MM-DD HH:mm")),/^[0-9]{4}.[0-9]{2}.[0-9]{2}/.test(e)&&!/^[0-9]{4}.[0-9]{2}.[0-9]{2}.[0-9]{2}:[0-9]/.test(e)&&(e=NelioContent.helpers.trim(e)+" 12:00"),"undefined"==typeof t&&(t=NelioContent.i18n.timezone),t.indexOf(":")>0?ncLocalizeMoment(moment(e+t),t):ncLocalizeMoment(moment.tz(e,t),t)},NelioContent.helpers.isDate=function(e){return t.test(e)},NelioContent.helpers.isTime=function(e){return i.test(e)},NelioContent.helpers.getTimeInterval=function(e){var t,i,n;switch(e){case"all":t=void 0,i=void 0;break;case"month-to-date":t=moment().date(1).format("YYYY/MM/DD"),i=moment().format("YYYY/MM/DD");break;case"last-30-days":t=moment().add(-30,"days").format("YYYY/MM/DD"),i=moment().format("YYYY/MM/DD");break;case"last-month":n=moment().add(-1,"months"),t=n.startOf("month").format("YYYY/MM/DD"),i=n.endOf("month").format("YYYY/MM/DD");break;case"year-to-date":t=moment().startOf("year").format("YYYY/MM/DD"),i=moment().format("YYYY/MM/DD");break;case"last-12-months":t=moment().add(-12,"months").format("YYYY/MM/DD"),i=moment().format("YYYY/MM/DD");break;case"last-year":n=moment().add(-1,"years"),t=n.startOf("year").format("YYYY/MM/DD"),i=n.endOf("year").format("YYYY/MM/DD")}return{from:t,to:i,mode:e}}}(jQuery),function(e){function t(e){if(_.indexOf(o,e)!==-1)return!0;var t=i(e);return!(t.length>0&&_.indexOf(a,t)!==-1)&&(o.push(e),!0)}function i(e){var t=e.indexOf("?");if(-1!==t&&(e=e.substring(0,t)),/^https?:\/\//i.test(e)){e=e.replace(/^https?:\/\//i,"");var i=e.indexOf("/");if(-1===i)return"";e=e.substring(i,e.length)}var n=e.substring(Math.max(0,e.length-6),e.length),s=n.indexOf(".");return-1!==s?n.substring(s+1,n.length).toLowerCase():""}var n=/<a[^>]+href=("[^"]*"|'[^']*')/gi,s=/<img[^>]+src=("[^"]*"|'[^']*')/gi,o=[],a=["jpg","png","tif","bmp","svg","pgm","pbm","pnm","hdr","bpg","cpt","psd","psp","xcf","ppm","dwf","dwg","dxf","jpeg","tiff","webp","heif","mkv","flv","avi","mov","vob","ogv","ogg","drc","mng","mov","wmv","yuv","asf","mp4","m4p","m4v","mpg","mpe","mpv","mp2","m2v","m4v","svi","3gp","3g2","mxf","roq","nsv","f4v","f4p","f4a","f4b","rm","qt","webm","gifv","rmvb","mpeg","zip","rar","3ds","x3d","xgl","pub","7z","po","pot","js","css","scss"];NelioContent.helpers.countImages=function(e){var t=e.match(s);return"undefined"==typeof t||null===t?0:t.length},NelioContent.helpers.extractUrls=function(e){for(var i,s=[];i=n.exec(e);){var o=i[1];o=o.substring(1,o.length-1),t(o)&&_.indexOf(s,o)===-1&&s.push(o)}return s}}(jQuery),function(e){NelioContent.helpers.buildPostFilter=function(t,i){"undefined"==typeof i&&(i=!1),"remove-none-option"===i&&t.find("option[value=none]").remove();var n;t.ncselect2({width:"15em",templateSelection:function(t){switch(t.id){case"all":return NelioContent.postTypes.length>1?NelioContent.i18n.filters.selection.allPostTypes:NelioContent.postTypes[0].labels.allItems;case"none":return n='<span class="nc-dashicons nc-dashicons-hidden"></span> ',e(1===NelioContent.postTypes.length&&"post"===NelioContent.postTypes[0].name?"<span>"+n+NelioContent.i18n.filters.selection.noPosts+"</span>":"<span>"+n+NelioContent.i18n.filters.selection.noPostTypes+"</span>");default:return n="post"===t.id?'<span class="nc-dashicons nc-dashicons-admin-post"></span> ':"page"===t.id?'<span class="nc-dashicons nc-dashicons-admin-page"></span> ':'<span class="nc-dashicons nc-dashicons-marker"></span> ',e("<span>"+n+t.text+"</span>")}}})}}(jQuery),setInterval(NelioContent.helpers.refreshAuthToken,6e5),NelioContent.models.SocialProfile=NelioContent.models.Model.extend({_allowsMultiTargets:!1,_isImageRequired:!1,urlRoot:NelioContent.apiUri+"/profile",defaults:function(){return{calendarId:"",profileId:"",network:"",kind:"",photo:"",creationDate:ncNewLocalMoment(),displayName:"",firstLetter:"",creatorId:0,creatorDisplayName:"",creatorEditLink:"",username:"",status:"valid"}},_creator:!1,initialize:function(){this.listenTo(this,"change:displayName",this._setFirstLetter),this._setFirstLetter(),this.listenTo(this,"change:displayName",this._escapeNameAndUsername),this.listenTo(this,"change:username",this._escapeNameAndUsername),this._escapeNameAndUsername(),this.listenTo(this,"change:creationDate",this._fixCreationDateFormat),this._fixCreationDateFormat(),this.listenTo(this,"change:network",this._fixAllowsMultiTargets),this._fixAllowsMultiTargets(),this.listenTo(this,"change:network",this._fixImageIsRequired),this._fixImageIsRequired(),this.listenTo(this,"change:creatorId",this._changeCreator),this._changeCreator()},allowsMultiTargets:function(){return this._allowsMultiTargets},requiresImageToShare:function(){return this._isImageRequired},_setFirstLetter:function(){this.set("firstLetter",NelioContent.helpers.extractFirstLetter(this.get("displayName")))},_fixCreationDateFormat:function(){var e=this.get("creationDate");"string"==typeof e&&this.set("creationDate",ncNewLocalMoment(e))},_changeCreator:function(){this._creator&&(this.stopListening(this._creator),this._creator=!1),this._creator=NelioContent.users.getUser(this.get("creatorId"));var e=this._creator;e.valid()?(this.set("creatorDisplayName",e.get("name")),this.set("creatorEditLink",e.get("editLink"))):(this.set("creatorDisplayName",""),this.set("creatorEditLink",""));var t=this;this.listenTo(e,"nc:load",function(){e.valid()?(t.set("creatorDisplayName",e.get("name")),t.set("creatorEditLink",e.get("editLink"))):(t.set("creatorDisplayName",""),t.set("creatorEditLink",""))})},_escapeNameAndUsername:function(){var e=this.get("username");"twitter"===this.get("network")&&"@"!==e[0]&&(e="@"+e,this.set("username",e)),this.set("displayNameEscaped",_.escape(this.get("displayName"))),this.set("usernameEscaped",_.escape(this.get("username")))},_fixAllowsMultiTargets:function(){var e=_.findWhere(NelioContent.networkMetas,{id:this.get("network")});"undefined"!=typeof e&&e.allowsMultiTargets?this._allowsMultiTargets=!0:this._allowsMultiTargets=!1},_fixImageIsRequired:function(){var e=_.findWhere(NelioContent.networkMetas,{id:this.get("network")});"undefined"!=typeof e&&e.isImageRequired?this._isImageRequired=!0:this._isImageRequired=!1}}),NelioContent.collections.ConnectedSocialProfiles=NelioContent.collections.Collection.extend({model:NelioContent.models.SocialProfile,_isReady:!1,isReady:function(){return this._isReady},populate:function(){this.reload()},reload:function(){this._isReady=!1;var t=this;e.ajax({url:NelioContent.apiUri+"/profiles",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){t._updateProfileAvailabilityInWP(e.length>0),t._isReady=!0,t.reset(e),t.trigger("nc:ready")},error:function(e){t._isReady=!0,t.reset([]),t.trigger("nc:error")}})},_updateProfileAvailabilityInWP:function(t){NelioContent.hasSocialProfiles!==t&&e.ajax({url:ajaxurl,data:{action:"nelio_content_update_profiles_availability",value:t?"yes":"no"}})}}),NelioContent.profiles=new NelioContent.collections.ConnectedSocialProfiles,NelioContent.profiles.populate(),NelioContent.models.User=Backbone.Model.extend({defaults:{email:"",name:NelioContent.i18n.unknownUserName,photo:"",role:"subscriber",loading:!1,existsInWordPress:!0},initialize:function(){this.listenTo(this,"change:name",this._setFirstLetter),this._setFirstLetter()},loadData:function(){if(!this.get("loading")){if(!this.get("id"))return this.set("loading",!1),void this.set("existsInWordPress",!1);this.set("loading",!0);var t=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_get_user",user:t.get("id")},success:function(e){e.loading=!1,e.existsInWordPress=!0,t.set(e),t.trigger("nc:load")},error:function(){var e={loading:!1,existsInWordPress:!1};t.set(e),t.trigger("nc:load:error")}})}},valid:function(){return!this.get("loading")&&this.get("existsInWordPress")},isLoading:function(){return this.get("loading")},_setFirstLetter:function(){var e=this.get("name");e===NelioContent.i18n.unknownUserName&&(e=""),this.set("firstLetter",NelioContent.helpers.extractFirstLetter(e))}}),NelioContent.collections.Users=Backbone.Collection.extend({model:NelioContent.models.User,current:function(){return this.get(NelioContent.userId)},getUser:function(e){var t=this.get(e);return"undefined"==typeof t&&(t=new NelioContent.models.User({id:e}),t.loadData(),this.add(t)),t}}),NelioContent.users=new NelioContent.collections.Users(NelioContent.users),NelioContent.models.AjaxError=Backbone.Model.extend({defaults:function(){return{code:0,message:""}},initialize:function(){},parseResponse:function(e){var t=503,i=NelioContent.i18n.errors.api.emptyAjaxStatus;0!==e.status&&(t=e.status),"string"==typeof e.reponseJSON&&(i=e.responseJSON),this.set("code",t),this.set("message",i)}}),NelioContent.models.Post=Backbone.Model.extend({defaults:function(){return{id:0,type:NelioContent.postTypes[0].name,status:"draft",calendarKind:"post",title:"",excerpt:"",editLink:"",permalink:"",categories:[],titleFormatted:"",excerptFormatted:"",author:0,autoImage:"",imageId:0,image:"",date:!1,statistics:!1,socialQueueError:!1,publishCount:"&ndash;",scheduleCount:!1}},initialize:function(){this.listenTo(this,"change:permalink",this._checkPermalink),this._checkPermalink(),this.listenTo(this,"change:id",this._fixPostIdType),this._fixPostIdType(),this.listenTo(this,"change:imageId",this._fixImageIdType),this._fixImageIdType(),this.listenTo(this,"change:date",this._fixDateFormat),this._fixDateFormat(),this.listenTo(this,"change:title",this._escapeTitle),this.listenTo(this,"change:excerpt",this._escapeExcerpt),this._maybeUnescapeTitleAndExcerpt()},isPublished:function(){return"publish"===this.get("status")},isScheduled:function(){return!this.isPublished()&&!(!this.get("date")||!ncNewLocalMoment().isBefore(this.get("date")))},getDateForSorting:function(){return this.get("date").format("YYYY-MM-DDTHH:mm")},getRelevantDay:function(){return this.get("date").format("YYYY-MM-DD")},reschedule:function(t){if(this.get("date").format("YYYY-MM-DD")===t)return void this.trigger("nc:abort:reschedule");var i=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_reschedule_post",post:this.get("id"),date:t},success:function(e){i.set(e),i.trigger("nc:reschedule")},error:function(e){i.trigger("nc:error",e.responseJSON)}})},isLoading:function(){return this.get("loading")},trash:function(){var t=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_trash_post",post:this.get("id")},success:function(){t.trigger("nc:trash")},error:function(e){t.trigger("nc:error",e.responseJSON)}})},_fixPostIdType:function(){this.stopListening(this,"change:id",this._fixPostIdType);var e=this.get("id");"string"==typeof e&&(e=parseInt(e),isNaN(e)?(this.set("id",0),this.set("status","draft"),this.set("title",""),this.set("permalink",""),this.set("excerpt","")):this.set("id",e)),this.listenTo(this,"change:id",this._fixPostIdType)},_fixImageIdType:function(){this.stopListening(this,"change:imageId",this._fixImageIdType);var e=this.get("imageId");e=parseInt(e),isNaN(e)||this.set("imageId",e),this.listenTo(this,"change:imageId",this._fixImageIdType)},_fixDateFormat:function(){var e=this.get("date");"string"==typeof e&&this.set("date",ncNewLocalMoment(e))},_checkPermalink:function(){this.stopListening(this,"change:permalink",this._checkPermalink);var e=this.get("permalink");"undefined"!=typeof e&&""!==NelioContent.helpers.trim(e)||this.set("permalink",NelioContent.blogUrl),this.listenTo(this,"change:permalink",this._checkPermalink)},_escapeTitle:function(){this.set("titleFormatted",_.escape(this.get("title")))},_escapeExcerpt:function(){this.set("excerptFormatted",_.escape(this.get("excerpt")))},_maybeUnescapeTitleAndExcerpt:function(){var e=this.get("title");"undefined"!=typeof e&&0!==NelioContent.helpers.trim(e).length||this.set("title",NelioContent.helpers.decodeHTMLEntities(this.get("titleFormatted")));var t=this.get("excerpt");"undefined"!=typeof t&&0!==NelioContent.helpers.trim(t).length||this.set("excerpt",NelioContent.helpers.decodeHTMLEntities(this.get("excerptFormatted")))}}),NelioContent.models.SocialMessage=NelioContent.models.Model.extend({urlRoot:NelioContent.apiUri+"/social",defaults:function(){return{siteId:"",profileId:"",targetName:"default",targetDisplayName:"",profiles:[],network:"twitter",networkKind:"single",calendarKind:"social",type:"text",status:"draft",postId:0,postType:NelioContent.postTypes[0].name,baseDatetime:"none",dateType:"predefined-offset",dateValue:"0",timeType:"predefined-offset",timeValue:"0",timezone:NelioContent.i18n.timezone,schedule:ncNewLocalMoment(),text:"",textComputed:"",image:"",imageId:0,sent:!1,sentTime:0,sentResponse:"",sentAttempts:0,nextAttemptTimestamp:0,failureDescription:"",url:"",timestamp:0}},post:new NelioContent.models.Post,initialize:function(){this._computeText(),this._extractRelevantUrl(),this.listenTo(this,"change:text",this._computeText),this.listenTo(this,"change:textComputed",this._extractRelevantUrl),this.listenTo(this,"change:network",this._extractRelevantUrl),this.listenTo(this,"change:profileId",this._fixProfileInformation),this._fixProfileInformation(),this.listenTo(this,"change:schedule",this._fixScheduleFormat),this._fixScheduleFormat(),this.listenTo(this,"change:dateValue",this._fixSchedule),this.listenTo(this,"change:timeValue",this._fixSchedule),this.listenTo(this,"change:postId",this._setDefaultText),this.listenTo(this,"change:network",this._updateMaxTextLength),this.listenTo(this,"change:profiles",this._updateMaxTextLength),this._updateMaxTextLength(),this.listenTo(this,"change:dateType",this._setBaseDatetime),this._setBaseDatetime()},setPost:function(e){this.stopListening(this.post),this.post=e,this.set("postId",this.post.get("id")),this.set("postType",this.post.get("type")),this._setBaseDatetime(),this._fixSchedule(),this.listenTo(this.post,"change:dateType",this._setBaseDatetime),this.trigger("change:text")},loadPost:function(){if(0===this.get("postId"))return void this.trigger("nc:load:post");if(this.get("postId")===this.post.get("id"))return void this.trigger("nc:load:post");var t=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_get_post",post:this.get("postId")},success:function(e){t.setPost(new NelioContent.models.Post(e)),t.trigger("nc:load:post")},error:function(e){t.trigger("nc:error:post",e.responseJSON)}})},getTextLength:function(){var e=this.get("textComputed");return"image"===this.get("type")&&(e+=" https://neliosoftware.com/wp-content/image.jpg"),twttr.txt.getTweetLength(e)},isTextTooLong:function(){return this.getTextLength()>this.getMaxTextLength()},getMaxTextLength:function(){return this._maxTextLength},getDateForSorting:function(){var e="";if(this.post.isPublished()||this.post.isScheduled()){var t=this.get("schedule");e+=t.format("YYYY-MM-DDTHH:mm")}else{if("exact"===this.get("dateType"))e+=this.get("dateValue");else{var i="Z0000000"+this.get("dateValue");e+=i.substr(i.length-6)}if("exact"===this.get("timeType"))e+=this.get("timeValue");else{var n="Z0000000"+this.get("timeValue");e+=n.substr(n.length-6)}}return e.toLowerCase()},getRelevantDay:function(){return this.get("schedule").format("YYYY-MM-DD")},isSomethingMissing:function(){if(NelioContent.helpers.trim(this.get("text"))<=0)return NelioContent.i18n.errors.socialMessage.noMessage;if(this.isTextTooLong())return NelioContent.i18n.errors.socialMessage.messageTooLong;if(this.isNew()&&this.get("profiles").length<=0)return NelioContent.i18n.errors.socialMessage.noProfiles;var e,t=!1;if(this.isNew()?_.each(this.get("profiles"),function(i){e=NelioContent.profiles.get(i.id),"undefined"!=typeof e&&(t=t||e.requiresImageToShare())}):(e=NelioContent.profiles.get(this.get("profileId")),"undefined"!=typeof e&&(t=e.requiresImageToShare())),t&&"image"!==this.get("type"))return this.isNew()&&this.get("profiles").length>1?NelioContent.i18n.errors.socialMessage.noImageMultiple:NelioContent.i18n.errors.socialMessage.noImageSingle;if(NelioContent.helpers.trim(this.get("targetName"))<=0)return NelioContent.i18n.errors.socialMessage.noTarget;if("exact"===this.get("dateType")){if(!NelioContent.helpers.isDate(this.get("dateValue")))return NelioContent.i18n.errors.datetime.invalidDate}else if(""===NelioContent.helpers.trim(this.get("dateValue")))return NelioContent.i18n.errors.datetime.noDate;if("exact"===this.get("timeType")){if(!NelioContent.helpers.isTime(this.get("timeValue")))return NelioContent.i18n.errors.datetime.invalidTime}else if(""===NelioContent.helpers.trim(this.get("timeValue")))return NelioContent.i18n.errors.datetime.noTime;var i,n;if("exact"===this.get("dateType")){if("exact"===this.get("timeType"))n=this.get("timeValue");else if("time-interval"===this.get("timeType"))switch(this.get("timeValue")){case"night":n="23:00";break;case"afternoon":n="19:00";break;case"noon":n="15:00";break;default:n="11:00"}else n="12:00";if(i=this.get("dateValue")+" "+n,i=ncNewLocalMoment(i),i.isBefore(ncNewLocalMoment()))return NelioContent.i18n.errors.datetime.noPastAllowed}return!(0!==this.post.get("id")&&!this.post.isPublished()||"0"!==this.get("dateValue")||"exact"!==this.get("timeType")||(i=ncNewLocalMoment().format("YYYY-MM-DD"),i=i+" "+this.get("timeValue"),i=ncNewLocalMoment(i),!ncNewLocalMoment().isAfter(i)))&&NelioContent.i18n.errors.datetime.noPastAllowed},reschedule:function(e){if(this.stopListening(this,"change:dateValue",this._fixSchedule),this.stopListening(this,"change:timeValue",this._fixSchedule),"exact"===this.get("dateType")){if(this.get("dateValue")===e)return void this.trigger("nc:abort:reschedule");this.set("dateValue",e);var t=this.get("schedule").format("HH:mm");this.set("schedule",e+" "+t)}else{var i=ncNewLocalMoment(this.get("schedule").format("YYYY-MM-DD")+"T12:00:00.000"),n=ncNewLocalMoment(e+"T12:00:00.000"),s=this.get("schedule").format("HH:mm"),o=n.diff(i,"d");if(0===o)return void this.trigger("nc:abort:reschedule");var a=parseInt(this.get("dateValue")),r=a+o;if(r<0)return void this.trigger("nc:abort:reschedule",{title:NelioContent.i18n.titles.invalidSocialScheduling,content:NelioContent.i18n.dialogs.invalidSocialScheduling});switch(r){case 0:this.set("dateType","predefined-offset"),this.set("dateValue","0");break;case 1:this.set("dateType","predefined-offset"),this.set("dateValue","1");break;default:this.set("dateType","positive-days"),this.set("dateValue",""+r)}0===a&&"exact"!==this.get("timeType")&&"time-interval"!==this.get("timeType")&&(this.set("timeType","exact"),this.set("timeValue",s)),this.get("schedule").add(o,"d")}this.set("baseDatetime","reschedule"),this.save(void 0,{success:function(e,t){e.set(t),e._setBaseDatetime(),e.trigger("nc:reschedule")},error:function(e){e.trigger("nc:error")}}),this.listenTo(this,"change:dateValue",this._fixSchedule),this.listenTo(this,"change:timeValue",this._fixSchedule)},shareNow:function(){if("error"!==this.get("status"))return void this.trigger("nc:error");this.set("status","_awaitingEnqueueConfirmation");var t=this;e.ajax({url:NelioContent.apiUri+"/social/"+this.get("id")+"/retry",method:"PUT",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){"schedule"===e.status&&(e.status="_enqueued"),t.set(e)},error:function(){t.set("status","_awaitingEnqueueConfirmation"),t.trigger("nc:error")}})},getHighlightedText:function(){var e=" "+this.get("textComputed")+" ";return e=e.replace(/\r\n/g,"\n"),e=e.replace(/\n/g," \n "),e=_.escape(e),e=e.replace(/ (https?:\/\/[^ ]+)/g,' <a class="nc-link">$1</a>'),e=e.replace(twttr.txt.regexen.validHashtag,' <span class="nc-hash">#$3</span>'),e=e.replace(/#([0-9]+)/g,' <span class="nc-num-hash">#$1</span>'),e=e.replace(twttr.txt.regexen.validMentionOrList,' <span class="nc-mention">@$3</span>'),e=e.replace(/ \n /g,"\n"),e=e.replace(/\n/g,"<br>"),e=e.substring(1,e.length-1)},_updateMaxTextLength:function(){if(this._maxTextLength=1/0,this.isNew()&&this.get("profiles").length>0){var e=this;this.get("profiles");_.each(NelioContent.networkMetas,function(t){var i=!1;_.each(e.get("profiles"),function(n){i||(n=NelioContent.profiles.get(n.id),"undefined"!=typeof n&&n.get("network")===t.id&&(i=!0,t.maxLength<e._maxTextLength&&(e._maxTextLength=t.maxLength)))})})}if(1/0===this._maxTextLength){var t=_.findWhere(NelioContent.networkMetas,{id:this.get("network")});"undefined"!=typeof t&&(this._maxTextLength=t.maxLength)}1/0===this._maxTextLength&&(this._maxTextLength=NelioContent.networkMetas[0].maxLength)},_fixProfileInformation:function(){var e=NelioContent.profiles.get(this.get("profileId"));"undefined"!=typeof e&&(this.set("network",e.get("network")),this.set("networkKind",e.get("kind")))},_computeText:function(){var e=this.get("text");0===this.get("postId")?this.set("textComputed",e):this.post.get("id")>0&&(e=e.replace(/\{title\}/g,this.post.get("title")),e=e.replace(/\{permalink\}/g,this.post.get("permalink")),this.set("textComputed",e)),this._extractRelevantUrl()},_extractRelevantUrl:function(){var e=" "+this.get("text");e=e.replace(/\n/g,"\n "),e=e.replace(/\{title\}/g,this.post.get("title")),e=e.replace(/\{permalink\}/g,this.post.get("permalink"));var t=e.match(/ (https?:\/\/[^ ]+)/g);if(null===t)return void this.set("url","");var i="";switch(this.get("network")){case"twitter":i=t[t.length-1];break;default:i=t[0]}this.set("url",NelioContent.helpers.trim(i))},_fixSchedule:function(){if("publish"!==this.get("status")&&(!(this.get("postId")>0)||this.post.isPublished()||this.post.isScheduled())){var e;e=0===this.get("postId")||this.post.isPublished()?ncNewLocalMoment():this.post.get("date").clone();var t="";if("exact"===this.get("dateType")?t=this.get("dateValue"):(e.add(this.get("dateValue"),"d"),t=e.format("YYYY-MM-DD")),NelioContent.helpers.isDate(t))if("exact"===this.get("timeType")){if(!NelioContent.helpers.isTime(this.get("timeValue")))return;t+=" "+this.get("timeValue"),this.set("schedule",ncNewLocalMoment(t))}else if("time-interval"===this.get("timeType")){var i="08:00";switch(this.get("timeValue")){case"morning":i="09:00";break;case"noon":i="13:00";break;case"afternoon":i="17:00";break;case"night":i="21:00"}t+=" "+i,this.set("schedule",ncNewLocalMoment(t))}else e.add(this.get("timeValue"),"h"),this.set("schedule",e)}},_fixScheduleFormat:function(){var e=this.get("schedule");"string"==typeof e&&this.set("schedule",ncNewLocalMoment(e));
},_setBaseDatetime:function(){0===this.post.get("id")||this.post.isPublished()?"exact"===this.get("dateType")?this.set("baseDatetime","none"):this.set("baseDatetime","now"):this.post.isScheduled()?"exact"===this.get("dateType")?this.set("baseDatetime","none"):this.set("baseDatetime",this.post.get("date").clone()):this.set("baseDatetime","none")},_setDefaultText:function(){var e=NelioContent.helpers.trim(this.get("text")),t=this.get("postId");t>0&&(0===e.length?this.set("text","{title} {permalink}"):e.indexOf("{permalink}")===-1&&this.set("text",e+" {permalink}"))}}),NelioContent.models.Reference=Backbone.Model.extend({_lastMatchingRegExp:void 0,_regExps:[],defaults:{id:"",title:"",titleFormatted:"",url:"",urlFormatted:"",date:"",author:"",email:"",twitter:"",isInPostContent:!1,status:"pending",suggestionAdvisorDisplayName:"",suggestionAdvisorId:-1,suggestionDate:"",isExternal:!0},initialize:function(){this._lastMatchingRegExp=/a^/,this._generateRegExps(),this.listenTo(this,"change:url",this._generateRegExps),this.listenTo(this,"change",this._escapeFields),this._escapeFields()},isSomethingMissing:function(){var e=this.get("url");if("undefined"==typeof e||0===NelioContent.helpers.trim(e).length)return NelioContent.i18n.errors.reference.noUrl;var t=this.get("twitter");if("string"==typeof t&&(t=NelioContent.helpers.trim(t),t.length>=2&&"@"!==t.substr(0,1)))return NelioContent.i18n.errors.reference.invalidTwitter;var i=this.get("email");if("string"==typeof i&&(i=NelioContent.helpers.trim(i).toUpperCase(),i.length>0)){var n=/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/;if(!n.test(i))return NelioContent.i18n.errors.reference.invalidMail}return!1},testIfIsInPostContent:function(e){this.get("url");if(this._lastMatchingRegExp.test(e))return void this.set("isInPostContent",!0);var t=!1;_.each(this._regExps,function(i){if(i.test(e))return t=!0,void(this._lastMatchingRegExp=i)},this),this.set("isInPostContent",t)},autoload:function(){var t=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_autoload_reference",url:this.get("url")},success:function(e){t.set(e)}})},_generateRegExps:function(){var e=this.get("url");if(0===e.length)this._regExps=[];else{var t=_.escape(e);this._regExps=[new RegExp('"'+e+'"',"i"),new RegExp('"'+t+'"',"i"),new RegExp("'"+e+"'","i"),new RegExp("'"+t+"'","i")]}},_escapeFields:function(){_.each(["author","url","title"],function(e){this.set(e+"Escaped",_.escape(this.get(e)))},this)}}),NelioContent.collections.References=Backbone.Collection.extend({model:NelioContent.models.Reference,post:new NelioContent.models.Post,initialize:function(){this.listenTo(this,"reset",this._onReset)},suggestReference:function(t){if("undefined"==typeof this.get(t.id)){var i=NelioContent.users.current();"function"==typeof t.set?t.get("suggestionAdvisorId")===-1&&(t.set("suggestionAdvisorDisplayName",i.get("name")),t.set("suggestionAdvisorId",i.get("id"))):"undefined"!=typeof t.suggestionAdvisorId&&t.suggestionAdvisorId!==-1||(t.suggestionAdvisorDisplayName=i.get("name"),t.suggestionAdvisorId=i.get("id")),t=this.add(t),this.listenTo(t,"nc:discard",this.discardReference);var n=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_suggest_post_reference",post:this.post.get("id"),url:t.get("url")},success:function(e){t.set(e)},error:function(e){var i=NelioContent.i18n.errors.reference.notSuggested+" "+e.responseJSON;NelioContent.helpers.openErrorDialog(i),n.remove(t)}})}},discardReference:function(t){var i=t.get("status");t.set("status","_discarding");var n=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_discard_post_reference",post:this.post.get("id"),reference:t.get("postId")},success:function(e){n.remove(t)},error:function(e){var t=NelioContent.i18n.errors.reference.notDiscarded+" "+e.responseJSON;NelioContent.helpers.openErrorDialog(t),this.set("status",i)}})},_onReset:function(e,t){_.each(t.previousModels,function(e){this.stopListening(e)},this),this.each(function(e){this.listenTo(e,"nc:discard",this.discardReference),"pending"===e.get("status")&&e.autoload()},this)},setPost:function(e){this.post=e}}),NelioContent.models.LinkInPost=Backbone.Model.extend({defaults:{id:"",urlFormatted:"",isBroken:!1}}),NelioContent.collections.LinksInPost=Backbone.Collection.extend({model:NelioContent.models.LinkInPost,post:new NelioContent.models.Post,setPost:function(e){this.post=e}}),NelioContent.models.EditorialComment=NelioContent.models.Model.extend({urlRoot:NelioContent.apiUri+"/comment",defaults:function(){return{comment:"",date:ncNewLocalMoment(),authorId:NelioContent.users.current().get("id"),postId:0,postType:NelioContent.postTypes[0].name}},initialize:function(){this.listenTo(this,"change:date",this._fixDateFormat),this._fixDateFormat()},_fixDateFormat:function(){var e=this.get("date");"string"==typeof e&&this.set("date",ncNewLocalMoment(e))}}),NelioContent.collections.EditorialComments=NelioContent.collections.Collection.extend({model:NelioContent.models.EditorialComment,post:void 0,initialize:function(){this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},setPost:function(e){this.post=e,this.each(function(e){e.set("postId",this.post.get("id")),e.set("postType",this.post.get("type"))},this)},_onAdd:function(e){this.listenTo(e,"destroy",this.remove),e.set("postId",this.post.get("id")),e.set("postType",this.post.get("type"))},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this)}}),NelioContent.models.EditorialTask=NelioContent.models.Model.extend({urlRoot:NelioContent.apiUri+"/task",defaults:function(){return{task:"",completed:!1,calendarKind:"task",postId:0,postType:NelioContent.postTypes[0].name,baseDatetime:"none",dateDue:ncNewLocalMoment(),dateType:"predefined-offset",dateValue:"0",timezone:NelioContent.i18n.timezone,assignerId:NelioContent.users.current().get("id"),assigneeId:NelioContent.users.current().get("id")}},post:new NelioContent.models.Post,initialize:function(){this.listenTo(this,"change:dateDue",this._fixDateDueFormat),this._fixDateDueFormat()},setPost:function(e){this.stopListening(this.post),this.post=e,this.set("postId",this.post.get("id")),this.set("postType",this.post.get("type")),this._setBaseDatetime(),this.listenTo(this.post,"change:dateType",this._setBaseDatetime)},isSomethingMissing:function(){return NelioContent.helpers.trim(this.get("task"))<=0?NelioContent.i18n.errors.task.noTask:""===NelioContent.helpers.trim(this.get("dateValue"))?NelioContent.i18n.errors.datetime.noDate:"exact"===this.get("dateType")&&!NelioContent.helpers.isDate(this.get("dateValue"))&&NelioContent.i18n.errors.datetime.invalidDate},getDateForSorting:function(){var e="";if(this.post.isPublished()||this.post.isScheduled()){var t=this.get("dateDue");"string"==typeof t&&(t=ncNewLocalMoment(t)),e+=t.toISOString()}else if("exact"===this.get("dateType"))e+=this.get("dateValue");else{var i="Z0000000"+this.get("dateValue");e+=i.substr(i.length-6)}return e},getRelevantDay:function(){return this.get("dateDue").format("YYYY-MM-DD")},reschedule:function(e){if("exact"===this.get("dateType")){if(this.get("dateValue")===e)return void this.trigger("nc:abort:reschedule");this.set("dateValue",e),this.set("dateDue",ncNewLocalMoment(e+"T12:00:00.000"))}else{var t=ncNewLocalMoment(this.get("dateDue").format("YYYY-MM-DD")+"T12:00:00.000"),i=ncNewLocalMoment(e+"T12:00:00.000"),n=i.diff(t,"d");if(0===n)return void this.trigger("nc:abort:reschedule");var s=parseInt(this.get("dateValue"));"negative-days"===this.get("dateType")&&(s=-s);var o=s+n;t.format("HH:mm");o>0?(this.set("dateType","positive-days"),this.set("dateValue",""+o)):o<0?(this.set("dateType","negative-days"),this.set("dateValue",""+Math.abs(o))):(this.set("dateType","predefined-offset"),this.set("dateValue","0")),this.get("dateDue").add(n,"d")}this.set("baseDatetime","reschedule"),this.save(void 0,{success:function(e,t){e.set(t),e._setBaseDatetime(),e.trigger("nc:reschedule")},error:function(e){e.trigger("nc:error")}})},_fixDateDueFormat:function(){var e=this.get("dateDue");"string"==typeof e&&this.set("dateDue",ncNewLocalMoment(e))},_setBaseDatetime:function(){0===this.post.get("id")||this.post.isPublished()?"exact"===this.get("dateType")?this.set("baseDatetime","none"):this.set("baseDatetime","now"):this.post.isScheduled()?"exact"===this.get("dateType")?this.set("baseDatetime","none"):this.set("baseDatetime",this.post.get("date").clone()):this.set("baseDatetime","none")}}),NelioContent.collections.EditorialTasks=NelioContent.collections.Collection.extend({model:NelioContent.models.EditorialTask,post:void 0,initialize:function(){this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},setPost:function(e){this.post=e,this.each(function(e){e.set("postId",this.post.get("id")),e.set("postType",this.post.get("type"))},this)},_triggerModelChange:function(e){this.trigger("nc:change:model",this,e)},_onAdd:function(e){this.listenTo(e,"change",this._triggerModelChange),this.listenTo(e,"destroy",this.remove),e.set("postId",this.post.get("id")),e.set("postType",this.post.get("type"))},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this)}}),NelioContent.collections.MonthlyCalendarItems=NelioContent.collections.Collection.extend({_isLoading:!1,_today:void 0,_firstDayInCalendar:void 0,_lastDayInCalendar:void 0,_firstDayOfMonth:void 0,_postAjaxRequest:void 0,_awsItemAjaxRequest:void 0,model:function(e,t){switch(e.calendarKind){case"post":return new NelioContent.models.Post(e,t);case"social":return new NelioContent.models.SocialMessage(e,t);case"task":return new NelioContent.models.EditorialTask(e,t)}},initialize:function(e,t){this._doLoadItemsDebounced=_.debounce(this._doLoadItems,500),this.refresh=_.bind(this.refresh,this),this._today=ncNewLocalMoment(),this._firstDayOfMonth=this._today;var i=this._firstDayOfMonth;"object"==typeof t&&"string"==typeof t.date&&(/^[12][01][0-9][0-9]-[01][0-9]-[0123][0-9]$/.test(t.date)?i=t.date:/^[2][01][0-9][0-9]-[0-1][0-9]$/.test(t.date)&&(i=t.date+"-10")),this.gotoDate(i),this.listenTo(this,"nc:change:date",this._loadItems),this._isLoading=!0,this._doLoadItems()},getFirstDay:function(){return this._firstDayInCalendar.clone()},getLastDay:function(){return this._firstDayInCalendar.clone().add(41,"d")},getToday:function(){return this._today.clone()},getFirstDayOfMonth:function(){return this._firstDayOfMonth.clone()},gotoDate:function(e){switch(typeof e){case"object":this._firstDayOfMonth=ncLocalizeMoment(e.clone());break;case"undefined":this._firstDayOfMonth=ncNewLocalMoment();break;default:this._firstDayOfMonth=ncNewLocalMoment(e)}var t=this._firstDayOfMonth.clone();t.date(1),t.hours(0),t.minutes(0),t.seconds(0),t.milliseconds(0),this._firstDayOfMonth=t.clone();for(var i=this._firstDayOfMonth.clone().startOf("week").format("d");t.format("d")!=i;)t.add(-1,"d");if(this._firstDayInCalendar=t.clone(),t.add(6,"w"),t.add(-1,"ms"),this._lastDayInCalendar=t.clone(),"undefined"!=typeof history&&"function"==typeof history.replaceState){var n=window.location.href;n=n.replace(/\bdate=([12][01][0-9][0-9]-[01][0-9](-[0123][0-9])?)\b/,""),n=n.replace(/\?$/,""),n=n.replace(/\&$/,""),n+=n.indexOf("?")===-1?"?":"&",n+="date="+this._firstDayOfMonth.format("YYYY-MM"),history.replaceState(null,null,n)}this.reset([]),this.trigger("nc:reset:empty"),this.trigger("nc:reset"),this.trigger("nc:change:date")},prevMonth:function(){this._firstDayInCalendar.add(-2,"w"),this.gotoDate(this._firstDayInCalendar)},nextMonth:function(){this._firstDayInCalendar.add(8,"w"),this.gotoDate(this._firstDayInCalendar)},isTodayVisible:function(){return this._today.month()===this._firstDayOfMonth.month()&&this._today.year()===this._firstDayOfMonth.year()},refresh:function(){this._isLoading=!0,this.trigger("nc:change:isLoading",!0),this._doLoadItems()},isLoading:function(){return this._isLoading},toCSV:function(){var t=[];this.each(function(e){var i=e.toJSON();switch(e.get("calendarKind")){case"social":i.date=e.get("schedule").format("YYYY-MM-DD"),i.time=e.get("schedule").format("HH:mm"),i.sort=e.get("schedule").format("YYYY-MM-DD")+"1"+e.get("schedule").format("HH:mm")+"1"+i.textComputed;break;case"task":i.date=e.get("dateDue").format("YYYY-MM-DD"),i.time="",i.sort=e.get("dateDue").format("YYYY-MM-DD")+"0"+i.task;break;default:i.date=e.get("date").format("YYYY-MM-DD"),i.time=e.get("date").format("HH:mm"),i.sort=e.get("date").format("YYYY-MM-DD")+"1"+e.get("date").format("HH:mm")+"0"+i.title}t.push(i)}),t=t.sort(function(e,t){return e.sort<t.sort?-1:e.sort>t.sort?1:0});var i=this.getFirstDayOfMonth(),n=this.getFirstDayOfMonth().add(1,"month");t=_.filter(t,function(e){var t=ncNewLocalMoment(e.date+" 10:00");return i.isBefore(t)&&t.isBefore(n)});var s,o={};s=_.filter(t,function(e){return"post"!==e.calendarKind&&e.postId>0}),s=_.uniq(_.pluck(s,"postId"));var a=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_get_post_permalinks",posts:s},success:function(e){o=e},complete:function(){a.trigger("nc:download:csv",a._genCSV(t,o))}})},_genCSV:function(e,t){var i='"Date","Time","Type","Author/Profile/Assignee","Title/Text/Task","Permalink","Status"\n';return _.each(e,function(e){switch(e.calendarKind){case"social":i+='"'+e.date+'",',i+='"'+e.time+'",',i+='"'+NelioContent.helpers.capitalizeFirstLetter(e.network)+'",',i+='"'+NelioContent.profiles.get(e.profileId).get("username")+'",',i+='"'+e.textComputed.replace(/"/g,'""')+'",',i+='"'+(t[e.postId]||"N/A")+'",',i+='"'+e.status+'"';break;case"task":i+='"'+e.date+'",',i+='"'+e.time+'",',i+='"Editorial Task",',i+='"'+NelioContent.users.get(e.assigneeId).get("name")+'",',i+='"'+e.task.replace(/"/g,'""')+'",',i+='"'+(t[e.postId]||"N/A")+'",',i+='"'+(e.completed?"done":"pending")+'"';break;default:var n=_.findWhere(NelioContent.postTypes,{name:e.type});n="undefined"!=typeof n?n.labels.singular:e.type,i+='"'+e.date+'",',i+='"'+e.time+'",',i+='"WordPress '+n+'",',i+='"'+NelioContent.users.get(e.author).get("name")+'",',i+='"'+e.title.replace(/"/g,'""')+'",',i+='"'+e.permalink+'",',i+='"'+e.status+'"'}i+="\n"}),i.replace(/\n$/,"")},_loadItems:function(){"undefined"!=typeof this._postAjaxRequest&&this._postAjaxRequest.abort(),"undefined"!=typeof this._awsItemAjaxRequest&&this._awsItemAjaxRequest.abort(),this._isLoading=!0,this.trigger("nc:change:isLoading",!0),this._doLoadItemsDebounced()},_doLoadItems:function(){var t=this,i=[];this._postAjaxRequest=e.ajax({url:ajaxurl,data:{action:"nelio_content_get_monthly_posts",start:this.getFirstDay().format("YYYY-MM-DD"),end:this.getLastDay().format("YYYY-MM-DD")},success:function(e){i=_.union(i,e)}}),this._awsItemAjaxRequest=e.ajax({url:NelioContent.apiUri+"/calendar",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},data:{from:this.getFirstDay().clone().add(-1,"d").format("YYYY-MM-DD"),to:this.getLastDay().clone().add(1,"d").format("YYYY-MM-DD")},success:function(e){var t=[];_.each(e.social,function(e){e.calendarKind="social",t.push(e)}),_.each(e.tasks,function(e){e.calendarKind="task",t.push(e)}),i=_.union(i,t)},error:function(e){NelioContent.helpers.openErrorDialog(NelioContent.i18n.errors.api.unableToRetrieveCalendar)}}),t._postAjaxRequest.always(function(){t._awsItemAjaxRequest.always(function(){t._postAjaxRequest=void 0,t._awsItemAjaxRequest=void 0,t.reset(i),t.trigger("nc:reset:items"),t.trigger("nc:reset"),t._isLoading=!1,t.trigger("nc:change:isLoading")})})}}),NelioContent.collections.SocialTimeline=NelioContent.collections.Collection.extend({model:NelioContent.models.SocialMessage,post:void 0,initialize:function(){this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},getDisabledProfileIds:function(){return NelioContent.helpers.isSubscribed()?[]:_.uniq(this.pluck("profileId"))},setPost:function(e){this.post=e,this.each(function(e){e.setPost(this.post)},this)},_onAdd:function(e){this.listenTo(e,"destroy",this.remove),e.setPost(this.post)},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this)}}),"object"==typeof NelioContent.lastPublishedPost&&(NelioContent.lastPublishedPost=new NelioContent.models.Post(NelioContent.lastPublishedPost))}(jQuery);