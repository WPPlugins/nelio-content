!function(t){"use strict";function e(){t.ajax({url:ajaxurl,data:{action:"nelio_content_ignore_free_trial",days:7}})}document.getElementById("_nc-free-trial-dialog")&&(NelioContent.views.FreeTrialDialog=Backbone.View.extend({_buttons:void 0,_mode:"hello",_trialPlan:!1,_timeoutSeconds:5,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-free-trial-dialog").innerHTML)),events:{"keyup .nc-firstname":"_onFormChanged","keyup .nc-lastname":"_onFormChanged","keyup .nc-email":"_onFormChanged","change .nc-firstname":"_onFormChanged","change .nc-lastname":"_onFormChanged","change .nc-email":"_onFormChanged"},initialize:function(t){"object"!=typeof t&&(t={}),"string"!=typeof t.mode&&(t.mode="hello"),"string"!=typeof t.trialPlan&&(t.trialPlan=!1),this._mode=t.mode,this._trialPlan=t.trialPlan,this.render=_.bind(this.render,this),this._maybeEnableStartButtonDebounced=_.debounce(this._maybeEnableStartButton,350),this._buttons={},this.model=new Backbone.Model,this.listenTo(this,"nc:close:dialog",this.close),this._convertToDialog()},render:function(){switch(this.el.innerHTML=this.template({mode:this._mode}),this.$el.dialog("open"),this._buttons.$ignore.hide(),this._buttons.$postpone.hide(),this._buttons.$next.hide(),this._buttons.$cancel.hide(),this._buttons.$start.hide(),this._mode){case"form":this.$el.closest(".nc-free-trial-dialog").addClass("nc-no-image"),this._buttons.$cancel.show(),this._buttons.$start.show(),this._maybeEnableStartButton();break;default:this.$el.closest(".nc-free-trial-dialog").removeClass("nc-no-image"),this._buttons.$ignore.show(),this._buttons.$postpone.show(),this._buttons.$next.show()}return this},_lock:function(){this.$("*").attr("disabled","disabled"),this.$el.addClass("nc-locked")},_unlock:function(){this.$("*").removeAttr("disabled"),this.$el.removeClass("nc-locked")},_convertToDialog:function(){var t=[];t.push(NelioContent.helpers.makeDialogButton(this,"ignore",NelioContent.i18n.actions.ignore)),t.push(NelioContent.helpers.makeDialogButton(this,"postpone",NelioContent.i18n.actions.postpone)),t.push(NelioContent.helpers.makeDialogButton(this,"cancel",NelioContent.i18n.actions.cancel)),t.push(NelioContent.helpers.makeDialogButton(this,"next","",!0)),t.push(NelioContent.helpers.makeDialogButton(this,"start",NelioContent.i18n.actions.start,!0));var e=this;this.$el.dialog({title:NelioContent.i18n.titles.freeTrial,autoOpen:!1,buttons:t,closeOnEscape:!1,dialogClass:"nc-dialog nc-free-trial-dialog",draggable:!1,modal:!0,resizable:!1,width:"95%",position:{my:"center bottom",at:"center center"},open:function(){function t(){"undefined"!=typeof e._buttons&&(e._timeoutSeconds>0?(e._buttons.$next.html(NelioContent.i18n.feedback.waitSeconds[e._timeoutSeconds]),setTimeout(t,1e3)):(e._buttons.$next.html(NelioContent.i18n.actions["continue"]),e._buttons.$ignore.prop("disabled",!1),e._buttons.$postpone.prop("disabled",!1),e._buttons.$next.prop("disabled",!1)),--e._timeoutSeconds)}e.$el.parent().find(".ui-dialog-titlebar-close").detach(),e.listenTo(e,"nc:click:dialog:ignore",e._ignore),e.listenTo(e,"nc:click:dialog:postpone",e._postpone),e.listenTo(e,"nc:click:dialog:next",e._onDialogNext),e.listenTo(e,"nc:click:dialog:cancel",e._postpone),e.listenTo(e,"nc:click:dialog:start",e._onDialogStart),e._buttons.$postpone=e.$el.parent().find("button.nc-postpone-button"),e._buttons.$ignore=e.$el.parent().find("button.nc-ignore-button"),e._buttons.$next=e.$el.parent().find("button.nc-next-button"),e._buttons.$cancel=e.$el.parent().find("button.nc-cancel-button"),e._buttons.$start=e.$el.parent().find("button.nc-start-button"),e._buttons.$cancel.hide(),e._buttons.$start.hide(),e._buttons.$ignore.addClass("nc-delete-button"),e._buttons.$ignore.prop("disabled",!0),e._buttons.$postpone.prop("disabled",!0),e._buttons.$next.prop("disabled",!0),t(),NelioContent.helpers.makeWarningTooltip(e._buttons.$start)},close:function(t,n){e.stopListening(e,"nc:click:dialog:ignore",e._ignore),e.stopListening(e,"nc:click:dialog:postpone",e._postpone),e.stopListening(e,"nc:click:dialog:next",e._onDialogNext),e.stopListening(e,"nc:click:dialog:cancel",e._postpone),e.stopListening(e,"nc:click:dialog:start",e._onDialogStart),e._buttons.$start.tooltip("destroy"),e._buttons=void 0,e.$el.dialog("destroy"),e.trigger("nc:close:dialog")}})},_maybeEnableStartButton:function(){var t=this.$(".nc-firstname").val(),e=this.$(".nc-lastname").val(),n=this.$(".nc-email").val();return NelioContent.helpers.trim(t).length?NelioContent.helpers.trim(e).length?NelioContent.helpers.trim(n).length?NelioContent.helpers.isEmail(n)?(this._buttons.$start.attr("title",""),void this._buttons.$start.removeClass("button-disabled")):(this._buttons.$start.addClass("button-disabled"),void this._buttons.$start.attr("title",NelioContent.i18n.errors.freeTrial.invalidEmail)):(this._buttons.$start.addClass("button-disabled"),void this._buttons.$start.attr("title",NelioContent.i18n.errors.freeTrial.noEmail)):(this._buttons.$start.addClass("button-disabled"),void this._buttons.$start.attr("title",NelioContent.i18n.errors.freeTrial.noLastName)):(this._buttons.$start.addClass("button-disabled"),void this._buttons.$start.attr("title",NelioContent.i18n.errors.freeTrial.noFirstName))},_onFormChanged:function(){this._maybeEnableStartButtonDebounced()},_onDialogStart:function(){this.$("input").prop("disabled",!0),this._buttons.$cancel.prop("disabled",!0),this._buttons.$start.prop("disabled",!0),this._buttons.$start.html(NelioContent.i18n.feedback.starting);var e=this;t.ajax({url:NelioContent.apiUri+"/subscription/trial",data:JSON.stringify({firstname:NelioContent.helpers.trim(this.$(".nc-firstname").val()),lastname:NelioContent.helpers.trim(this.$(".nc-lastname").val()),email:NelioContent.helpers.trim(this.$(".nc-email").val()),product:e._trialPlan}),method:"POST",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(t){window.location.href=NelioContent.pages.account},error:function(t){e.$el.dialog("close"),NelioContent.helpers.openErrorDialog(NelioContent.i18n.errors.freeTrial.unableToStart.replace("{error}",t.responseJSON.errorMessage))}})},_onDialogNext:function(){this._mode="form",this.render()},_postpone:function(){t.ajax({url:ajaxurl,data:{action:"nelio_content_ignore_free_trial",days:7}}),this.$el.dialog("close")},_ignore:function(){t.ajax({url:ajaxurl,data:{action:"nelio_content_ignore_free_trial",days:90}}),this.$el.dialog("close")},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}})),NelioContent.freeTrialOption&&t.ajax({url:NelioContent.apiUri+"/subscription/trial",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(t){if(!t.availability)return void e();var n=new NelioContent.views.FreeTrialDialog({trialPlan:NelioContent.freeTrialOption});n.render()},error:e})}(jQuery);