!function(e){"use strict";NelioContent.views.PostEditor=Backbone.View.extend({_views:{author:void 0},_suggestedReference:"",_firstEditorialComment:"",_isDatePickerReady:!1,_buttons:void 0,_labels:void 0,_regex:{url:/^(https?:\/\/)?([\da-z\.-]+)\.([a-z]{2,6})(\/[^\/\s]+)*\/?$/i,date:/[12][0-9][0-9][0-9]-[01][0-9]-[0-3][0-9]/,time:/[012][0-9]:[0-5][0-9]/},_originalValues:void 0,model:NelioContent.models.Post,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-post-editor").innerHTML)),events:{"change .nc-title":"_onTitleChange","keyup .nc-title":"_onTitleChange","click  .nc-date .nc-value":"_maybeInitDatePicker","change .nc-date":"_onDateChange","change .nc-time":"_onTimeChange","change .nc-post-type":"_onPostTypeChange","keyup .nc-post-type":"_onPostTypeChange","click .nc-toggle-editor-visibility":"_toggleEditorInformationVisibility","change .nc-suggested-reference input":"_onSuggestedReferenceChange","keyup .nc-suggested-reference input":"_onSuggestedReferenceChange","change .nc-initial-comment textarea":"_onFirstEditorialCommentChange","keyup .nc-initial-comment textarea":"_onFirstEditorialCommentChange"},initialize:function(e){if("object"!=typeof e&&(e={}),"string"!=typeof e.date&&(e.date=ncNewLocalMoment().format("YYYY-MM-DD")),this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this._onDialogDelete=_.bind(this._onDialogDelete,this),this._onDialogViewPost=_.bind(this._onDialogViewPost,this),this._onDialogEditPost=_.bind(this._onDialogEditPost,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:type",this._updateLabels),this._updateLabels(),0===this.model.get("id"))this.model.set("author",NelioContent.users.current().get("id")),this.model.set("localDate",e.date),this.model.set("localTime",ncstore.get("nc-default-post-time","10:00")),this.listenTo(this.model,"change",this._maybeEnableSaveButton),this.listenTo(this,"nc:change:suggestedReference",this._maybeEnableSaveButton),this.listenTo(this,"nc:change:firstEditorialComment",this._maybeEnableSaveButton);else{var t=this.model.get("date");this.model.set("localDate",t.format("YYYY-MM-DD")),this.model.set("localTime",t.format("HH:mm")),this._originalValues={title:this.model.get("title"),author:this.model.get("author"),date:this.model.get("localDate"),time:this.model.get("localTime")},this.listenTo(this.model,"change",this._showProperButtonSet),this.listenTo(this.model,"change",this._maybeEnableSaveButton)}this._views.author=new NelioContent.views.UserSelector({defaultValue:this.model.get("author")}),this.listenTo(this._views.author,"nc:change",this._onAuthorChange),this.listenTo(this,"nc:close:dialog",this.close),this._convertToDialog()},render:function(){var e=this.$(".nc-date .nc-value");"date"!==e.prop("type")&&(e.datepicker("destroy"),this._isDatePickerReady=!1);var t=this.model.toJSON();t.isEditorInformationVisible=ncstore.get("nc-is-calendar-editor-info-visible",!1),t.suggestedReference=this._suggestedReference,t.editorialComment=this._firstEditorialComment,t.today=ncNewLocalMoment().format("YYYY-MM-DD"),this._views.author.$el.detach(),this.el.innerHTML=this.template(t),this.$(".nc-post-type").val(t.type),this.$el.dialogS2("open"),this.$(".nc-author .nc-field").html(this._views.author.render().$el),this._views.author.$el.trigger("change");var i=NelioContent.users.current().get("role");return"administrator"===i||"editor"===i?this._views.author.unlock():this._views.author.lock(),this._maybeEnableSaveButton(),this},_lock:function(){this.$("*").attr("disabled","disabled"),this.$el.addClass("nc-locked")},_unlock:function(){this.$("*").removeAttr("disabled"),this.$el.removeClass("nc-locked")},_convertToDialog:function(){var e=[];0===this.model.get("id")?(e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,this._labels.addAction))):(e.push(NelioContent.helpers.makeDialogDeleteButton(this,NelioContent.i18n.actions.trash)),e.push(NelioContent.helpers.makeDialogButton(this,"close",NelioContent.i18n.actions.close)),e.push(NelioContent.helpers.makeDialogButton(this,"view",this._labels.viewAction)),e.push(NelioContent.helpers.makeDialogButton(this,"edit",this._labels.editAction,!0)),e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.saveChanges)));var t=this;this.$el.dialogS2({title:this.model.get("id")>0?this._labels.editTitle:this._labels.addTitle,autoOpen:!1,buttons:e,dialogClass:"nc-dialog nc-post-editor-dialog",draggable:!1,modal:!0,resizable:!1,width:"95%",position:{my:"center top",at:"center top+60"},open:function(){t.listenTo(t,"nc:click:dialog:save",t._onDialogSave),t.listenTo(t,"nc:click:dialog:cancel",t._onDialogCancel),t.listenTo(t,"nc:click:dialog:delete",t._onDialogDelete),t.listenTo(t,"nc:click:dialog:close",t._onDialogCancel),t.listenTo(t,"nc:click:dialog:view",t._onDialogViewPost),t.listenTo(t,"nc:click:dialog:edit",t._onDialogEditPost),t._buttons=t._buttons||{},t._buttons.edit=t.$el.parent().find("button.nc-edit-button"),t._buttons.view=t.$el.parent().find("button.nc-view-button"),t._buttons.close=t.$el.parent().find("button.nc-close-button"),t._buttons.cancel=t.$el.parent().find("button.nc-cancel-button"),t._buttons.save=t.$el.parent().find("button.nc-save-button"),NelioContent.helpers.makeWarningTooltip(t._buttons.save),t.model.get("id")>0&&(t._buttons.cancel.hide(),t._buttons.save.hide());var e=t.$el.parent().find("button.nc-delete-button");e.length>0&&e.blur()},close:function(e,i){t.stopListening(t,"nc:click:dialog:save",t._onDialogSave),t.stopListening(t,"nc:click:dialog:cancel",t._onDialogCancel),t.stopListening(t,"nc:click:dialog:delete",t._onDialogDelete),t._buttons.save.tooltip("destroy"),t.$el.dialogS2("destroy"),t.trigger("nc:close:dialog")}}),this.listenTo(this,"nc:change:labels",this._renderLabels)},_showProperButtonSet:function(){var e=!1;e=e||this.model.get("author")!==this._originalValues.author,e=e||this.model.get("title")!==this._originalValues.title,e=e||this.model.get("author")!==this._originalValues.author,e=e||this.model.get("localDate")!==this._originalValues.date,e=e||this.model.get("localTime")!==this._originalValues.time,e?(this._buttons.edit.hide(),this._buttons.view.hide(),this._buttons.close.hide(),this._buttons.cancel.show(),this._buttons.save.show()):(this._buttons.edit.show(),this._buttons.view.show(),this._buttons.close.show(),this._buttons.cancel.hide(),this._buttons.save.hide())},_maybeEnableSaveButton:function(){if("undefined"!=typeof this._buttons.save){if(this._buttons.save.tooltip("close"),0===NelioContent.helpers.trim(this.model.get("title")).length)return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.post.noTitle);if(0===NelioContent.helpers.trim(this.model.get("localDate")).length)return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.datetime.noDate);if(!this._regex.date.test(this.model.get("localDate")))return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.datetime.invalidDate);if(0===NelioContent.helpers.trim(this.model.get("localTime")).length)return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.datetime.noTime);if(!this._regex.time.test(this.model.get("localTime")))return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.datetime.invalidTime);if(this._suggestedReference.length>0&&!this._regex.url.test(this._suggestedReference))return this._buttons.save.addClass("button-disabled"),void this._buttons.save.attr("title",NelioContent.i18n.errors.post.invalidUrl);this._buttons.save.removeClass("button-disabled"),this._buttons.save.attr("title","")}},_updateLabels:function(){var e=this.model.get("type"),t=_.reduce(NelioContent.postTypes,function(t,i){return e===i.name?i:t});this._labels=t.labels,this.trigger("nc:change:labels")},_renderLabels:function(){var e=this.$el.parent();e.find(".ui-dialog-buttonpane button.nc-save-button").html(this._labels.addAction),e.find(".ui-dialog-buttonpane button.nc-view-button").html(this._labels.viewAction),e.find(".ui-dialog-titlebar .ui-dialog-title").html(this._labels.addTitle)},_onTitleChange:function(t){var i=t.target||t.srcElement,n=e(i);this.model.set("title",NelioContent.helpers.trim(n.val()))},_onPostTypeChange:function(t){var i=t.target||t.srcElement,n=e(i);this.model.set("type",n.val())},_onAuthorChange:function(e){this.model.set("author",parseInt(e))},_onDateChange:function(t){var i=t.target||t.srcElement,n=e(i);this.model.set("localDate",NelioContent.helpers.trim(n.val()))},_onTimeChange:function(t){var i=t.target||t.srcElement,n=e(i);this.model.set("localTime",NelioContent.helpers.trim(n.val()))},_onSuggestedReferenceChange:function(t){var i=t.target||t.srcElement,n=e(i);this._suggestedReference=n.val(),this.trigger("nc:change:suggestedReference",this._suggestedReference)},_onFirstEditorialCommentChange:function(t){var i=t.target||t.srcElement,n=e(i);this._firstEditorialComment=n.val(),this.trigger("nc:change:firstEditorialComment",this._firstEditorialComment)},_toggleEditorInformationVisibility:function(){var e=ncstore.get("nc-is-calendar-editor-info-visible",!1);ncstore.set("nc-is-calendar-editor-info-visible",!e),this.trigger("nc:render")},_onDialogSave:function(){var t=this.$el.parent(),i=t.find(".ui-dialog-buttonpane button.nc-save-button"),n=t.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .nc-save-button )");if(!i.hasClass("button-disabled")){this._lock(),this.$el.dialogS2("option","closeOnEscape",!1),i.prop("disabled",!0),n.prop("disabled",!0),0===this.model.get("id")?i.html(NelioContent.i18n.feedback.creating):i.html(NelioContent.i18n.feedback.saving);var o={title:this.model.get("title"),author:this.model.get("author"),localDatetime:this.model.get("localDate")+" "+this.model.get("localTime"),postType:this.model.get("type")};0===this.model.get("id")?(o.action="nelio_content_create_post_in_calendar",o.reference=NelioContent.helpers.trim(this._suggestedReference),o.comment=NelioContent.helpers.trim(this._firstEditorialComment)):(o.action="nelio_content_update_post_in_calendar",o.post=this.model.get("id"));var s=this;e.ajax({url:ajaxurl,method:"POST",data:o,success:function(e){if("object"==typeof e){var t=new NelioContent.models.Post(e);s.model.set(t.toJSON())}ncstore.set("nc-default-post-time",s.model.get("localTime")),s.trigger("nc:save:post",s.model),s.$el.dialogS2("close")},error:function(e){NelioContent.helpers.openErrorDialog(e.responseJSON),i.prop("disabled",!1),n.prop("disabled",!1),0===s.model.get("id")?i.html(s._labels.addAction):i.html(NelioContent.i18n.actions.save),s.$el.dialogS2("option","closeOnEscape",!0),s._unlock()}})}},_onDialogCancel:function(){this.$el.dialogS2("close")},_onDialogDelete:function(){var e=this,t=NelioContent.i18n.titles.trashPost,i=NelioContent.i18n.dialogs.trashPost,n=NelioContent.i18n.actions.doTrashPost;"post"!==this.model.get("type")&&(t=NelioContent.i18n.titles.trashElement,i=NelioContent.i18n.dialogs.trashElement,n=NelioContent.i18n.actions.doTrashElement);var o=NelioContent.helpers.openDeletionConfirmationDialog(t,i,n,function(){var t=o.parent();t.find(".nc-super-delete-button").html(NelioContent.i18n.feedback.trashing),t.find("button").prop("disabled",!0),e.listenTo(e.model,"nc:trash",function(){o.dialog("destroy"),e.trigger("nc:trash:post"),e.$el.dialogS2("close")}),e.model.trash()})},_onDialogViewPost:function(e){e.ctrlKey||2===e.which?window.open(this.model.get("permalink")):window.document.location.href=this.model.get("permalink")},_onDialogEditPost:function(e){e.ctrlKey||2===e.which?window.open(this.model.get("editLink")):window.document.location.href=this.model.get("editLink")},_maybeInitDatePicker:function(e){var t=this.$(".nc-date .nc-value");this._isDatePickerReady||"date"===t.prop("type")||(t.datepicker({dateFormat:"yy-mm-dd",minDate:0}),t.datepicker("show")),this._isDatePickerReady=!0},close:function(){for(var e in this._views)if(this._views.hasOwnProperty(e)){var t=this._views[e];"object"==typeof t&&t.close()}this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.TaskDialog=Backbone.View.extend({_views:{assignee:void 0},_$saveButton:void 0,_regex:{date:/[12][0-9][0-9][0-9]-[01][0-9]-[0-3][0-9]/,number:/[0-9]+/},model:NelioContent.models.EditorialTask,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-task-dialog").innerHTML)),events:{"change .nc-task-description":"_onTaskChange","keyup .nc-task-description":"_onTaskChange","change .nc-date":"_onDateChange"},initialize:function(e){"object"!=typeof e&&(e={}),"string"!=typeof e.date&&(e.date=ncNewLocalMoment().format("YYYY-MM-DD")),this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this._maybeEnableSaveButton),this.model.set("dateType","exact"),this.model.set("dateValue",e.date),NelioContent.helpers.isSubscribedTo("team-plan")?this._views.assignee=new NelioContent.views.UserSelector({defaultValue:this.model.get("assigneeId")}):this._views.assignee=new NelioContent.views.UserSelector({single:!0,defaultValue:this.model.get("assigneeId")}),this._views.date=new NelioContent.views.DateSelector({model:this.model}),this.listenTo(this._views.assignee,"nc:change",this._onAssigneeChange),this.listenTo(this,"nc:close:dialog",this.close),this._convertToDialog()},render:function(){var e=this.model.toJSON();return e.today=ncNewLocalMoment().format("YYYY-MM-DD"),this._views.assignee.$el.detach(),this.el.innerHTML=this.template(e),this.$el.dialogS2("open"),this.$(".nc-assignee .nc-field").html(this._views.assignee.render().$el),this._views.assignee.$el.trigger("change"),this._maybeEnableSaveButton(),this},_lock:function(){this.$("*").attr("disabled","disabled"),this.$el.addClass("nc-locked")},_unlock:function(){this.$("*").removeAttr("disabled"),this.$el.removeClass("nc-locked")},_convertToDialog:function(){var e=[];e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.createTask));var t=this;this.$el.dialogS2({title:NelioContent.i18n.titles.newTask,autoOpen:!1,buttons:e,dialogClass:"nc-dialog nc-new-task-dialog",draggable:!1,modal:!0,resizable:!1,width:"95%",position:{my:"center bottom",at:"center center"},open:function(){t.listenTo(t,"nc:click:dialog:save",t._onDialogSave),t.listenTo(t,"nc:click:dialog:cancel",t._onDialogCancel),t._$saveButton=t.$el.parent().find("button.nc-save-button"),NelioContent.helpers.makeWarningTooltip(t._$saveButton)},close:function(e,i){t.stopListening(t,"nc:click:dialog:save",t._onDialogSave),t.stopListening(t,"nc:click:dialog:cancel",t._onDialogCancel),t._$saveButton.tooltip("destroy"),t.$el.dialogS2("destroy"),t.trigger("nc:close:dialog")}})},_maybeEnableSaveButton:function(){if("undefined"!=typeof this._$saveButton){if(this._$saveButton.tooltip("close"),0===NelioContent.helpers.trim(this.model.get("task")).length)return this._$saveButton.addClass("button-disabled"),void this._$saveButton.attr("title",NelioContent.i18n.errors.task.noTask);if(0===NelioContent.helpers.trim(this.model.get("dateValue")).length)return this._$saveButton.addClass("button-disabled"),void this._$saveButton.attr("title",NelioContent.i18n.errors.datetime.noDate);if(!this._regex.date.test(this.model.get("dateValue")))return this._$saveButton.addClass("button-disabled"),void this._$saveButton.attr("title",NelioContent.i18n.errors.datetime.invalidDate);this._$saveButton.removeClass("button-disabled"),this._$saveButton.attr("title","")}},_onTaskChange:function(t){var i=t.target||t.srcElement,n=e(i);this.model.set("task",NelioContent.helpers.trim(n.val()))},_onAssigneeChange:function(e){this.model.set("assigneeId",e)},_onDateChange:function(t){var i=t.target||t.srcElement,n=e(i);this.model.set("dateValue",NelioContent.helpers.trim(n.val()))},_onDialogSave:function(){var e=this.$el.parent(),t=e.find(".ui-dialog-buttonpane button.button-primary"),i=e.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .button-primary )");if(!t.hasClass("button-disabled")){this._lock(),this.$el.dialogS2("option","closeOnEscape",!1),t.prop("disabled",!0),i.prop("disabled",!0),t.html(NelioContent.i18n.feedback.creatingTask);var n=this;this.model.save(void 0,{success:function(e,t){n.trigger("nc:save:task",t),n.$el.dialogS2("close")},error:function(e){NelioContent.helpers.openErrorDialog(e.responseJSON),t.html(NelioContent.i18n.actions.createTask),t.prop("disabled",!1),i.prop("disabled",!1),n.$el.dialogS2("option","closeOnEscape",!0),n._unlock()}})}},_onDialogCancel:function(){this.$el.dialogS2("close")},close:function(){for(var e in this._views)if(this._views.hasOwnProperty(e)){var t=this._views[e];"object"==typeof t&&t.close()}this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.CalendarItem=Backbone.View.extend({_isAutoLocked:!1,_isLocked:!1,_isHighlighted:!1,_isBlurred:!1,_isDraggable:!1,_isDraggableReady:!1,_isClickable:!1,_calendarItem:!1,_$dragContainment:!1,_postTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_nc-post-item").innerHTML)),_socialTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_nc-social-item").innerHTML)),_taskTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_nc-task-item").innerHTML)),events:{"mouseenter .nc-calendar-item > .nc-content:not( .nc-content-locked )":"_onMouseEnter","mouseleave .nc-calendar-item > .nc-content:not( .nc-content-locked )":"_onMouseLeave","mousedown .nc-calendar-item > .nc-content:not( .nc-content-locked )":"_maybeMakeDraggable","click .nc-calendar-item > .nc-content:not( .nc-content-locked )":"_onClick"},initialize:function(e){this._checkUserPermissions(),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render),this._$dragContainment=e.$containment,NelioContent.profiles.isReady()||this.listenToOnce(NelioContent.profiles,"nc:ready",this.render)},_maybeMakeDraggable:function(t){if(!this._isDraggableReady){this._isDraggableReady=!0;var i=this;this._isDraggable&&(this.$el.addClass("nc-draggable-calendar-item"),this.$el.draggable({appendTo:i._$dragContainment,containment:i._$dragContainment,refreshPositions:!0,scroll:!1,start:function(t,n){e(this).css("visibility","hidden"),i.trigger("nc:drag:start",i.model,i)},stop:function(t,n){e(this).css("visibility",""),i.trigger("nc:drag:stop",i.model,i)},helper:function(){var t=e(this).clone();return t.detach(),i._$dragContainment.append(t),t.css("z-index","999"),t.width(e(this).width()),t.height(e(this).height()),t}}),t.type="mousedown.draggable",t.target=this.el,this.$el.trigger(t))}},render:function(){if(!NelioContent.profiles.isReady())return this.$el.empty(),this;var e;switch(this.model.get("calendarKind")){case"post":e=this.model.toJSON(),e.categories=_.reduce(e.categories,function(e,t){return e+=t.name+", "},"").slice(0,-2);var t=this.model;e.typeLabel=_.reduce(NelioContent.postTypes,function(e,i){return i.name===t.get("type")?i.labels.singular:e},NelioContent.i18n.postName);var i=NelioContent.users.getUser(this.model.get("author"));i.isLoading()&&this.listenToOnce(i,"nc:load",_.bind(function(){this.trigger("nc:render")},this)),e.photo=i.get("photo"),e.displayNameEscaped=_.escape(i.get("name")),e.firstLetter=i.get("firstLetter"),this.el.innerHTML=this._postTemplate(e);break;case"social":e=this.model.toJSON();var n=NelioContent.profiles.get(this.model.get("profileId"));n?(e.photo=n.get("photo"),e.displayNameEscaped=_.escape(n.get("displayNameEscaped")),e.firstLetter=n.get("firstLetter")):(e.photo="",e.displayNameEscaped=_.escape(NelioContent.i18n.unknownUserName),e.firstLetter="unknown"),this.el.innerHTML=this._socialTemplate(e),this.$(".nc-calendar-item").addClass("nc-"+this.model.get("network"));break;case"task":e=this.model.toJSON();var o=NelioContent.users.getUser(this.model.get("assigneeId"));o.isLoading()&&this.listenToOnce(o,"nc:load",_.bind(function(){this.trigger("nc:render")},this)),e.photo=o.get("photo"),e.displayNameEscaped=_.escape(o.get("name")),e.firstLetter=o.get("firstLetter"),this.el.innerHTML=this._taskTemplate(e)}return this._calendarItem=this.$(".nc-calendar-item .nc-content")[0],this._fixUIProperties(),this.homogenize(),this},_fixUIProperties:function(){if(this._isDraggableReady&&this._isDraggable&&(this._isLocked?this.$el.draggable("disable"):this.$el.draggable("enable")),"object"==typeof this._calendarItem){var e=this._calendarItem.className;e=e.replace(" nc-content-locked-and-highlighted",""),e=e.replace(" nc-content-highlight",""),e=e.replace(" nc-content-blurred",""),e=e.replace(" nc-content-locked",""),!this._isLocked&&this._isAutoLocked&&this._isHighlighted?e+=" nc-content-locked-and-highlighted":this._isLocked||this._isAutoLocked?e+=" nc-content-locked":this._isHighlighted?e+=" nc-content-highlight":this._isBlurred&&(e+=" nc-content-blurred"),this._calendarItem.className=e}},homogenize:function(){var e="publish"===this.model.get("status"),t=!1;this._isBlurred===e&&this._isHighlighted===t||(this._isBlurred=e,this._isHighlighted=t,this._fixUIProperties())},highlight:function(){var e="post"!==this.model.get("calendarKind")&&"publish"===this.model.get("status"),t=!0;this._isBlurred===e&&this._isHighlighted===t||(this._isBlurred=e,this._isHighlighted=t,this._fixUIProperties())},blur:function(){this._isBlurred&&!this._isHighlighted||(this._isBlurred=!0,this._isHighlighted=!1,this._fixUIProperties())},lock:function(){this._isLocked||(this._isLocked=!0,this._fixUIProperties())},unlock:function(){this._isLocked&&(this._isLocked=!1,this._fixUIProperties())},_checkUserPermissions:function(){var e=NelioContent.users.current().get("id"),t=NelioContent.users.current().get("role");switch(this.model.get("calendarKind")){case"post":this._isClickable=!0,"publish"===this.model.get("status")?this._isDraggable=!1:"contributor"===t?this._isDraggable=!1:"author"===t?this._isDraggable=e===this.model.get("author"):this._isDraggable=!0;break;case"social":this._isClickable="contributor"!==t&&"publish"!==this.model.get("status"),this._isDraggable="contributor"!==t&&"publish"!==this.model.get("status"),NelioContent.profiles.get(this.model.get("profileId"))||(this._isClickable=!1,this._isDraggable=!1);break;case"task":"contributor"===t?(this._isClickable=e===this.model.get("assigneeId"),this._isDraggable=!1):"author"===t?(this._isClickable=e===this.model.get("assigneeId"),this._isDraggable=e===this.model.get("assigneeId")):(this._isClickable=!0,this._isDraggable=!0)}this._isAutoLocked=!this._isDraggable&&!this._isClickable},_onMouseEnter:function(){switch(this.model.get("calendarKind")){case"post":this.trigger("nc:enter:mouse",this.model.get("id"),this.model.get("id"));break;default:this.trigger("nc:enter:mouse",this.model.get("id"),this.model.get("postId"))}},_onMouseLeave:function(){switch(this.model.get("calendarKind")){case"post":this.trigger("nc:leave:mouse",this.model.get("id"));break;default:this.trigger("nc:leave:mouse",this.model.get("postId"))}},_onClick:function(){this._isLocked||this._isClickable&&this.trigger("nc:click",this.model)},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.CalendarSentSocial=Backbone.View.extend({_isCollapsed:!0,_isAutoLocked:!1,_isLocked:!1,_isHighlighted:!1,_isBlurred:!1,_calendarItem:!1,_postTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_nc-post-item").innerHTML)),_socialTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_nc-social-item").innerHTML)),_taskTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_nc-task-item").innerHTML)),count:0,events:{mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave","click .nc-calendar-item > .nc-content:not( .nc-content-locked )":"_onClick"},initialize:function(e){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),NelioContent.profiles.isReady()||this.listenToOnce(NelioContent.profiles,"nc:ready",this.render)},render:function(){if(!NelioContent.profiles.isReady())return this.$el.empty(),this;var e=NelioContent.i18n.sentMessagesInCalendar.length;return this.count>0?(this._isCollapsed?this.count>=e?(this.$el.html('<div class="nc-calendar-item nc-sent-social nc-collapsed"><div class="nc-content"></div></div>'),this.$(".nc-content").html(NelioContent.i18n.sentMessagesInCalendar[e-1].replace("{count}",this.count))):(this.$el.html('<div class="nc-calendar-item nc-sent-social nc-collapsed"><div class="nc-content"></div></div>'),this.$(".nc-content").html(NelioContent.i18n.sentMessagesInCalendar[this.count-1])):(this.$el.html('<div class="nc-calendar-item nc-sent-social nc-expanded"><div class="nc-content"></div></div>'),this.$(".nc-content").html(NelioContent.i18n.actions.collapseSentMessages)),this._calendarItem=this.$el.find(".nc-content")[0]):this.$el.empty(),this._fixUIProperties(),this.homogenize(),this},_fixUIProperties:function(){if("object"==typeof this._calendarItem){var e=this._calendarItem.className;e=e.replace(" nc-content-locked-and-highlighted",""),e=e.replace(" nc-content-highlight",""),e=e.replace(" nc-content-blurred",""),e=e.replace(" nc-content-locked",""),!this._isLocked&&this._isAutoLocked&&this._isHighlighted?e+=" nc-content-locked-and-highlighted":this._isLocked||this._isAutoLocked?e+=" nc-content-locked":this._isHighlighted?e+=" nc-content-highlight":this._isBlurred&&(e+=" nc-content-blurred"),this._calendarItem.className=e}},setCount:function(e){this.count=e,this._isCollapsed||e||(this._isCollapsed=!0),this.trigger("nc:render")},homogenize:function(){var e=!0,t=!1;this._isBlurred===e&&this._isHighlighted===t||(this._isBlurred=e,this._isHighlighted=t,this._fixUIProperties())},highlight:function(){var e=!0,t=!0;this._isBlurred===e&&this._isHighlighted===t||(this._isBlurred=e,this._isHighlighted=t,this._fixUIProperties())},blur:function(){this._isBlurred&&!this._isHighlighted||(this._isBlurred=!0,this._isHighlighted=!1,this._fixUIProperties())},lock:function(){this._isLocked||(this._isLocked=!0,this._fixUIProperties())},unlock:function(){this._isLocked&&(this._isLocked=!1,this._fixUIProperties())},_onClick:function(){this._isLocked||(this._isCollapsed=!this._isCollapsed,this.trigger("nc:render"),this.trigger("nc:click"))},_onMouseEnter:function(){this.highlight()},_onMouseLeave:function(){this.blur()},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.CalendarDay=function(e,t){this.calendar=e,this.$el=t,this._date="",this._isPastDay=!1,this._views=[],this._sentSocialView=new NelioContent.views.CalendarSentSocial,this._sentSocialView.render(),this._minNumOfNonCollapsableItems=5,this.render=_.bind(this.render,this),Backbone.listenTo(this._sentSocialView,"nc:click",this.render)},NelioContent.views.CalendarDay.prototype.render=function(){var e=this._isPastDay,t=this.$el.find(".nc-items");t.find("> *").detach();var i=0;_.each(this._views,function(n){if(this.calendar.filter(n.model))return++i,"social"!==n.model.get("calendarKind")?void t.append(n.el):"publish"!==n.model.get("status")?void t.append(n.el):void((i<=this._minNumOfNonCollapsableItems||!this._sentSocialView._isCollapsed||!e)&&t.append(n.el))},this),e&&(this._updateViewCount(),t.append(this._sentSocialView.$el))},NelioContent.views.CalendarDay.prototype.setDate=function(e){var t=ncNewLocalMoment().startOf("day"),i=ncNewLocalMoment(e+"T00:00:00.000Z");this._date=e,this._isPastDay=i.isBefore(t)},NelioContent.views.CalendarDay.prototype.getDate=function(){return this._date},NelioContent.views.CalendarDay.prototype.getSentSocialView=function(){return this._sentSocialView},NelioContent.views.CalendarDay.prototype.getViews=function(){return this._views},NelioContent.views.CalendarDay.prototype.addView=function(e){this._views.push(e),this._updateViewCount()},NelioContent.views.CalendarDay.prototype.removeView=function(e){this._views=_.without(this._views,e),this._updateViewCount()},NelioContent.views.CalendarDay.prototype.resetViews=function(){this._views=[],this._updateViewCount()},NelioContent.views.CalendarDay.prototype.sortViews=function(){this._views=_.sortBy(this._views,function(e){var t,i=e.model;switch(i.get("calendarKind")){case"task":t="a"+i.get("dateDue").format("YYYY-MM-DDTHH:mm")+i.get("task");break;case"post":t="b"+i.get("date").format("YYYY-MM-DDTHH:mm")+"a";break;case"social":t="b"+i.get("schedule").format("YYYY-MM-DDTHH:mm")+"b",t+="twitter"===i.get("network")?"a":"b",t+=i.get("network")+i.get("profileId")+i.get("text");break;default:t="z"}return t})},NelioContent.views.CalendarDay.prototype._updateViewCount=function(){var e=0,t=0;_.each(this._views,function(i){this.calendar.filter(i.model)&&(++t,t>this._minNumOfNonCollapsableItems&&"social"===i.model.get("calendarKind")&&"publish"===i.model.get("status")&&++e)},this),this._sentSocialView.setCount(e)},function(){var t={object:{},extend:function(e){this.object=_.extend(this.object,e)}};t.extend({_$window:void 0,_wp:{$adminbar:void 0,$adminmenuwrap:void 0,$collapseMenu:void 0,$collapseButton:void 0},events:{"change .nc-post-filter":"_onPostFilterChange","change .nc-social-filter":"_onSocialFilterChange","click .nc-enabled .nc-action.nc-today":"_today","click .nc-enabled .nc-action.nc-month.nc-prev":"_prevMonth","click .nc-enabled .nc-action.nc-month.nc-next":"_nextMonth","click .nc-download-csv:not( .nc-disabled )":"_downloadCSV","click .nc-enabled .nc-action.nc-add-post":"_addPost","click .nc-enabled .nc-action.nc-add-social":"_addSocial","click .nc-enabled .nc-action.nc-add-task":"_addTask"},initialize:function(){if(this._$window=e(window),this._wp.$adminbar=e("#adminbar"),this._wp.$adminmenuwrap=e("#adminmenuwrap"),this._wp.$collapseMenu=e("#collapse-menu"),this._wp.$collapseButton=e("#collapse-button"),this._resetItemViews(),this.render=_.bind(this.render,this),this._fixShadows=_.debounce(this._fixShadows,150),this._scrollToToday=_.debounce(this._scrollToToday,250),this._maybeHighlightItems=_.debounce(this._maybeHighlightItems,100),this._renderDebounced=_.debounce(this.render,120),this._resizeDebounced=_.debounce(this._resize,200),this.listenTo(this.collection,"nc:reset:empty",this._resetItemViews),this.listenTo(this.collection,"nc:reset:items",this._resetItemViews),this.listenTo(this.collection,"add",this._addItem),this.listenTo(this.collection,"remove",this._removeItem),this.listenTo(this.collection,"nc:change:isLoading",this._onLoadingItems),this.listenTo(this,"nc:render:debounced",this._renderDebounced),this.listenTo(this,"nc:render:now",this.render),this._resize=_.bind(this._resize,this),this._onCalendarScroll=_.bind(this._onCalendarScroll,this),this._scrollCalendarUp=_.bind(this._scrollCalendarUp,this),this._scrollCalendarDown=_.bind(this._scrollCalendarDown,this),!NelioContent.profiles.isReady()){var t=this;this.listenToOnce(NelioContent.profiles,"nc:ready",function(){t.collection.isLoading()||t.unlock(),t._renderDebounced()}),this.listenToOnce(NelioContent.profiles,"nc:error",function(){NelioContent.helpers.openErrorDialog(NelioContent.i18n.errors.api.unableToRetrieveProfiles)}),this.listenToOnce(NelioContent.profiles,"nc:error",this._renderDebounced)}},close:function(){this.stopListening(),
this.unbind(),this._$window.off("resize",this._resize),this._wp.collapseMenu.off("click",this._resizeDebounced),this._wp.collapseButton.off("click",this._resizeDebounced),this._ui.$calendar.off("scroll",this._onCalendarScroll),"object"==typeof this._taskFilterView&&this._taskFilterView.close(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),t.extend({_resetItemViews:function(){_.each(this._daysInGrid,function(e){_.each(e.getViews(),function(e){this.stopListening(e),e.close()},this),e.resetViews()},this);var e=[];this.collection.each(function(t){var i=this._createItemView(t);i&&e.push(i)},this),this._distributeItemViews(e),this.trigger("nc:render:now"),this.collection.length&&this._fixScroll()},_addItem:function(e){var t=this._findCalendarDay(e.getRelevantDay());if("undefined"!=typeof t){var i=this._createItemView(e);i&&(t.addView(i),t.sortViews(),t.render())}},_removeItem:function(e){var t=[];_.each(this._daysInGrid,function(i){_.each(i.getViews(),function(n){n.model.get("id")===e.get("id")&&t.push({day:i,view:n})})});for(var i=0;i<t.length;++i){var n=t[i],o=n.day,s=n.view;o.removeView(s),this.stopListening(s),s.close()}},_createItemView:function(e){if(!this._dragging.active||e.get("id")!==this._dragging.view.model.get("id")){var t=new NelioContent.views.CalendarItem({model:e,$containment:this._ui.$calendarHolder});switch(t.render(),this.listenTo(t,"nc:drag:start",this._onDragStart),this.listenTo(t,"nc:drag:stop",this._onDragStop),this.listenTo(t,"nc:enter:mouse",this._highlightItems),this.listenTo(t,"nc:leave:mouse",this._homogenizeItems),t.model.get("calendarKind")){case"post":this.listenTo(t,"nc:click",this._editPost);break;case"social":"error"===t.model.get("status")?this.listenTo(t,"nc:click",this._openSocialErrorDialog):this.listenTo(t,"nc:click",this._editSocial);break;case"task":this.listenTo(t,"nc:click",this._toggleTaskCompletion)}return t}},_distributeItemViews:function(e){var t=[];_.each(e,function(e){var i=this._findCalendarDay(e.model.getRelevantDay());return"undefined"==typeof i?void t.push(e):void i.addView(e)},this),_.each(this._missedViews,function(e){e.close()}),_.each(this._daysInGrid,function(e){e.sortViews()})}}),t.extend({_addPost:function(t){var i=t.target||t.srcElement,n=e(i).closest(".nc-add-post"),o=new NelioContent.views.PostEditor({model:new NelioContent.models.Post,date:n.data("date")}),s=this;this.listenTo(o,"nc:save:post",function(e){s.collection.add(e)}),this.listenTo(o,"nc:close:dialog",function(e){s.stopListening(o)}),o.render()},_addSocial:function(t){if(!NelioContent.helpers.isSubscribed())return void t.preventDefault();if(0===NelioContent.profiles.length)return void this._openNoProfilesDialog();var i=t.target||t.srcElement,n=e(i).closest(".nc-add-social"),o=new NelioContent.models.SocialMessage;o.set("profileId",NelioContent.profiles.at(0).get("id"));var s=ncNewLocalMoment(n.data("date")),a=ncNewLocalMoment();s.format("YYYYMMDD")===a.format("YYYYMMDD")?(o.set("dateType","predefined-offset"),o.set("dateValue","0"),o.set("timeType","predefined-offset"),o.set("timeValue","0")):(o.set("dateType","exact"),o.set("dateValue",n.data("date")),o.set("timeType","time-interval"),o.set("timeValue","morning"));var l=new NelioContent.views.SocialMessageEditor({model:o}),r=this;this.listenTo(l,"nc:add:messages",function(e){for(var t=0;t<e.length;++t)e[t].calendarKind="social";r.collection.add(e)}),this.listenTo(l,"nc:close:dialog",function(e){r.stopListening(l)}),l.render()},_addTask:function(t){if(!NelioContent.helpers.isSubscribed())return void t.preventDefault();var i=t.target||t.srcElement,n=e(i).closest(".nc-add-task"),o=new NelioContent.views.TaskDialog({model:new NelioContent.models.EditorialTask,date:n.data("date")}),s=this;this.listenTo(o,"nc:save:task",function(e){e.calendarKind="task",s.collection.add(e)}),this.listenTo(o,"nc:close:dialog",function(e){s.stopListening(o)}),o.render()},_openNoProfilesDialog:function(){var t=e("<div></div>").html(document.getElementById("_nc-no-profile-available").innerHTML);t.dialog({title:NelioContent.i18n.titles.addSocialProfiles,modal:!0,width:450,dialogClass:"nc-dialog",open:function(){t.find("a").blur()},buttons:[{text:NelioContent.i18n.actions.addSocialProfile,"class":"button button-primary",click:function(){document.location.href=NelioContent.pages.settings}}]})},_downloadCSV:function(){if(NelioContent.helpers.isSubscribed()){var e=this;this.lock(),this.listenToOnce(this.collection,"nc:download:csv",function(t){var i=window.URL||window.webkitURL,n=new Blob([t],{type:"text/csv;charset=UTF-8",encoding:"UTF-8"}),o=document.createElement("a");o.setAttribute("href",i.createObjectURL(n)),o.setAttribute("download",e.collection.getFirstDayOfMonth().locale("en").format("YYYY-MM")+".csv"),document.body.appendChild(o),o.click(),document.body.removeChild(o),e.unlock()}),this.collection.toCSV()}}}),t.extend({_autoscrollInterval:0,_dragging:{active:!1,detached:!1,dropArea:"none",originalDate:"",view:void 0},_detachDraggingObject:function(){this._dragging.detached=!0,this._dragging.view.$el.detach(),this.stopListening(this.collection,"nc:change:date",this._detachDraggingObject)},_onDragStart:function(e,t){this.$(".nc-context-actions").addClass("nc-dragging"),this.listenTo(this.collection,"nc:change:date",this._detachDraggingObject),this._dragging.active=!0,this._dragging.view=t,this._dragging.detached=!1,this._dragging.originalDate=e.getRelevantDay();var i=e.getRelevantDay();_.each(this._daysInGrid,function(e){e.getDate()===i&&e.removeView(t),_.each(e.getViews(),function(e){e.blur()})})},_onDragStop:function(e,t){if(this.$(".nc-context-actions").removeClass("nc-dragging"),this.stopListening(this.collection,"nc:change:date",this._detachDraggingObject),"none"===this._dragging.dropArea)return void this._abortDraggingObjectChanges(e,t);if("trash"===this._dragging.dropArea)return void this._deleteDraggingObject(e,t);var i=this._dragging.dropArea;return NelioContent.helpers.isDate(i)&&i!==this._dragging.originalDate?void this._rescheduleItem(e,t):void this._abortDraggingObjectChanges(e,t)},_cleanDraggingObject:function(){function e(){t._dragging.view===i&&(t._dragging.view=void 0,t._dragging.active=!1,t._dragging.dropArea="none"),t.collection.remove(i.model.get("id")),"trash"!==n&&t.collection.add(i.model.toJSON()),t._fixControls(),_.each(t._daysInGrid,function(e){e.removeView(i)}),i.close()}var t=this,i=t._dragging.view,n=t._dragging.dropArea;t.collection.isLoading()?t.listenToOnce(t.collection,"nc:change:isLoading",e):e()},_abortDraggingObjectChanges:function(e,t){this._cleanDraggingObject()},_rescheduleItem:function(e,t){var i=this,n=this._dragging.dropArea;_.each(this._daysInGrid,function(e){e.getDate()===n&&(e.addView(t),e.sortViews(),e.render())}),"post"===e.get("calendarKind")?this.listenToOnce(e,"nc:reschedule",function(){i._cleanDraggingObject(),i.collection.refresh()}):this.listenToOnce(e,"nc:reschedule",function(){i.stopListening(e,"nc:abort:reschedule"),i.stopListening(e,"nc:error"),i.unlock(),i._cleanDraggingObject()}),this.listenToOnce(e,"nc:abort:reschedule",function(t){"object"==typeof t&&NelioContent.helpers.openWarningDialog(t.title,t.content),i.stopListening(e,"nc:reschedule"),i.stopListening(e,"nc:error"),i.unlock(),i._cleanDraggingObject()}),this.listenToOnce(e,"nc:error",function(){var e=NelioContent.i18n.errors.generic.unableToRescheduleItem;NelioContent.helpers.openErrorDialog(e),i._cleanDraggingObject(),i.collection.refresh()}),this.lock(),this._dragging.view.lock(),e.reschedule(i._dragging.dropArea)},_deleteDraggingObject:function(e,t){this.lock();var i=this;t.$el.detach(),"post"===e.get("calendarKind")?(this.listenToOnce(e,"nc:trash",function(){i.stopListening(i._dragging.view),i._cleanDraggingObject(),i._homogenizeItems(),i.collection.refresh()}),this.listenToOnce(e,"nc:error",function(e){var t=NelioContent.i18n.errors.post.unableToTrash;t=t.replace("{error}",e.replace(/\.$/,"")),NelioContent.helpers.openErrorDialog(t),i.stopListening(i._dragging.view),i._cleanDraggingObject(),i._homogenizeItems(),i.collection.refresh()}),e.trash()):e.destroy({success:function(){i.stopListening(i._dragging.view),i._cleanDraggingObject(),i._homogenizeItems(),i.unlock()},error:function(){var e=NelioContent.i18n.errors.generic.unableToDeleteItem;NelioContent.helpers.openErrorDialog(e),i.stopListening(i._dragging.view),i._cleanDraggingObject(),i._homogenizeItems(),i.collection.refresh()}})},_buildDroppableAreas:function(){var t=this,i=this.collection;this._ui.$scrollUpArea.droppable({accept:".nc-draggable-calendar-item",hoverClass:"hovering",tolerance:"touch",over:function(){clearInterval(t._autoscrollInterval),t._autoscrollInterval=setInterval(t._scrollCalendarUp,50)},out:function(){clearInterval(t._autoscrollInterval)},drop:function(){clearInterval(t._autoscrollInterval)}}),this._ui.$scrollDownArea.droppable({accept:".nc-draggable-calendar-item",hoverClass:"hovering",tolerance:"touch",over:function(){clearInterval(t._autoscrollInterval),t._autoscrollInterval=setInterval(t._scrollCalendarDown,50)},out:function(){clearInterval(t._autoscrollInterval)},drop:function(){clearInterval(t._autoscrollInterval)}}),this.$(".nc-day").droppable({accept:".nc-draggable-calendar-item",hoverClass:"nc-highlight",tolerance:"pointer",drop:function(){t._dragging.dropArea=e(this).data("date")}}),this.$(".nc-action.nc-trash").droppable({drop:function(){t._dragging.dropArea="trash"},tolerance:"pointer",hoverClass:"nc-hover"});var n={drop:function(e,t){clearInterval(this.__interval),this.__interval=void 0},out:function(e,t){clearInterval(this.__interval),this.__interval=void 0},tolerance:"pointer",hoverClass:"nc-hover"};n.over=function(e,t){"undefined"==typeof this.__interval&&(this.__interval=setInterval(function(){i.prevMonth()},1e3))},this.$(".nc-area.nc-month.nc-prev").droppable(n),n.over=function(e,t){"undefined"==typeof this.__interval&&(this.__interval=setInterval(function(){i.nextMonth()},1e3))},this.$(".nc-area.nc-month.nc-next").droppable(n)},_scrollCalendarUp:function(){this._ui.$calendar[0].scrollTop-=20},_scrollCalendarDown:function(){this._ui.$calendar[0].scrollTop+=20}}),t.extend({_editPost:function(e){var t=new NelioContent.views.PostEditor({model:new NelioContent.models.Post(e.toJSON()),date:e.get("date").format("YYYY-MM-DD")}),i=this;this.listenTo(t,"nc:save:post",function(e){i.lock(),i.collection.refresh()}),this.listenTo(t,"nc:trash:post",function(){i.collection.remove(e),i.lock(),i.collection.refresh()}),this.listenTo(t,"nc:close:dialog",function(e){i.stopListening(t)}),this._fixControls(),t.render()},_editSocial:function(e){var t=new NelioContent.models.SocialMessage(e.toJSON()),i=new NelioContent.views.SocialMessageEditor({model:t}),n=this;this.listenTo(i,"nc:update:message",function(t){t.calendarKind="social",n.collection.remove(e),n.collection.add(t)}),this.listenTo(i,"nc:delete:message",function(e){n.collection.remove(e)}),this.listenTo(i,"nc:close:dialog",function(){n.stopListening(i)}),this._fixControls(),i.render()},_openSocialErrorDialog:function(t){var i,n=this,o=t.get("failureDescription");i=0===NelioContent.helpers.trim(o)?NelioContent.i18n.dialogs.socialNotSentUnknown:NelioContent.i18n.dialogs.socialNotSent.replace("{error}",_.escape(t.get("failureDescription")));var s=e('<div class="nc-error-dialog">'+i+"</div>");s.dialog({title:NelioContent.i18n.titles.socialNotSent,modal:!0,width:Math.min(500,e(window).width()-20),dialogClass:"nc-dialog",buttons:[{"class":"button",text:NelioContent.i18n.actions.editSocial,click:function(){n._editSocial(t),s.dialog("close"),s.dialog("destroy")}},{"class":"button button-primary",text:NelioContent.i18n.actions.sendSocialNow,click:function(){t.shareNow(),s.dialog("close"),s.dialog("destroy")}}]})},_toggleTaskCompletion:function(e){var t=new NelioContent.models.EditorialTask(e.toJSON());t.set("completed",!e.get("completed")),this.lock();var i=this;t.save(void 0,{success:function(t,n){e.set("completed",n.completed),i.unlock()}})}}),t.extend({_filters:{post:ncstore.get("nc-calendar-post-filter","all"),social:ncstore.get("nc-calendar-social-filter","all"),task:ncstore.get("nc-calendar-task-filter","all")},_socialFilterTemplates:{profile:_.template(NelioContent.helpers.trim(document.getElementById("_nc-single-profile-selector-profile").innerHTML)),network:_.template(NelioContent.helpers.trim(document.getElementById("_nc-network-option").innerHTML)),selectedProfile:_.template(NelioContent.helpers.trim(document.getElementById("_nc-single-profile-selector-selected-profile").innerHTML)),selectedNetwork:_.template(NelioContent.helpers.trim(document.getElementById("_nc-network-option").innerHTML)),userOption:_.template(NelioContent.helpers.trim(document.getElementById("_nc-user-selector-option").innerHTML))},_taskFilterView:!1,filter:function(e){switch(e.get("calendarKind")){case"post":return"all"===this._filters.post||"none"!==this._filters.post&&(NelioContent.postTypes.length>1?e.get("type")===this._filters.post:"post"!==NelioContent.postTypes[0].name||_.contains(_.pluck(e.get("categories"),"id"),this._filters.post));case"social":return!!NelioContent.profiles.isReady()&&("all"===this._filters.social||"none"!==this._filters.social&&(0===this._filters.social.indexOf("nc:network:")?e.get("network")===this._filters.social.substring(11):e.get("profileId")===this._filters.social));case"task":return"all"===this._filters.task||"none"!==this._filters.task&&e.get("assigneeId")===this._filters.task;default:return console.log("Unknown calendar kind."),!1}},_buildFilters:function(){NelioContent.helpers.buildPostFilter(this.$(".nc-post-filter")),"all"!==this._filters.post&&(this.$(".nc-post-filter").val(this._filters.post),this.$(".nc-post-filter").trigger("change")),this._buildSocialFilter(),this._buildTaskFilter()},_buildSocialFilter:function(){var t=[{id:"all",text:NelioContent.i18n.filters.actions.showSocialMessages},{id:"none",text:NelioContent.i18n.filters.actions.hideSocialMessages}];if(!NelioContent.profiles.isReady())return this.$(".nc-social-filter").css("width","15em"),void this.listenToOnce(NelioContent.profiles,"nc:ready",this._buildSocialFilter);if(NelioContent.profiles.length>0){var i=NelioContent.profiles.toJSON();_.each(i,function(e){e.text=e.displayName,e.ncselect2Type="profile"});var n=_.uniq(_.pluck(i,"network")).sort(),o=[];_.each(n,function(e){var t=_.findWhere(NelioContent.networkMetas,{id:e});"undefined"!=typeof t&&o.push({id:"nc:network:"+t.id,displayName:t.name,network:t.id,ncselect2Type:"network",text:t.name})}),t.push({text:NelioContent.i18n.filters.groups.network,children:o}),t.push({text:NelioContent.i18n.filters.groups.profile,children:i})}var s="nc-social-filter",a=this._socialFilterTemplates.profile,l=this._socialFilterTemplates.network,r=this._socialFilterTemplates.selectedProfile,c=this._socialFilterTemplates.selectedNetwork;this.$(".nc-social-filter").ncselect2({data:t,dropdownCssClass:s,width:"15em",templateResult:function(t){switch(t.ncselect2Type){case"profile":return e(a(t));case"network":return e(l(t));default:return t.text}},templateSelection:function(t){switch(t.id){case"all":return NelioContent.i18n.filters.selection.allSocialMessages;case"none":var i='<span class="nc-dashicons nc-dashicons-hidden"></span> ',n=NelioContent.i18n.filters.selection.noSocialMessages;return e("<span>"+i+n+"</span>");default:return e("profile"===t.ncselect2Type?r(t):c(t))}}}),this.$(".nc-social-filter").val(this._filters.social).trigger("change")},_buildTaskFilter:function(){var e=this.$(".nc-task-filter");0!==e.length&&(this._taskFilterView=new NelioContent.views.UserFilter({el:e,dropdownCssClass:"nc-task-filter",width:"15em",defaultValue:this._filters.task,actions:{all:NelioContent.i18n.filters.actions.showTasks,none:NelioContent.i18n.filters.actions.hideTasks},labels:{group:NelioContent.i18n.filters.groups.assignee,all:NelioContent.i18n.filters.selection.allTasks,none:NelioContent.i18n.filters.selection.noTasks,single:NelioContent.i18n.filters.selection.tasksOf}}),this.listenTo(this._taskFilterView,"nc:change",this._onTaskFilterChange),this._taskFilterView.render())},_onPostFilterChange:function(){var e=this.$(".nc-post-filter").val();isNaN(parseInt(e))?this._filters.post=e:this._filters.post=parseInt(e),ncstore.set("nc-calendar-post-filter",this._filters.post),this.trigger("nc:render:debounced")},_onSocialFilterChange:function(){this._filters.social=this.$(".nc-social-filter").val(),ncstore.set("nc-calendar-social-filter",this._filters.social),this.trigger("nc:render:debounced")},_onTaskFilterChange:function(e){isNaN(parseInt(e))?this._filters.task=e:this._filters.task=parseInt(e),ncstore.set("nc-calendar-task-filter",this._filters.task),this.trigger("nc:render:debounced")}}),t.extend({_resize:function(){var e=NelioContent.helpers.getScrollbarWidth(),t=this._getAvailableHeight(),i=this._ui.$helperDivForCalendarWidth.width();this._ui.$container.height(t),this._ui.$header.width(i),t-=this._ui.$header.height(),this._ui.$calendarHolder.width(i),this._ui.$calendarHolder.height(t),this._ui.$actions.height(t),this._ui.$calendar.css("height",t);var n=this._ui.$container[0].getBoundingClientRect(),o=this._ui.$monthActionAreas[0].getBoundingClientRect(),s=Math.floor(n.bottom-o.top-10),a=Math.max(Math.floor(s-Math.floor(t/2)-20),0);this._ui.$monthActionAreas.css("padding-top",a),this._ui.$monthActionAreas.height(s-a);var l=i-2*this._ui.$actions.width();if(this._ui.$scrollUpArea.width(l),this._ui.$scrollDownArea.width(l),this.$(".nc-week").css("min-height",""),this._ui.$grid.height()<=t){var r=Math.floor(t/6);this.$(".nc-week").css("min-height",r),this.$(".nc-week").first().css("min-height",r)}"ltr"===this._ui.textDirection?(this._ui.$calendar.css("padding-left",this._ui.$actions.width()+e),this._ui.$calendar.css("padding-right",this._ui.$actions.width())):(this._ui.$calendar.css("padding-left",this._ui.$actions.width()),this._ui.$calendar.css("padding-right",this._ui.$actions.width()+e)),this._ui.$calendar.css("margin-left",-e),this._ui.$calendar.width(this._ui.$container.width()-2*this._ui.$actions.width()+e),this._ui.$calendar.removeClass("nc-small"),this._ui.$calendar.removeClass("nc-smallest"),i<900?this._ui.$calendar.addClass("nc-smallest"):i<1250&&this._ui.$calendar.addClass("nc-small"),this._fixShadows()},_onCalendarScroll:function(){this._fixShadows(),this._isLocked||(this._scroll.position=this._ui.$calendar.scrollTop())},_resetScroll:function(){this._scroll.seekToday=!0,this._scroll.position=0,this._ui.$calendar.scrollTop(this._scroll.position)},_fixScroll:function(){return this._scroll.seekToday?void this._scrollToToday():void this._ui.$calendar.scrollTop(this._scroll.position)},_scrollToToday:function(){this._scroll.seekToday=!1;var e=this.$(".nc-day.nc-today");if(0!==e.length){var t=e[0].getBoundingClientRect(),i=this._ui.$header[0].getBoundingClientRect();if(i.bottom+100!==t.top){var n=t.top-i.bottom-100;this._scroll.position=this._ui.$calendar.scrollTop()+n,this._ui.$calendar.animate({scrollTop:this._scroll.position},500)}}},_fixShadows:function(){this._ui.$calendar[0].scrollTop<=0?this._ui.$calendarHolder.removeClass("nc-top-shadow"):this._ui.$calendarHolder.addClass("nc-top-shadow"),this._isScrollAtTheBottom()?this._ui.$calendarHolder.removeClass("nc-bottom-shadow"):this._ui.$calendarHolder.addClass("nc-bottom-shadow"),0!==this._ui.$calendar.scrollLeft()&&this._ui.$calendar.scrollLeft(0)},_isScrollAtTheBottom:function(){return this._ui.$calendar[0].scrollHeight-this._ui.$calendar.scrollTop()<=this._ui.$calendar.outerHeight()},_getAvailableHeight:function(){var e=window.innerHeight;return e-this._wp.$adminbar.height()-100}}),t.extend({_daysInGrid:[],_updateDaysInGrid:function(){var e=this,t=this.collection.getFirstDay(),i=this.collection.getToday(),n=t.clone().add(14,"d");_.each(e._daysInGrid,function(o){o.$el.data("date",t.format("YYYY-MM-DD")),o.$el.attr("class","nc-day "+e._getDayClasses(t,n,i)),o.$el.find(".nc-action").data("date",t.format("YYYY-MM-DD")),o.$el.find(".nc-day-number").text(t.format("DD")),o.setDate(t.format("YYYY-MM-DD")),t.add(1,"d")})},_findCalendarDay:function(e){for(var t=0;t<this._daysInGrid.length;++t)if(this._daysInGrid[t].getDate()===e)return this._daysInGrid[t]}}),t.extend({_today:function(){return this._resetScroll(),this.collection.gotoDate(ncNewLocalMoment()),!1},_prevMonth:function(){return this._resetScroll(),this.collection.prevMonth(),!1},_nextMonth:function(){return this._resetScroll(),this.collection.nextMonth(),!1}}),t.extend({_rendering:!1,_rendered:!1,_isLocked:!1,_isSynching:!1,_highlightedPostId:0,_scroll:{position:0,seekToday:!0},_ui:{textDirection:"ltr",$actions:void 0,$calendar:void 0,$calendarHolder:void 0,$container:void 0,$downloadCSV:void 0,$grid:void 0,$header:void 0,$helperDivForCalendarWidth:void 0,$monthActionAreas:void 0,$scrollDownArea:void 0,$scrollUpArea:void 0},template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-calendar").innerHTML)),_dayTemplate:_.template(NelioContent.helpers.trim(document.getElementById("_nc-day").innerHTML)),render:function(){if(this._rendering)return this;this._rendering=!0;var e=this.collection.getToday(),t=this.collection.getFirstDayOfMonth(),i=e;this.collection.isTodayVisible()||(i=ncNewLocalMoment(t.format("YYYY-MM-")+"01 12:00")),this._rendered||(this.collection.isLoading()&&(this._isSynching=!0,this._isLocked=!0),this.el.innerHTML=this.template({newItemDate:i.format("YYYY-MM-DD")}),this._ui.$actions=this.$(".nc-context-actions"),this._ui.$monthActionAreas=this.$(".nc-permanent-actions .nc-area.nc-month"),this._ui.$calendar=this.$(".nc-calendar"),this._ui.$calendar=this.$(".nc-calendar"),this._ui.$calendarHolder=this.$(".nc-calendar-holder"),this._ui.$container=this.$(".nc-calendar-and-header-container"),this._ui.$downloadCSV=this.$(".nc-download-csv"),this._ui.$grid=this.$(".nc-grid"),this._ui.$header=this.$(".nc-calendar-header"),this._ui.$helperDivForCalendarWidth=this.$(".nc-helper-div"),this._ui.$scrollDownArea=this.$(".nc-scroll-down-area"),this._ui.$scrollUpArea=this.$(".nc-scroll-up-area"),this._ui.textDirection=window.getComputedStyle(this._ui.$calendar[0],null).getPropertyValue("direction"),this._buildFilters(),this._$window.on("resize",this._resize),this._wp.$collapseMenu.on("click",this._resizeDebounced),this._wp.$collapseButton.on("click",this._resizeDebounced),this._ui.$calendar.on("scroll",this._onCalendarScroll),this._renderHeader(),this._renderGrid(),this._buildDroppableAreas()),this._updateDaysInGrid();var n=NelioContent.helpers.capitalizeFirstLetter(t.format("MMMM"));return this.$(".nc-current-month .nc-month").text(n),this.$(".nc-current-month .nc-year").text(t.year()),this.el.className="nc-"+t.locale("en").format("MMMM").toLowerCase(),this.$(".nc-day").droppable("disable"),this.$(".nc-day.nc-today, .nc-day.nc-future").droppable("enable"),_.each(this._daysInGrid,function(e){e.render()}),this._homogenizeItems(),this._fixControls(),this._resize(),this._rendered=!0,this._rendering=!1,this},_fixControls:function(){_.each(this._daysInGrid,function(e){this._isLocked?e.getSentSocialView().lock():e.getSentSocialView().unlock(),_.each(e.getViews(),function(e){this._isLocked?e.lock():e.unlock(),this._dragging.active?e.blur():e.homogenize()},this)},this),this._isSynching||this._isLocked?(this.$(".nc-cal-sync").addClass("is-active"),this._ui.$downloadCSV.hide()):(this.$(".nc-cal-sync").removeClass("is-active"),this._ui.$downloadCSV.show()),this._isLocked?(this.$(".button").prop("disabled",!0),this.$(".nc-day .nc-actions").removeClass("nc-enabled"),this.$(".nc-regular-actions").removeClass("nc-enabled"),this.$(".nc-context-actions").removeClass("nc-enabled"),this.$(".nc-calendar-actions").removeClass("nc-enabled"),this.$(".nc-post-filter").prop("disabled",!0),this.$(".nc-social-filter").prop("disabled",!0),"object"==typeof this._taskFilterView&&this._taskFilterView.lock()):(this.$(".button").prop("disabled",!1),this.$(".nc-day .nc-actions").addClass("nc-enabled"),this.$(".nc-regular-actions").addClass("nc-enabled"),this.$(".nc-context-actions").addClass("nc-enabled"),this.$(".nc-calendar-actions").addClass("nc-enabled"),this.$(".nc-post-filter").prop("disabled",!1),this.$(".nc-social-filter").prop("disabled",!1),"object"==typeof this._taskFilterView&&this._taskFilterView.unlock(),this.$(".button.nc-action.nc-today").prop("disabled",this.collection.isTodayVisible()))},lock:function(){this._isSynching=!0,this._isLocked=!0,this._fixControls()},unlock:function(){this._isSynching=!NelioContent.profiles.isReady(),this._isLocked=!NelioContent.profiles.isReady(),this._fixControls()},showLoader:function(){this._isLocked||(this._isSynching=!0,this._fixControls())},hideLoader:function(){this._isSynching=!1,this._fixControls()},_onLoadingItems:function(e){e?this.showLoader():this.unlock()},_renderHeader:function(){var e=this.collection.getFirstDay(),t=this.$(".nc-days-of-week")[0],i="";e=this.collection.getFirstDay();for(var n=0;n<7;++n)i+="<span>"+e.format("ddd")+"</span>",e.add(1,"d");e.add(-7,"d"),t.innerHTML=i},_renderGrid:function(){for(var t=this.collection.getFirstDay(),i=(this.collection.getToday(),this),n=this.$(".nc-grid")[0],o="",s=0;s<6;++s){o+='<div class="nc-week">';for(var a=0;a<7;++a)o+=this._dayTemplate(),t.add(1,"d");o+="</div>"}n.innerHTML=o;var l=this;this.$(".nc-day").each(function(){i._daysInGrid.push(new NelioContent.views.CalendarDay(l,e(this)))})},_getDayClasses:function(e,t,i){var n="";return(e.year()<t.year()||e.month()<t.month())&&(n="nc-other-month "),(e.year()>t.year()||e.month()>t.month())&&(n="nc-other-month "),n+=e.year()<i.year()?"nc-past":e.year()>i.year()?"nc-future":e.dayOfYear()<i.dayOfYear()?"nc-past":e.dayOfYear()>i.dayOfYear()?"nc-future":"nc-today"},_highlightItems:function(e,t){this._maybeHighlightItems("enter",e,t)},_homogenizeItems:function(){this._maybeHighlightItems("leave")},_maybeHighlightItems:function(e,t,i){this._dragging.active||(this._highlightedPostId=i,_.each(this._daysInGrid,function(n){_.each(n.getViews(),function(n){switch(n.model.get("calendarKind")){case"post":"leave"===e?n.homogenize():i>0&&n.model.get("id")===i?n.highlight():n.blur();break;default:"leave"===e?n.homogenize():i>0&&n.model.get("postId")===i?n.highlight():n.model.get("id")===t?n.highlight():n.blur()}})}))},_updateListOfAnimatedViews:function(){var e=0;_.each(this._daysInGrid,function(t){7<++e||_.each(t.getViews(),function(e){e._calendarItem.className.indexOf("nc-animated-cal-item")<0&&(e._calendarItem.className+=" nc-animated-cal-item")})})}}),NelioContent.views.Calendar=Backbone.View.extend(t.object)}();var t,i;i=location.search.match(/\bdate=([12][01][0-9][0-9]-[01][0-9](-[0123][0-9])?)$/),i&&i.length<2&&(i=location.search.match(/\bdate=([12][01][0-9][0-9]-[01][0-9](-[0123][0-9])?)&/));var n;n=i&&i.length>=2?i[1]:"",t=n.length>0?new NelioContent.collections.MonthlyCalendarItems(null,{date:n}):new NelioContent.collections.MonthlyCalendarItems;var o=new NelioContent.views.Calendar({el:e("#nelio-content-calendar"),collection:t});o.render()}(jQuery);