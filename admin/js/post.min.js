!function(e){"use strict";function t(t){e.ajax({url:NelioContent.apiUri+"/post/"+t.get("id")+"/items",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(i){l.collection.setPost(t),l.collection.reset(i.social),l.listenToOnce(NelioContent.profiles,"nc:ready",function(){e("#nelio-content-social-timeline-container").html(l.render().el)}),NelioContent.profiles.isReady()&&NelioContent.profiles.trigger("nc:ready"),NelioContent.helpers.isSubscribed()&&(c.collection.setPost(t),c.collection.reset(i.tasks),e("#nelio-content-editorial-tasks-container").html(c.render().el)),NelioContent.helpers.isSubscribedTo("team-plan")&&(r.collection.setPost(t),r.collection.reset(i.comments),e("#nelio-content-editorial-comments-container").html(r.render().el))},error:function(t){var i=new NelioContent.models.AjaxError;i.parseResponse(t),l.close(),e("#nelio-content-social-timeline-container").html(new NelioContent.views.MetaBoxError({model:i}).render().el),NelioContent.helpers.isSubscribedTo("team-plan")&&(r.close(),e("#nelio-content-editorial-comments-container").html(new NelioContent.views.MetaBoxError({model:i}).render().el)),NelioContent.helpers.isSubscribed()&&(c.close(),e("#nelio-content-editorial-tasks-container").html(new NelioContent.views.MetaBoxError({model:i}).render().el))}})}function i(t){function i(t){var i=parseInt(e("#wp-word-count .word-count").text());if(isNaN(i)||0===i){var n=new wp.utils.WordCounter;i=n.count(t)}u.onLinksChange(NelioContent.helpers.extractUrls(t)),u.onImageCountChange(NelioContent.helpers.countImages(t)),u.onTextLengthChange(i)}function n(e){h.suggestedReferences.each(function(t){t.testIfIsInPostContent(e)})}t.listenTo(Backbone,"nc:change:featuredImage",function(e){t.set({imageId:e.get("attachmentId"),image:e.get("url")})});var r=new NelioContent.collections.LinksInPost;r.setPost(t);var d=new NelioContent.collections.References;d.setPost(t);var h=new NelioContent.views.Links({brokenLinks:r,suggestedReferences:d});e.ajax({url:ajaxurl,data:{action:"nelio_content_get_post_references",post:e("#post_ID").val()},success:function(t){h.suggestedReferences.reset(t.suggested),e("#nelio-content-links-container").html(h.render().el)}}),NelioContent.views.PostAnalysisView=Backbone.View.extend({_areDetailsVisible:ncstore.get("nc-post-analysis-visible-details",!1),_data:{},_summary:"pending",_postStatus:"draft",_postType:"post",_discardPendingTimeout:0,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-post-analysis").innerHTML)),events:{"click .nc-details-control":"_toggleDetailsVisibility"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render);var e=this;this.listenTo(this,"nc:change",_.debounce(function(){e.trigger("nc:render")},600)),this._data={author:"pending",excerpt:"pending",externalLinks:"pending",imageCount:"pending",internalLinks:"pending",tag:"pending",textLength:"pending",thumbnail:"pending",social:"pending",tasks:"pending"},NelioContent.helpers.isSubscribed()||(this._data.tasks=void 0),NelioContent.postAnalysis.isYoastSeoIntegrated&&(this._data.yoastSeo="pending",this._data.yoastContent="pending"),this._discardPendingTimeout=setTimeout(function(){e._discardPendingDetails()},15e3)},render:function(){this._updateSummary();var e=_.clone(this._data);return e.isPostPublished="publish"===this._postStatus,e.areDetailsVisible=this._areDetailsVisible,e.summary=this._summary,this.el.innerHTML=this.template(e),this},onPostChange:function(e){this._postStatus=e.get("status"),this._postType=e.get("type"),"post"!==this._postType&&(this._data.tag=void 0),"publish"===this._postStatus&&(this._data.social=void 0);var t=NelioContent.users.getUser(e.get("author"));t.isLoading()?this.listenToOnce(t,"nc:load",_.bind(function(){this._checkAuthor(t),this.trigger("nc:change")},this)):this._checkAuthor(t),NelioContent.helpers.trim(e.get("excerpt")).length<20?this._data.excerpt="improvable":this._data.excerpt="good";var i=e.get("image"),n=e.get("autoImage"),s=_.where(NelioContent.postTypes,{name:e.get("type")}),o=s.length&&s[0].supportsFeaturedImage;e.get("imageId")>0?this._data.thumbnail="good":"string"==typeof i&&i.length>0?this._data.thumbnail="good":"string"==typeof n&&n.length>0?this._data.thumbnail="improvable":o?this._data.thumbnail="bad":this._data.thumbnail=void 0,this.trigger("nc:change")},_checkAuthor:function(e){"administrator"===e.get("role")?this._data.author="improvable":this._data.author="good"},onSocialMessageListUpdate:function(e){"publish"!==this._postStatus&&(0===e.length?this._data.social="bad":1===e.length?this._data.social="improvable":this._data.social="good",this.trigger("nc:change"))},onTaskListUpdate:function(e){if("post"!==this._postType)return this._data.tag=void 0,void this.trigger("nc:change");var t=[];"function"==typeof e.where&&(t=e.where(function(e){return!e.get("completed")})),t.length>0?this._data.tasks="bad":this._data.tasks="good",this.trigger("nc:change")},onLinksChange:function(e){for(var t=0,i=0,n=NelioContent.blogUrl.toLowerCase(),s=/^[a-zA-Z]+:\/\//,o=0;o<e.length;++o){var a=e[o];if(0===a.toLowerCase().indexOf(n)?++i:s.test(a)?++t:++i,i>=2&&t>=2)break}0===i?this._data.internalLinks="bad":1===i?this._data.internalLinks="improvable":this._data.internalLinks="good",0===t?this._data.externalLinks="bad":1===t?this._data.externalLinks="improvable":this._data.externalLinks="good",this.trigger("nc:change")},onImageCountChange:function(e){e>0?this._data.imageCount="good":this._data.imageCount="improvable",this.trigger("nc:change")},onTextLengthChange:function(e){var t=NelioContent.postAnalysis.minPostLength;e<Math.floor(.6*t)?this._data.textLength="bad":e<Math.floor(.95*t)?this._data.textLength="improvable":this._data.textLength="good",this.trigger("nc:change")},onTagListUpdate:function(e){"undefined"!=typeof this._data.tag&&(e.length>0?this._data.tag="good":this._data.tag="bad",this.trigger("nc:change"))},onYoastSeoChange:function(e){NelioContent.postAnalysis.isYoastSeoIntegrated&&(this._data.yoastSeo=e,this.trigger("nc:change"))},onYoastContentChange:function(e){NelioContent.postAnalysis.isYoastSeoIntegrated&&(this._data.yoastContent=e,this.trigger("nc:change"))},_toggleDetailsVisibility:function(){this._areDetailsVisible=!this._areDetailsVisible,ncstore.set("nc-post-analysis-visible-details",this._areDetailsVisible),this.trigger("nc:render")},_updateSummary:function(){var e=_.filter(_.values(this._data),function(e){return"pending"===e}).length,t=(_.filter(_.values(this._data),function(e){return"good"===e}).length,_.filter(_.values(this._data),function(e){return"improvable"===e}).length),i=_.filter(_.values(this._data),function(e){return"bad"===e}).length;e>0?this._summary="pending":0===t+i?this._summary="awesome":0===i&&t<3?this._summary="good":1>=i?this._summary="improvable":this._summary="bad"},_discardPendingDetails:function(){clearTimeout(this._discardPendingTimeout),this._discardPendingTimeout=0,this._data=_.object(_.map(this._data,function(e,t){return"pending"===e?[t,"unknown"]:[t,e]})),this.trigger("nc:change")},close:function(){this._discardPendingTimeout>0&&(clearTimeout(this._discardPendingTimeout),this._discardPendingTimeout=0),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var u=new NelioContent.views.PostAnalysisView;if(e("#nelio-content-post-analysis-container").html(u.render().el),u.listenTo(l.collection,"reset",u.onSocialMessageListUpdate),u.listenTo(l.collection,"update",u.onSocialMessageListUpdate),u.onSocialMessageListUpdate(l.collection),NelioContent.helpers.isSubscribed()&&(u.listenTo(c.collection,"reset",u.onTaskListUpdate),u.listenTo(c.collection,"update",u.onTaskListUpdate),u.listenTo(c.collection,"nc:change:model",u.onTaskListUpdate),u.onTaskListUpdate(c.collection)),u.listenTo(t,"change",u.onPostChange),u.onPostChange(t),e("#tax-input-post_tag").on("change keyup",function(){var t=NelioContent.helpers.trim(e("#tax-input-post_tag").val());t=t.replace(", ","").split(""),u.onTagListUpdate(t)}),e("#tax-input-post_tag").trigger("change"),NelioContent.postAnalysis.isYoastSeoIntegrated){var m=function(){var t,i=e("#misc-publishing-actions .yoast-seo-score.keyword-score .image");t=i.hasClass("na")?"unknown":i.hasClass("bad")?"bad":i.hasClass("ok")?"improvable":"good",u.onYoastSeoChange(t)};NelioContent.helpers.addStyle("#misc-publishing-actions .yoast-seo-score.keyword-score { display:none!important; }"),e(window).on("YoastSEO:numericScore",m),m();var g=function(){var t,i=e("#misc-publishing-actions .yoast-seo-score.content-score .image");t=i.hasClass("na")?"unknown":i.hasClass("bad")?"improvable":i.hasClass("ok")?"improvable":"good",u.onYoastContentChange(t)};NelioContent.helpers.addStyle("#misc-publishing-actions .yoast-seo-score.content-score { display:none!important; }"),e(window).on("YoastSEO:numericScore",g),g()}u.onTextLengthChange(e("#wp-word-count .word-count").text()),e(document).on("nc:tinymce-editor",function(e,t){function s(){var e=t.getContent();i(e),n(e)}t.on("nodechange keyup",NelioContent.helpers.callAndDebounce(s,4e3,1500)),h.suggestedReferences.bind("add reset",NelioContent.helpers.callAndDebounce(function(){n(t.getContent())},4e3,1500))}),a&&e(document).trigger("nc:tinymce-editor",a),function(){function t(){var e=s.val();i(e),n(e)}var s=e("#content");s.on("nodechange keyup",NelioContent.helpers.callAndDebounce(t,4e3,1500)),h.suggestedReferences.bind("add reset",NelioContent.helpers.callAndDebounce(function(){n(s.val())},4e3,1500));try{QTags.addButton("nc-share-selection",NelioContent.i18n.actions.shareSelection,function(e,t){var i=NelioContent.helpers.getSelection(t);i=NelioContent.helpers.trim(i),0===i.length&&(i="{title}");var n=new NelioContent.models.SocialMessage;n.setPost(NCTinyMce.timelineView.collection.post),n.set("text",i+" {permalink}"),n.set("profileId",NelioContent.profiles.at(0).get("id"));var s=new NelioContent.views.SocialMessageEditor({model:n});Backbone.listenToOnce(s,"nc:add:messages",function(e){NCTinyMce.timelineView.collection.add(e)}),s.render()})}catch(o){}}(),s.on("change",_.debounce(function(){t.set("title",NelioContent.helpers.decodeHTMLEntities(s.val()))},2e3)),o.on("change",_.debounce(function(){t.set("excerpt",NelioContent.helpers.decodeHTMLEntities(o.val()))},2e3))}NelioContent.views.SocialTimeline=Backbone.View.extend({className:"nc-social-timeline",_overview:{$instance:void 0,sections:{$before:void 0,$day:void 0,$nextDay:void 0,$week:void 0,$month:void 0,$later:void 0},marks:{$start:void 0,$end:void 0},isFixed:!1,lastHighlightedBlock:"day",ignoreNextAutoHighlight:!1},_$blocks:{before:void 0,day:void 0,nextDay:void 0,week:void 0,month:void 0,later:void 0},_messageViews:{before:[],day:[],nextDay:[],week:[],month:[],later:[]},_socialMessageEditorView:void 0,_adminBarHeight:32,_$window:void 0,_$document:void 0,_templates:{normal:_.template(NelioContent.helpers.trim(document.getElementById("_nc-social-timeline").innerHTML)),noProfiles:_.template(NelioContent.helpers.trim(document.getElementById("_nc-no-profile-available").innerHTML)),autoDraft:_.template(NelioContent.helpers.trim(document.getElementById("_nc-no-social-timeline-on-auto-draft").innerHTML))},events:{"click .nc-timeline-overview .nc-section":"_gotoSection","click .button.nc-action.nc-new-social-message.nc-add-message":"_openSocialMessageEditorDialog","click .button.nc-action.nc-new-social-message.nc-upgrade":"_gotoAccountPage","click .nc-new-social-message.nc-first-message.nc-add-message":"_openSocialMessageEditorDialog","click .nc-new-social-message.nc-first-message.nc-upgrade":"_gotoAccountPage"},initialize:function(){this._$window=e(window),this._$document=e(document),this.collection=new NelioContent.collections.SocialTimeline,this._resetMessageViews(),this.render=_.bind(this.render,this),this._updateMessage=_.bind(this._updateMessage,this),this._addNewMessages=_.bind(this._addNewMessages,this),this.listenTo(this.collection,"add",this._addMessageView),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeMessageView),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetMessageViews),this.listenTo(this.collection,"reset",this.render),this._maybeFixOverview=_.bind(this._maybeFixOverview,this),this._onWindowResize=_.bind(this._onWindowResize,this),this._maybeHighlightADifferentBlockInOverview=_.bind(this._maybeHighlightADifferentBlockInOverview,this),this._$document.on("scroll",this._maybeFixOverview),this._$document.on("scroll",this._maybeHighlightADifferentBlockInOverview),this._$window.on("resize",this._onWindowResize),this._$window.on("resize",this._maybeHighlightADifferentBlockInOverview)},render:function(){if(0===NelioContent.profiles.length)return this.el.innerHTML=this._templates.noProfiles(),this;if("auto-draft"===this.collection.post.get("status"))return this.el.innerHTML=this._templates.autoDraft(),this;var e={dayStatus:this._getStatus("day"),nextDayStatus:this._getStatus("nextDay"),weekStatus:this._getStatus("week"),monthStatus:this._getStatus("month"),laterStatus:this._getStatus("later"),isPostPublished:this.collection.post.isPublished()},t=ncNewLocalMoment();if(this.collection.post.isPublished())e.dayFormattedDate=t.format(NelioContent.i18n.date["default"]),e.nextDayFormattedDate=t.add(1,"d").format(NelioContent.i18n.date["default"]),e.statistics=this.collection.post.get("statistics");else if(this.collection.post.isScheduled()){var i=this.collection.post.get("date").clone();e.dayFormattedDate=i.format(NelioContent.i18n.date["default"]),e.nextDayFormattedDate=i.add(1,"d").format(NelioContent.i18n.date["default"])}else e.dayFormattedDate="",e.nextDayFormattedDate="";if(!NelioContent.helpers.isSubscribed()){var n=this.collection,s=_.map(n.getDisabledProfileIds(),function(e){return n.get(e)});e.areMoreMessagesAllowed=s.length<NelioContent.profiles.length}return this.el.innerHTML=this._templates.normal(e),this._overview.$instance=this.$(".nc-timeline-overview"),this._overview.marks.$start=this.$("#timeline-start"),this._overview.marks.$end=this.$("#timeline-end"),this._overview.sections.$day=this.$(".nc-timeline-overview .nc-section.nc-day"),this._overview.sections.$nextDay=this.$(".nc-timeline-overview .nc-section.nc-next-day"),this._overview.sections.$week=this.$(".nc-timeline-overview .nc-section.nc-week"),this._overview.sections.$month=this.$(".nc-timeline-overview .nc-section.nc-month"),this._overview.sections.$later=this.$(".nc-timeline-overview .nc-section.nc-later"),this._overview.sections["$"+this._overview.lastHighlightedBlock].addClass("nc-active"),this._populateBlock("day"),this._populateBlock("nextDay"),this._populateBlock("week"),this._populateBlock("month"),this._populateBlock("later"),this._overview.isFixed=!1,this._maybeFixOverview(),this._maybeHighlightADifferentBlockInOverview(),NelioContent.helpers.makeInfoTooltip(this.$(".nc-help-with-html-tooltip")),this},_populateBlock:function(e){var t=e;"nextDay"===t&&(t="next-day");var i=this.$(".nc-timeline-section.nc-"+t+" .nc-social-messages"),n=this._messageViews[e];i.children().detach(),_.each(n,function(e){i.append(e.render().el)},this),this._$blocks[e]=i},_getStatus:function(e){return"undefined"!=typeof this._messageViews[e]?0===this._messageViews[e].length?"bad":this._messageViews[e].length<2?"improvable":"good":"bad"},_resetMessageViews:function(){function e(e){this.stopListening(e),this.stopListening(e.model),e.close()}_.each(this._messageViews.before,e,this),_.each(this._messageViews.day,e,this),_.each(this._messageViews.nextDay,e,this),_.each(this._messageViews.week,e,this),_.each(this._messageViews.month,e,this),_.each(this._messageViews.later,e,this),this._messageViews={before:[],day:[],nextDay:[],week:[],month:[],later:[]},this.collection.each(this._addMessageView,this)},_addMessageView:function(e){var t="none";if("publish"!==e.get("status")||this.collection.post.isPublished()){if("publish"===e.get("status")||this.collection.post.isPublished()||this.collection.post.isScheduled()){var i,n;this.collection.post.isPublished()?(i=ncNewLocalMoment(),n=i.clone().add(1,"d")):(i=this.collection.post.get("date").clone(),n=i.clone().add(1,"d"));var s=e.get("schedule"),o=s.diff(i,"day");i.isSame(s,"day")?t="day":n.isSame(s,"day")?t="nextDay":0<o&&o<=9?t="week":0<o&&o<=30?t="month":0<o&&(t="later")}else if("exact"===e.get("dateType"))t="later";else{var a=e.get("dateValue");if(a<=0)if("exact"!==e.get("timeType")){var l=e.get("timeValue");t=l<24?"day":l<48?"nextDay":l<216?"week":l<720?"month":"later"}else t="day";else t=a<=1?"nextDay":a<=9?"week":a<=30?"month":"later"}var r=this._extractView(e);if("none"===t)return void("undefined"!=typeof r&&r.close());"undefined"==typeof r&&(r=new NelioContent.views.SocialTimelineMessage({model:e}),this.listenTo(r,"nc:edit",this._openSocialMessageEditorDialog),this.listenTo(r.model,"change:dateValue",this._addMessageView),this.listenTo(r.model,"change:dateValue",this.render),this.listenTo(r.model,"change:timeValue",this._addMessageView),this.listenTo(r.model,"change:timeValue",this.render)),this._messageViews[t].push(r),this._messageViews[t].sort(function(e,t){var i=e.model.getDateForSorting(),n=t.model.getDateForSorting();return i+="twitter"===e.model.get("network")?"Atwitter":"B"+e.model.get("network"),n+="twitter"===t.model.get("network")?"Atwitter":"B"+t.model.get("network"),i+=e.model.get("profileId")+e.model.get("text"),n+=t.model.get("profileId")+t.model.get("text"),i<n?-1:i>n?1:0})}},_removeMessageView:function(e){var t=this._extractView(e);"undefined"!=typeof t&&(this.stopListening(t),this.stopListening(t.model),t.close())},_extractView:function(e){function t(t){return t.model===e}var i;return _.each(["before","day","nextDay","week","month","later"],function(e){if("undefined"==typeof i){var n=_.filter(this._messageViews[e],t);n.length>0&&(i=n[0],this._messageViews[e]=_.without(this._messageViews[e],i))}},this),i},_fixOverview:function(e){if("undefined"!=typeof this._overview.$instance&&(this._overview.$instance.css("top",e),!this._overview.isFixed)){var t=this._overview.$instance.width();this._overview.$instance.addClass("nc-fixed"),this._overview.$instance.css("left",this._overview.$instance.offset().left),this._overview.$instance.css("width",t),this._overview.isFixed=!0}},_unfixOverview:function(){this._overview.isFixed&&(this._overview.$instance.removeClass("nc-fixed"),this._overview.$instance.css("top",""),this._overview.$instance.css("left",""),this._overview.$instance.css("width",""),this._overview.isFixed=!1)},_maybeFixOverview:function(){if("undefined"!=typeof this._overview.$instance){var e=280,t=this._$window.scrollTop(),i=this._overview.marks.$start.offset().top-t,n=this._overview.marks.$end.offset().top-t;if(i<=this._adminBarHeight&&n>-100){var s=this._adminBarHeight;n<e&&(s-=e-n),this._fixOverview(s)}else this._unfixOverview()}},_onWindowResize:function(){this._unfixOverview(),this._maybeFixOverview(),this._maybeHighlightADifferentBlockInOverview()},_gotoSection:function(e){for(var t=e.target||e.srcElement,i=0;t.className.indexOf("section")===-1&&i<4;)t=t.parentNode;var n=this._overview.$instance.height()+this._adminBarHeight+75;this._overview.ignoreNextAutoHighlight=!0,t.className.indexOf("nc-later")!==-1?(this._$window.scrollTop(this._$blocks.later.offset().top-n),this._highlightBlockInOverview("later")):t.className.indexOf("nc-month")!==-1?(this._$window.scrollTop(this._$blocks.month.offset().top-n),this._highlightBlockInOverview("month")):t.className.indexOf("nc-week")!==-1?(this._$window.scrollTop(this._$blocks.week.offset().top-n),this._highlightBlockInOverview("week")):t.className.indexOf("nc-next-day")!==-1?(this._$window.scrollTop(this._$blocks.nextDay.offset().top-n),this._highlightBlockInOverview("nextDay")):(this._$window.scrollTop(this._$blocks.day.offset().top-n),this._highlightBlockInOverview("day"))},_gotoAccountPage:function(){document.location.href=NelioContent.pages.account},_maybeHighlightADifferentBlockInOverview:function(){if(this._overview.ignoreNextAutoHighlight)return void(this._overview.ignoreNextAutoHighlight=!1);if("undefined"!=typeof this._overview.$instance){var e=this._$window.scrollTop(),t=this._adminBarHeight+this._overview.$instance.height()+80,i=e+t;this._$blocks.later.offset().top<=i?this._highlightBlockInOverview("later"):this._$blocks.month.offset().top<=i?this._highlightBlockInOverview("month"):this._$blocks.week.offset().top<=i?this._highlightBlockInOverview("week"):this._$blocks.nextDay.offset().top<=i?this._highlightBlockInOverview("nextDay"):this._highlightBlockInOverview("day")}},_highlightBlockInOverview:function(e){this._overview.lastHighlightedBlock!==e&&(this._overview.sections.$later.removeClass("nc-active"),this._overview.sections.$month.removeClass("nc-active"),this._overview.sections.$week.removeClass("nc-active"),this._overview.sections.$nextDay.removeClass("nc-active"),this._overview.sections.$day.removeClass("nc-active"),this._overview.sections["$"+e].addClass("nc-active"),this._overview.lastHighlightedBlock=e)},_openSocialMessageEditorDialog:function(t,i){var n=new NelioContent.models.SocialMessage;if(n.setPost(this.collection.post),"undefined"==typeof i){var s=t.target||t.srcElement,o=e(s);switch(o.closest(".nc-information").find("h4").attr("name")){case"later":n.set("dateType","exact"),n.set("timeType","time-interval"),n.set("timeValue","morning");break;case"month":n.set("dateValue","28"),n.set("timeType","time-interval"),n.set("timeValue","morning");break;case"week":n.set("dateValue","7"),n.set("timeType","time-interval"),n.set("timeValue","morning");break;case"next-day":n.set("dateValue","1"),n.set("timeType","time-interval"),n.set("timeValue","morning")}n.set("profileId",NelioContent.profiles.at(0).get("id"))}else n.set(i.toJSON());this._socialMessageEditorView=new NelioContent.views.SocialMessageEditor({model:n}),this.listenTo(this._socialMessageEditorView,"nc:add:messages",this._addNewMessages),this.listenTo(this._socialMessageEditorView,"nc:update:message",this._updateMessage),this.listenTo(this._socialMessageEditorView,"nc:delete:message",this._deleteMessage),this.listenTo(this._socialMessageEditorView,"nc:close:dialog",this._onClosingMessageEditorView),this._socialMessageEditorView.disableProfiles(this.collection.getDisabledProfileIds()),this._socialMessageEditorView.render()},_addNewMessages:function(e){this.collection.add(e)},_updateMessage:function(e){"function"==typeof e.toJSON&&(e=e.toJSON());var t=this.collection.get(e.id);"undefined"!=typeof t&&t.set(e)},_deleteMessage:function(e){this.collection.remove(e)},_onClosingMessageEditorView:function(){this.stopListening(this._socialMessageEditorView),this._socialMessageEditorView.close(),this._socialMessageEditorView=void 0},close:function(){function e(e){this.stopListening(e),this.stopListening(e.model),e.close()}this._messageViews=[],_.each(this._messageViews.before,e,this),_.each(this._messageViews.day,e,this),_.each(this._messageViews.nextDay,e,this),_.each(this._messageViews.week,e,this),_.each(this._messageViews.month,e,this),_.each(this._messageViews.later,e,this),this._messageViews={before:[],day:[],nextDay:[],week:[],month:[],later:[]},this.stopListening(),this.unbind(),this._$document.off("scroll",this._maybeFixOverview),this._$document.off("scroll",this._maybeHighlightADifferentBlockInOverview),this._$window.off("resize",this._onWindowResize),this._$window.off("resize",this._maybeHighlightADifferentBlockInOverview),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SocialTimelineMessage=Backbone.View.extend({_deletionStatus:"none",template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-social-timeline-message").innerHTML)),events:{mouseleave:"_cancelMessageDeletion","click .nc-actions .nc-delete":"_askForMessageDeletionConfirmation","click .nc-actions .nc-cancel-deletion":"_cancelMessageDeletion","click .nc-actions .nc-do-delete":"_deleteMessage","click .nc-actions .nc-edit":"_editMessage","click .nc-actions .nc-share-now":"_shareNow"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON(),t=NelioContent.profiles.get(this.model.get("profileId")),i=_.findWhere(NelioContent.networkMetas,{id:this.model.get("network")});return e.networkAllowsMultiTargets=!1,"undefined"!=typeof i&&i.allowsMultiTargets&&(e.networkAllowsMultiTargets=!0,e.targetLabel=i.multiTargetLabels.targetLabel),"undefined"==typeof t&&(t=NelioContent.profiles.at(0)),e.photo=t.get("photo"),e.displayName=t.get("displayName"),e.firstLetter=t.get("firstLetter"),e.textFormatted=this.model.getHighlightedText(),e.dateFormatted=this._getDatetimeFormatted(),e.isAuthorMe=this.model.get("authorId")===NelioContent.users.current().get("id"),e.deletionStatus=this._deletionStatus,this.el.innerHTML=this.template(e),"deleting"===this._deletionStatus?this.$el.addClass("nc-deleting"):this.$el.removeClass("nc-deleting"),"image"===this.model.get("type")?this.$(".nc-social-timeline.nc-message").addClass("nc-has-image"):this.$(".nc-social-timeline.nc-message").removeClass("nc-has-image"),this},_askForMessageDeletionConfirmation:function(){this._deletionStatus="awaiting-confirmation",this.trigger("nc:render")},_cancelMessageDeletion:function(){"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render"))},_deleteMessage:function(e){this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy()},_editMessage:function(e){this.trigger("nc:edit",e,this.model)},_shareNow:function(){this.model.shareNow()},_getDatetimeFormatted:function(){var e=this._getDateFormatted(),t=this._getTimeFormatted();return e.length>0&&t.length>0?_.escape(e+" • "+t):_.escape(e+t)},_getDateFormatted:function(){if(this.model.post.isPublished()||this.model.post.isScheduled())return this.model.get("schedule").format(NelioContent.i18n.date["default"]);if("exact"===this.model.get("dateType"))return ncNewLocalMoment(this.model.get("dateValue")+" 12:00").format(NelioContent.i18n.date["default"]);var e=parseInt(this.model.get("dateValue"));return e>=3?NelioContent.i18n.daysAfterPublication.replace("{days}",e):""},_getTimeFormatted:function(){if(this.model.post.isPublished()||this.model.post.isScheduled())return this.model.get("schedule").format(NelioContent.i18n.time["default"]);if("exact"===this.model.get("timeType"))return this.model.get("timeValue");var e=parseInt(this.model.get("timeValue"));return 0===e?NelioContent.i18n.onPublication:1===e?NelioContent.i18n.oneHourAfterPublication:e>=2?NelioContent.i18n.hoursAfterPublication.replace("{hours}",e):""},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.helpers.isSubscribedTo("team-plan")&&(NelioContent.views.EditorialComment=Backbone.View.extend({_deletionStatus:"none",_autoRenderTimeout:0,_isBeingSaved:!1,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-editorial-comment").innerHTML)),events:{mouseleave:"_cancelCommentDeletion","click .nc-action.nc-delete":"_askForCommentDeletionConfirmation","click .nc-action.nc-cancel-deletion":"_cancelCommentDeletion","click .nc-action.nc-do-delete":"_deleteComment"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render);var e=NelioContent.users.getUser(this.model.get("authorId"));e.isLoading()&&this.listenToOnce(e,"nc:load",_.bind(function(){this.trigger("nc:render")},this))},render:function(){var e=this.model.toJSON();e.deletionStatus=this._deletionStatus,e.isBeingSaved=this._isBeingSaved,e.dateFormatted=this._prepareDate(),ncNewLocalMoment().diff(this.model.get("date"),"m")<15?e.canBeDeleted=!0:e.canBeDeleted=!1;var t=NelioContent.users.getUser(this.model.get("authorId"));return e.isAuthorMe=t.get("id")===NelioContent.users.current().get("id"),e.photo=t.get("photo"),e.displayName=t.get("name"),e.firstLetter=t.get("firstLetter"),this.el.innerHTML=this.template(e),this},setIsBeingSaved:function(e){this._isBeingSaved=e,this.trigger("nc:render")},_prepareDate:function(){this._clearAutoRenderTimeout();var e,t=ncNewLocalMoment(),i=t.clone().add(-1,"d"),n=this.model.get("date");if(t.diff(n,"d")>2)e=n.format(NelioContent.i18n.date["default"]);else if(n.isSame(i,"day"))e=n.format(NelioContent.i18n.date.lastDay)+", "+n.format(NelioContent.i18n.time["default"]),this._autoRenderTimeout=setTimeout(this.render,9e5);else if(n.isSame(t,"day")){e=Math.abs(n.diff(t,"h"))>3?n.format(NelioContent.i18n.time["default"]):t.diff(n,"s")<30?n.format(NelioContent.i18n.time.now):NelioContent.helpers.capitalizeFirstLetter(n.fromNow());var s=Math.abs(t.diff(n,"m"));s<1?this._autoRenderTimeout=setTimeout(this.render,2e4):s<5?this._autoRenderTimeout=setTimeout(this.render,6e4):this._autoRenderTimeout=setTimeout(this.render,9e5)}else e=n.format(NelioContent.i18n.date["default"]);return e},_askForCommentDeletionConfirmation:function(){this._deletionStatus="awaiting-confirmation",this.trigger("nc:render")},_cancelCommentDeletion:function(){"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render"))},_deleteComment:function(e){this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy()},_clearAutoRenderTimeout:function(){this._autoRenderTimeout>0&&(clearTimeout(this._autoRenderTimeout),this._autoRenderTimeout=0)},close:function(){this._clearAutoRenderTimeout(),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialComments=Backbone.View.extend({_commentViews:[],_rendered:!1,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-editorial-comments").innerHTML)),events:{"keypress textarea":"_maybeAddComment"},initialize:function(){"undefined"==typeof this.collection&&(this.collection=new NelioContent.collections.EditorialComments),this.collection.each(function(e){var t=new NelioContent.views.EditorialComment({model:e});this._commentViews.push(t)},this),this.render=_.bind(this.render,this),this.listenTo(this.collection,"add",this._addEditorialComment),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeEditorialComment),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetCommentViews),this.listenTo(this.collection,"reset",this.render)},render:function(){this._rendered||(this.el.innerHTML=this.template(),this._rendered=!0);var e=this.$(".nc-editorial-comments");return e.children().detach(),_.each(this._commentViews,function(t){e.append(t.render().el)},this),e[0].scrollTop=e[0].scrollHeight,this},addComment:function(e){var t=new NelioContent.views.EditorialComment({model:e});t.setIsBeingSaved(!0),this._commentViews.push(t),this.stopListening(this.collection,"add",this._addEditorialComment),this.collection.add(e),this.listenTo(this.collection,"add",this._addEditorialComment),e.save(void 0,{success:function(i,n){e.set(n),t.setIsBeingSaved(!1)}})},_resetCommentViews:function(){_.each(this._commentViews,function(e){e.close()},this),this._commentViews=[],this.collection.each(this._addEditorialComment,this)},_addEditorialComment:function(e){var t=new NelioContent.views.EditorialComment({model:e});this._commentViews.push(t)},_removeEditorialComment:function(e){var t=_.filter(this._commentViews,function(t){return t.model===e},this);if(t.length>0){var i=t[0];this._commentViews=_.without(this._commentViews,i),this.stopListening(i),i.close()}},_maybeAddComment:function(e){if(13===e.keyCode&&!e.shiftKey){var t=this.$("textarea"),i=NelioContent.helpers.trim(t.val());if(t.val(""),0===i.length)return!1;var n=new NelioContent.models.EditorialComment({comment:i
});return this.addComment(n),!1}},close:function(){_.each(this._commentViews,function(e){e.close()},this),this._commentViews=[],this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}})),NelioContent.helpers.isSubscribed()&&(NelioContent.views.EditorialTask=Backbone.View.extend({_deletionStatus:"none",_isBeingSaved:!1,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-editorial-task").innerHTML)),events:{mouseleave:"_cancelTaskDeletion","click .nc-actions .nc-delete":"_askForTaskDeletionConfirmation","click .nc-actions .nc-cancel-deletion":"_cancelTaskDeletion","click .nc-actions .nc-do-delete":"_deleteTask","click input[type=checkbox]:not( .disabled )":"_toggleCompletion"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:completed",this.render);var e=NelioContent.users.getUser(this.model.get("assigneeId"));e.isLoading()&&this.listenToOnce(e,"nc:load",_.bind(function(){this.trigger("nc:render")},this))},render:function(){var e=this.model.toJSON();return e.deletionStatus=this._deletionStatus,e.isBeingSaved=this._isBeingSaved,e.isAssignerMe=this.model.get("assignerId")===NelioContent.users.current().get("id"),e.isAssigneeMe=this.model.get("assigneeId")===NelioContent.users.current().get("id"),e.assigneeName=NelioContent.users.getUser(this.model.get("assigneeId")).get("name"),e.isOverdue=!1,e.dateFormatted=this._getDateFormatted(),this.isBeingSaved||(this.model.post.isPublished()||this.model.post.isScheduled())&&(e.isOverdue=this.model.get("dateDue").isBefore(ncNewLocalMoment())),this.el.innerHTML=this.template(e),this},setIsBeingSaved:function(e){this._isBeingSaved=e,this.trigger("nc:render")},_askForTaskDeletionConfirmation:function(){this._deletionStatus="awaiting-confirmation",this.trigger("nc:render")},_cancelTaskDeletion:function(){"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render"))},_deleteTask:function(e){this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy()},_toggleCompletion:function(){var e=!this.model.get("completed");this.model.set("completed",e),this._isBeingSaved=!0,this.trigger("nc:render");var t=this;this.model.save(void 0,{success:function(e,i){t.model.set("completed",i.completed),t.setIsBeingSaved(!1),t.trigger("nc:render")}})},_getDateFormatted:function(){if(this.model.post.isPublished()||this.model.post.isScheduled())return this.model.get("dateDue").calendar();var e;switch(this.model.get("dateType")){case"exact":return this.model.get("dateDue").calendar();case"predefined-offset":e=parseInt(this.model.get("dateValue"));break;case"negative-days":e=-parseInt(this.model.get("dateValue"));break;default:e=parseInt(this.model.get("dateValue"))}return e<0?NelioContent.i18n.daysBeforePublication.replace("{days}",-e):0===e?NelioContent.i18n.publicationDay:NelioContent.i18n.daysAfterPublication.replace("{days}",e)},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialTasks=Backbone.View.extend({_taskViews:[],_newTaskView:!1,_rendered:!1,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-editorial-tasks").innerHTML)),events:{"click .nc-new-task-form-opener input":"_openNewTaskForm"},initialize:function(){"undefined"==typeof this.collection&&(this.collection=new NelioContent.collections.EditorialTasks),this.collection.each(function(e){var t=new NelioContent.views.EditorialTask({model:e});this._taskViews.push(t)},this),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.collection,"add",this._addEditorialTask),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeEditorialTask),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetTaskViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"change:completed",this.render),this.listenTo(this,"nc:open:newTaskForm",this.render),this.listenTo(this,"nc:close:newTaskForm",this.render)},render:function(){if(0===this.collection.length&&(this._rendered=!1),!this._rendered){var e={taskCount:this.collection.length};this.el.innerHTML=this.template(e),this._rendered=0!==this.collection.length}var t=this.collection.where({completed:!0}),i=Math.round(100*t.length/this.collection.length),n=this.$(".nc-task-list-progress .nc-bar");100==i?n.addClass("nc-completed"):n.removeClass("nc-completed"),n.css("width",i+"%"),this.$(".nc-task-list-progress .nc-percentage").text(i+"%");var s=this.$(".nc-tasks");return s.children().detach(),_.each(this._taskViews,function(e){s.append(e.render().el)},this),this._newTaskView?(this.$(".nc-new-task-form-opener").hide(),this.$(".nc-new-task-form-container").append(this._newTaskView.render().el)):this.$(".nc-new-task-form-opener").show(),this},addEditorialTask:function(e){this._closeNewTaskForm();var t=new NelioContent.views.EditorialTask({model:e});t.setIsBeingSaved(!0),this._taskViews.push(t),this.stopListening(this.collection,"add",this._addEditorialTask),this.collection.add(e),this.listenTo(this.collection,"add",this._addEditorialTask);var i=this;e.save(void 0,{success:function(n,s){e.set(s),t.setIsBeingSaved(!1),i.trigger("nc:render")}})},_resetTaskViews:function(){_.each(this._taskViews,function(e){e.close()},this),this._taskViews=[],this.collection.each(this._addEditorialTask,this),this._sortEditorialTasks()},_addEditorialTask:function(e){var t=new NelioContent.views.EditorialTask({model:e});e.setPost(this.collection.post),this._taskViews.push(t)},_sortEditorialTasks:function(e){this._taskViews.sort(function(e,t){var i=e.model.getDateForSorting()+e.model.get("task"),n=t.model.getDateForSorting()+t.model.get("task");return i<n?-1:i>n?1:0})},_removeEditorialTask:function(e){var t=_.filter(this._taskViews,function(t){return t.model===e},this);if(t.length>0){var i=t[0];this._taskViews=_.without(this._taskViews,i),i.close()}},_openNewTaskForm:function(){this._newTaskView=new NelioContent.views.NewEditorialTask,this._newTaskView.model.setPost(this.collection.post),this.listenTo(this._newTaskView,"nc:create:task",this.addEditorialTask),this.listenTo(this._newTaskView,"nc:cancel",this._closeNewTaskForm),this.trigger("nc:open:newTaskForm")},_closeNewTaskForm:function(){this._newTaskView&&(this.stopListening(this._newTaskView),this._newTaskView.close(),this._newTaskView=!1,this.trigger("nc:close:newTaskForm"))},close:function(){_.each(this._taskViews,function(e){e.close()},this),this._taskViews=[],"function"==typeof this._newTaskView.close&&(this._newTaskView.close(),this._newTaskView=void 0),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.NewEditorialTask=Backbone.View.extend({_assigneeView:void 0,_dueDateView:void 0,_$saveButton:void 0,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-new-editorial-task").innerHTML)),events:{"keyup textarea":"_updateTask","change textarea":"_updateTask","click .nc-cancel":"_cancel","click .nc-add-task:not( .button-disabled )":"_addTask"},initialize:function(){this.model=new NelioContent.models.EditorialTask,NelioContent.helpers.isSubscribedTo("team-plan")?this._assigneeView=new NelioContent.views.UserSelector({defaultValue:this.model.get("assigneeId")}):this._assigneeView=new NelioContent.views.UserSelector({single:!0,defaultValue:this.model.get("assigneeId")}),this._dueDateView=new NelioContent.views.DateSelector({model:this.model}),this.render=_.bind(this.render,this),this.listenTo(this.model,"change:task",this._maybeEnableAddButton),this.listenTo(this.model,"change:dateType",this._maybeEnableAddButton),this.listenTo(this.model,"change:dateValue",this._maybeEnableAddButton)},render:function(){"undefined"!=typeof this._$saveButton&&this._$saveButton.tooltip("destroy");var e=this.model.toJSON();return this.el.innerHTML=this.template(e),this.$(".nc-assignee").html(this._assigneeView.render().el),this.$(".nc-date").html(this._dueDateView.render().el),this._$saveButton=this.$(".nc-add-task"),NelioContent.helpers.makeWarningTooltip(this._$saveButton),this},_cancel:function(){this.trigger("nc:cancel")},_addTask:function(){this.model.set({task:this.$("textarea").val(),assignerId:NelioContent.users.current().get("id"),assigneeId:parseInt(NelioContent.helpers.trim(this.$(".nc-assignee select").val()))}),this.trigger("nc:create:task",this.model)},_updateTask:function(e){this.model.set("task",NelioContent.helpers.trim(this.$("textarea").val())),13!==e.keyCode||this.model.isSomethingMissing()||this._addTask()},_maybeEnableAddButton:function(){this._$saveButton.tooltip("close");var e=this.model.isSomethingMissing();e?(this._$saveButton.addClass("button-disabled"),this._$saveButton.attr("title",_.escape(e))):(this._$saveButton.removeClass("button-disabled"),this._$saveButton.attr("title",""))},close:function(){this._assigneeView.close(),this._dueDateView.close(),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}})),NelioContent.views.Reference=Backbone.View.extend({_awaitingDiscardConfirmation:!1,_referenceEditor:void 0,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-reference").innerHTML)),events:{mouseleave:"_cancelDiscard","click .nc-actions .nc-edit":"_editReference","click .nc-actions .nc-discard":"_askForDiscardConfirmation","click .nc-actions .nc-cancel-discard":"_cancelDiscard","click .nc-actions .nc-do-discard":"_discard"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON();e.awaitingDiscardConfirmation=this._awaitingDiscardConfirmation;var t=this.model.get("suggestionAdvisorId");return e.wasSuggestedByMe=t===NelioContent.users.current().get("id"),e.wasSuggestedByNelio=0===NelioContent.users.current().get("id"),this.el.innerHTML=this.template(e),this},_editReference:function(){var e=new NelioContent.models.Reference(this.model.toJSON());this._referenceEditor=new NelioContent.views.ReferenceEditor({model:e}),this.listenTo(this._referenceEditor,"nc:update:reference",this._updateReference),this.listenTo(this._referenceEditor,"nc:close:dialog",this._closeDialog),this.trigger("nc:open:editorDialog"),this._referenceEditor.openDialog()},_updateReference:function(e){this.model.set(e)},_closeDialog:function(){this._referenceEditor.close(),this._referenceEditor=void 0,this.trigger("nc:close:editorDialog")},_askForDiscardConfirmation:function(){this._awaitingDiscardConfirmation=!0,this.trigger("nc:render")},_cancelDiscard:function(){this._awaitingDiscardConfirmation=!1,this.trigger("nc:render")},_discard:function(){this._awaitingDiscardConfirmation=!1,this.model.trigger("nc:discard",this.model)},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.ReferenceEditor=Backbone.View.extend({_$saveButton:void 0,template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-reference-editor").innerHTML)),events:{"change input.nc-title":"_updateTitle","keyup input.nc-title":"_updateTitle","change input.nc-url":"_updateUrl","keyup input.nc-url":"_updateUrl","change input.nc-author":"_updateAuthor","keyup input.nc-author":"_updateAuthor","change input.nc-email":"_updateEmail","keyup input.nc-email":"_updateEmail","change input.nc-twitter":"_updateTwitter","keyup input.nc-twitter":"_updateTwitter"},initialize:function(){this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:url",this._maybeEnableSaveButton),this.listenTo(this.model,"change:twitter",this._maybeEnableSaveButton),this.listenTo(this.model,"change:email",this._maybeEnableSaveButton)},render:function(){var e=this.model.toJSON();return e.authorEscaped=_.escape(e.author),this.el.innerHTML=this.template(e),this},openDialog:function(){var e=[];this.model.get("isExternal")?e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)):e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.close)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.save));var t=this;this.$el.dialog({title:NelioContent.i18n.titles.editReference,buttons:e,modal:!0,width:Math.min(600,NelioContent.helpers.getWindowWidth()-20),dialogClass:"nc-dialog",open:function(){t.listenTo(t,"nc:click:dialog:save",t._onDialogSave),t.listenTo(t,"nc:click:dialog:cancel",t._onDialogCancel),t._$saveButton=t.$el.parent().find(".button-primary"),NelioContent.helpers.makeWarningTooltip(t._$saveButton)},close:function(){t.stopListening(t,"nc:click:dialog:save",t._onDialogSave),t.stopListening(t,"nc:click:dialog:cancel",t._onDialogCancel),t._$saveButton.tooltip("destroy"),t.$el.dialog("destroy"),t.trigger("nc:close:dialog")}}),this.trigger("nc:render")},_updateTitle:function(){var e=this.$("input.nc-title").val();this.model.set("title",NelioContent.helpers.trim(e))},_updateUrl:function(){var e=this.$("input.nc-url").val();this.model.set("url",NelioContent.helpers.trim(e))},_updateAuthor:function(){var e=this.$("input.nc-author").val();this.model.set("author",NelioContent.helpers.trim(e))},_updateEmail:function(){var e=this.$("input.nc-email").val();this.model.set("email",NelioContent.helpers.trim(e))},_updateTwitter:function(){var e=this.$("input.nc-twitter").val();this.model.set("twitter",NelioContent.helpers.trim(e))},_lock:function(){this.$("input").attr("disabled","disabled")},_unlock:function(){this.model.get("isExternal")&&this.$("input").removeAttr("disabled")},_maybeEnableSaveButton:function(){this._$saveButton.tooltip("close");var e=this.model.isSomethingMissing();e?(this._$saveButton.addClass("button-disabled"),this._$saveButton.attr("title",_.escape(e))):(this._$saveButton.removeClass("button-disabled"),this._$saveButton.attr("title",""))},_onDialogSave:function(){if(!this.model.isSomethingMissing()){var t=this.$el.parent(),i=t.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .button-primary )"),n=t.find(".ui-dialog-buttonpane button.button-primary");this._lock(),this.$el.dialog("option","closeOnEscape",!1),i.prop("disabled",!0),n.prop("disabled",!0),n.html(NelioContent.i18n.feedback.saving);var s=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_update_reference",reference:s.model.get("postId"),title:s.model.get("title"),url:s.model.get("url"),author:s.model.get("author"),email:s.model.get("email"),twitter:s.model.get("twitter")},success:function(e){e?(s.trigger("nc:update:reference",e),s.$el.dialog("close")):this.error()},error:function(e){NelioContent.helpers.openErrorDialog(e.responseJSON),n.html(NelioContent.i18n.actions.save),i.prop("disabled",!1),n.prop("disabled",!1),s.$el.dialog("option","closeOnEscape",!0),s._unlock()}})}},_onDialogCancel:function(){this.$el.dialog("close")},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.References=Backbone.View.extend({_urlMatcher:/^https?:\/\/([\da-z\.-]+)\.([a-z]{2,6})(\/[^\/\s]+)*\/?$/i,_referenceViews:[],events:{"keypress input[type=url]":"_doNotPropagateEnter","keyup input[type=url]":"_onUrlChange","change input[type=url]":"_onUrlChange","click .nc-actions .button:not( .button-disabled )":"_addReference"},initialize:function(e){"undefined"==typeof this.collection&&(this.collection=new NelioContent.collections.References),this._resetReferenceViews(),this.template=e.template,this.render=_.bind(this.render,this),this.listenTo(this.collection,"add",this._resetReferenceViews),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._resetReferenceViews),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetReferenceViews),this.listenTo(this.collection,"reset",this.render)},render:function(){try{this.$(".nc-actions .button").tooltip("destroy")}catch(e){}var t={amITheAuthor:this.collection.post.get("author")===NelioContent.users.current().get("id")};if(this.el.innerHTML=this.template(t),this._referenceViews.length>0){var i=this.$(".nc-list");i.empty(),_.each(this._referenceViews,function(e){i.append(e.render().el)},this)}return NelioContent.helpers.makeWarningTooltip(this.$(".nc-actions .button")),this._maybeEnableAddButton(),this},_resetReferenceViews:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.collection.each(function(e){var t=new NelioContent.views.Reference({model:e});this._referenceViews.push(t)},this)},_doNotPropagateEnter:function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation())},_onUrlChange:function(e){if(this._maybeEnableAddButton()){var t=e.target||e.srcElement;this.$(t);13===e.keyCode&&this._addReference()}},_maybeEnableAddButton:function(){var e=this.$(".nc-actions .button"),t=this.$(".nc-reference-url input");return 0===NelioContent.helpers.trim(t.val()).length?(e.addClass("button-disabled"),e.attr("title",NelioContent.i18n.errors.reference.noUrl),!1):this._urlMatcher.test(NelioContent.helpers.trim(t.val()))?(e.removeClass("button-disabled"),e.attr("title",""),!0):(e.addClass("button-disabled"),e.attr("title",NelioContent.i18n.errors.reference.invalidUrl),!1)},_addReference:function(){var e=this.$("input[type=url]"),t=e.val();e.val(""),this.collection.suggestReference({id:t,url:t,urlEscaped:_.escape(t)})},close:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.Links=Backbone.View.extend({_rendered:!1,_views:{brokenLinks:void 0,suggestedReferences:void 0},brokenLinks:void 0,suggestedReferences:void 0,events:{},initialize:function(e){"undefined"==typeof e&&(e={}),this.brokenLinks=e.brokenLinks,this.suggestedReferences=e.suggestedReferences,this._views.brokenLinks=new NelioContent.views.BrokenLinks({collection:this.brokenLinks}),this._views.suggestedReferences=new NelioContent.views.References({template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-suggested-references").innerHTML)),collection:this.suggestedReferences})},render:function(){return this._rendered||(this.$el.append(this._views.brokenLinks.render().el),this.$el.append(this._views.suggestedReferences.render().el),this._rendered=!0),0===this.brokenLinks.length?this._views.brokenLinks.$el.css("display","none"):this._views.brokenLinks.$el.css("display","block"),this},close:function(){_.each(this._views,function(e){e.close()},this),this._views={},this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.BrokenLink=Backbone.View.extend({template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-broken-link").innerHTML)),events:{},initialize:function(){this.render=_.bind(this.render,this)},render:function(){return this.el.innerHTML=this.template(this.model.toJSON()),this},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.BrokenLinks=Backbone.View.extend({template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-broken-links").innerHTML)),events:{},initialize:function(){},render:function(){return this.el.innerHTML=this.template(),this},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.MetaBoxError=Backbone.View.extend({template:_.template(NelioContent.helpers.trim(document.getElementById("_nc-meta-box-error").innerHTML)),initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON();return this.el.innerHTML=this.template(e),this},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var n,s=e("#title"),o=e("#excerpt"),a=!1;e(document).on("tinymce-editor-init",function(t,i){a=i,e(document).trigger("nc:tinymce-editor",a)}),e.ajax({url:ajaxurl,data:{action:"nelio_content_get_post",post:e("#post_ID").val()},success:function(e){n=new NelioContent.models.Post(e)},error:function(){n=new NelioContent.models.Post({id:parseInt(e("#post_ID").val()),title:NelioContent.helpers.decodeHTMLEntities(s.val()),excerpt:NelioContent.helpers.decodeHTMLEntities(o.text()),permalink:e("#sample-permalink a").attr("href"),author:e("#post_author").val(),status:"auto-draft"})},complete:function(){n.set("imageId",parseInt(e("#nc-feat-image-thumbnail-id").val())),n.set("image",e("#nc-feat-image-url").val()),n.set("autoImage",e("#nc-feat-image-auto-url").val()),t(n),i(n)}});var l,r,c;l=new NelioContent.views.SocialTimeline,window.NCTinyMce=window.NCTinyMce||{},NCTinyMce.timelineView=l,NelioContent.helpers.isSubscribed()&&(c=new NelioContent.views.EditorialTasks),NelioContent.helpers.isSubscribedTo("team-plan")&&(r=new NelioContent.views.EditorialComments)}(jQuery);